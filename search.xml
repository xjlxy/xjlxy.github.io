<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>kubeedge</title>
      <link href="/2019/06/19/kubeedge/"/>
      <url>/2019/06/19/kubeedge/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul><li>KubeEdge是一个开源系统，用于将容器化应用程序编排功能扩展到Edge的主机。它基于kubernetes构建，并为网络应用程序提供基础架构支持。云和边缘之间的部署和元数据同步。 KubeEdge使用Apache 2.0许可。并且绝对可以免费用于个人或商业用途。我们欢迎贡献者！</li><li>目标是创建一个开放平台，使能边缘计算，将容器化应用编排功能扩展到边缘的节点和设备，后者基于kubernetes构建，并为云和边缘之间的网络，应用部署和元数据同步提供基础架构支持。</li><li>Doc: <a href="https://docs.kubeedge.io" target="_blank" rel="external">https://docs.kubeedge.io</a></li></ul><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>先决条件</p><ul><li>docker</li><li>Kubernetes</li></ul><p>修改 controller.yaml 文件，使KubeEdge通过https方式与Kubernetes apiserver连接<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">controller:</div><div class="line">  kube:</div><div class="line">    master: https://localhost:6443</div><div class="line">    namespace: &quot;&quot;</div><div class="line">    content_type: &quot;application/vnd.kubernetes.protobuf&quot;</div><div class="line">    qps: 5</div><div class="line">    burst: 10</div><div class="line">    node_update_frequency: 10</div><div class="line">    kubeconfig: &quot;/etc/kubernetes/admin.conf&quot;   #Enter path to kubeconfig file to enable https connection to k8s apiserver</div><div class="line">cloudhub:</div><div class="line">  protocol_websocket: true # enable websocket protocol</div><div class="line">  port: 10000 # open port for websocket server</div><div class="line">  protocol_quic: true # enable quic protocol</div><div class="line">  quic_port: 10001 # open prot for quic server</div><div class="line">  max_incomingstreams: 10000 # the max incoming stream for quic server</div><div class="line">  address: 0.0.0.0</div><div class="line">  ca: /etc/kubeedge/ca/rootCA.crt</div><div class="line">  cert: /etc/kubeedge/certs/edge.crt</div><div class="line">  key: /etc/kubeedge/certs/edge.key</div><div class="line">  keepalive-interval: 30</div><div class="line">  write-timeout: 30</div><div class="line">  node-limit: 10</div><div class="line">devicecontroller:</div><div class="line">  kube:</div><div class="line">    master: https://localhost:6443</div><div class="line">    namespace: &quot;&quot;</div><div class="line">    content_type: &quot;application/vnd.kubernetes.protobuf&quot;</div><div class="line">    qps: 5</div><div class="line">    burst: 10</div><div class="line">    kubeconfig: &quot;/etc/kubernetes/admin.conf&quot;</div></pre></td></tr></table></figure></p><p>获取二进制包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">VERSION=&quot;v0.3.0&quot;</div><div class="line">OS=&quot;linux&quot;</div><div class="line">ARCH=&quot;amd64&quot;</div><div class="line">curl -L &quot;https://github.com/kubeedge/kubeedge/releases/download/$&#123;VERSION&#125;/kubeedge-$&#123;VERSION&#125;-$&#123;OS&#125;-$&#123;ARCH&#125;.tar.gz&quot; \</div><div class="line">  --output kubeedge-$&#123;VERSION&#125;-$&#123;OS&#125;-$&#123;ARCH&#125;.tar.gz \</div><div class="line">  &amp;&amp; tar -xf kubeedge-$&#123;VERSION&#125;-$&#123;OS&#125;-$&#123;ARCH&#125;.tar.gz  -C /opt</div></pre></td></tr></table></figure></p><p>创建证书<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget -L https://github.com/kubeedge/kubeedge/raw/master/build/tools/certgen.sh</div><div class="line">bash ./certgen.sh genCertAndKey edge</div><div class="line">证书和密钥会分别自动生成在/etc/kubeedge/ca 和 /etc/kubeedge/certs 目录下，同时该证书需要传到边缘设备。</div></pre></td></tr></table></figure></p><p><img src="/2019/06/19/kubeedge/0.png" alt=""></p><p>创建 device model 和 device CRDs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget -L https://github.com/kubeedge/kubeedge/raw/master/build/crds/devices/devices_v1alpha1_devicemodel.yaml</div><div class="line">kubectl create -f devices_v1alpha1_devicemodel.yaml</div><div class="line"></div><div class="line">wget -L https://github.com/kubeedge/kubeedge/raw/master/build/crds/devices/devices_v1alpha1_device.yaml</div><div class="line">kubectl create -f devices_v1alpha1_device.yaml</div></pre></td></tr></table></figure></p><p>运行Cloud<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /opt/kubeedge/</div><div class="line">nohup ./cloud/edgecontroller &gt; edgecontroller.log 2&gt;&amp;1 &amp;</div></pre></td></tr></table></figure></p><p>部署边缘设备<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># Deploy node</div><div class="line"> wget -L https://github.com/kubeedge/kubeedge/raw/master/build/node.json</div><div class="line"> #Modify the node.json` file and change `metadata.name` to the name of the edge node </div><div class="line"> kubectl apply -f node.json</div></pre></td></tr></table></figure></p><p>部署 Edge node<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># MQTT</div><div class="line">  apt install -y mosquitto</div><div class="line">  mosquitto -d -p 1883</div><div class="line"></div><div class="line">  nohup ./edge/edge_core &gt; edge_core.log 2&gt;&amp;1 &amp;</div></pre></td></tr></table></figure></p><p>检查状态<br><img src="/2019/06/19/kubeedge/1.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kubernetes secret</title>
      <link href="/2019/06/11/kubernetes-secret/"/>
      <url>/2019/06/11/kubernetes-secret/</url>
      
        <content type="html"><![CDATA[<h2 id="ssl"><a href="#ssl" class="headerlink" title="ssl"></a>ssl</h2><p>openssl genrsa -out nginx-https.key 2048<br>openssl req -new -x509 -days 3650 -key nginx-https.key -out nginx-https.cert -subj /CN=www.xy.com</p><h2 id="configmap"><a href="#configmap" class="headerlink" title="configmap"></a>configmap</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">listen 443 ssl;</div><div class="line">ssl_certificate certs/nginx-https.cert;</div><div class="line">ssl_certificate_key certs/nginx-https.key;</div><div class="line">ssl_session_cache shared:SSL:1m;</div><div class="line">ssl_session_timeout 5m;</div><div class="line">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">ssl_ciphers HIGH:!aNULL:!MD5;</div><div class="line">ssl_prefer_server_ciphers on;</div></pre></td></tr></table></figure><h2 id="secret"><a href="#secret" class="headerlink" title="secret"></a>secret</h2><p>kubectl create secret generic nginx-https –from-file=nginx-https.cert –from-file=nginx-https.key</p><h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><p>kubectl port-forward nginx-configmap-ssl 8443:443 &amp;<br>curl <a href="https://localhost:8443" target="_blank" rel="external">https://localhost:8443</a> -k -v<br><img src="/2019/06/11/kubernetes-secret/0.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kubernetes Ingress</title>
      <link href="/2019/06/06/kubernetes-Ingress/"/>
      <url>/2019/06/06/kubernetes-Ingress/</url>
      
        <content type="html"><![CDATA[<h2 id="node-label"><a href="#node-label" class="headerlink" title="node label"></a>node label</h2><p>kubectl label nodes k8s-node1 custom/ingress-controller-ready=true</p><p>kubectl get nodes -L custom/ingress-controller-ready</p><h2 id="ingress-controller-ingress-nginx"><a href="#ingress-controller-ingress-nginx" class="headerlink" title="ingress controller: ingress-nginx"></a>ingress controller: ingress-nginx</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">修改：</div><div class="line">kind: DaemonSet：考虑防止单点故障，改为DaemonSet然后删掉replicate </div><div class="line">hostNetwork: true：添加该字段，暴露nginx-ingress-controller pod的服务端口（80）</div><div class="line">nodeSelector: 增加亲和性部署，有custom/ingress-controller-ready 标签的节点才会部署该DaemonSet</div><div class="line"></div><div class="line"># https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/mandatory.yaml</div><div class="line">kubectl apply -f mandatory.yaml</div></pre></td></tr></table></figure><h2 id="Bare-metal"><a href="#Bare-metal" class="headerlink" title="Bare-metal"></a>Bare-metal</h2><p>Using NodePort:</p><p>kubectl apply -f <a href="https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/baremetal/service-nodeport.yaml" target="_blank" rel="external">https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/baremetal/service-nodeport.yaml</a></p><p>kubectl get pods –namespace=ingress-nginx –watch -o wide<br><img src="/2019/06/06/kubernetes-Ingress/1.png" alt=""></p><p>kubectl get svc -n ingress-nginx<br><img src="/2019/06/06/kubernetes-Ingress/0.png" alt=""></p><h2 id="node1"><a href="#node1" class="headerlink" title="node1"></a>node1</h2><p>ss -tulnp |egrep ‘80|443’</p><h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: my-nginx</div><div class="line">spec:</div><div class="line">  replicas: 2</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        run: my-nginx</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: my-nginx</div><div class="line">        image: nginx:1.7.9</div><div class="line">        ports:</div><div class="line">        - containerPort: 80</div><div class="line"></div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: my-nginx</div><div class="line">  labels:</div><div class="line">    run: my-nginx</div><div class="line">spec:</div><div class="line">  type: NodePort</div><div class="line">  ports:</div><div class="line">  - port: 80</div><div class="line">    targetPort: 80</div><div class="line">    nodePort: 30003</div><div class="line">  selector:</div><div class="line">    run: my-nginx</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: my-apache</div><div class="line">spec:</div><div class="line">  replicas: 2</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        run: my-apache</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: my-apache</div><div class="line">        image: httpd:2.4</div><div class="line">        ports:</div><div class="line">        - containerPort: 80</div><div class="line"></div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Service</div><div class="line">metadata:</div><div class="line">  name: my-apache</div><div class="line">  labels:</div><div class="line">    run: my-apache</div><div class="line">spec:</div><div class="line">  type: NodePort</div><div class="line">  ports:</div><div class="line">  - port: 80</div><div class="line">    targetPort: 80</div><div class="line">    nodePort: 30002</div><div class="line">  selector:</div><div class="line">    run: my-apache</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">apiVersion: extensions/v1beta1</div><div class="line">kind: Ingress</div><div class="line">metadata:</div><div class="line">  name: test-ingress</div><div class="line">  namespace: default</div><div class="line">spec:</div><div class="line">  rules:</div><div class="line">  - host: test.apache.ingress</div><div class="line">    http:</div><div class="line">      paths:</div><div class="line">      - path: /</div><div class="line">        backend:</div><div class="line">          serviceName: my-apache</div><div class="line">          servicePort: 80</div><div class="line">  - host: test.nginx.ingress</div><div class="line">    http:</div><div class="line">      paths:</div><div class="line">      - path: /</div><div class="line">        backend:</div><div class="line">          serviceName: my-nginx</div><div class="line">          servicePort: 80</div></pre></td></tr></table></figure><p><img src="/2019/06/06/kubernetes-Ingress/2.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kubernetes configmap</title>
      <link href="/2019/05/29/kubernetes-configmap/"/>
      <url>/2019/05/29/kubernetes-configmap/</url>
      
        <content type="html"><![CDATA[<h2 id="configmap主要作用"><a href="#configmap主要作用" class="headerlink" title="configmap主要作用"></a>configmap主要作用</h2><ul><li>configMap卷将条目暴露为文件</li><li>实现pod与配置解耦</li><li>实现配置热更新</li></ul><h2 id="pod"><a href="#pod" class="headerlink" title="pod"></a>pod</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">---                                                                                                       </div><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: nginx-configmap</div><div class="line">  labels:</div><div class="line">     app: nginx-configmap</div><div class="line">spec:</div><div class="line">  restartPolicy: OnFailure</div><div class="line"># Always, OnFailure, Never. Default to Always.</div><div class="line">  volumes:</div><div class="line">    - name: nginx-configmap</div><div class="line">      configMap:</div><div class="line">        name: sean-nginx-config</div><div class="line">        items:</div><div class="line">        - key: nginx.conf</div><div class="line">          path: nginx.conf</div><div class="line">  containers:</div><div class="line">  - name: nginx</div><div class="line">    image: nginx</div><div class="line">    imagePullPolicy: IfNotPresent</div><div class="line">    ports:</div><div class="line">    - containerPort: 80</div><div class="line">    volumeMounts:</div><div class="line">    - mountPath: /etc/nginx/nginx.conf </div><div class="line">      subPath: nginx.conf</div><div class="line">      name: nginx-configmap</div></pre></td></tr></table></figure><h2 id="create-configmap"><a href="#create-configmap" class="headerlink" title="create configmap"></a>create configmap</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">shell&gt; kubectl create configmap sean-nginx-config --from-file=nginx.conf </div><div class="line">configmap/sean-nginx-config created</div><div class="line"></div><div class="line">shell&gt; kubectl describe configmaps sean-nginx-config</div></pre></td></tr></table></figure><p><img src="/2019/05/29/kubernetes-configmap/0.png" alt=""></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">## nginx.conf</div><div class="line">gzip on;</div><div class="line">gzip_types text/plain application/xml;</div></pre></td></tr></table></figure><h2 id="检测配置是否生效"><a href="#检测配置是否生效" class="headerlink" title="检测配置是否生效"></a>检测配置是否生效</h2><p>curl -I -H “Accept-Encoding: gzip” 10.32.0.3<br><img src="/2019/05/29/kubernetes-configmap/1.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetes</title>
      <link href="/2019/05/20/Kubernetes/"/>
      <url>/2019/05/20/Kubernetes/</url>
      
        <content type="html"><![CDATA[<h2 id="Kubernetes-简介"><a href="#Kubernetes-简介" class="headerlink" title="Kubernetes 简介"></a>Kubernetes 简介</h2><p>Kubernetes 是用于自动部署，扩展和管理容器化应用程序的开源系统。<br>它将组成应用程序的容器组合成逻辑单元，以便于管理和服务发现，Kubernetes 构建在 Google 15 年生产环境经验基础之上,并结合来自社区的最佳创意和实践。</p><p>k8s特性:</p><ul><li>自动包装<br>根据资源需求和其他约束自动放置容器，同时不会牺牲可用性，混合关键和最大努力的工作负载，以提高资源利用率并节省更多资源。</li></ul><ul><li>自我修复<br>重新启动失败的容器，在节点不可用时，替换和重新调度节点上的容器，对用户定义的健康检查不响应的容器会被中止，并且在容器准备好服务之前不会把其向客户端广播。</li></ul><ul><li>横向缩放<br>使用简单的命令或 UI，或者根据 CPU 的使用情况自动调整应用程序副本数。</li></ul><ul><li>服务发现和负载均衡<br>不需要修改您的应用程序来使用不熟悉的服务发现机制，Kubernetes 为容器提供了自己的 IP 地址和一组容器的单个 DNS 名称，并可以在它们之间进行负载均衡。</li></ul><ul><li>自动部署和回滚<br>Kubernetes 逐渐部署对应用程序或其配置的更改，同时监视应用程序运行状况，以确保它不会同时终止所有实例。 如果出现问题，Kubernetes会为您恢复更改，利用日益增长的部署解决方案的生态系统。</li></ul><ul><li>密钥和配置管理<br>部署和更新密钥和应用程序配置，不会重新编译您的镜像，不会在堆栈配置中暴露密钥(secrets)。</li></ul><ul><li>存储编排<br>自动安装您所选择的存储系统，无论是本地存储，如公有云提供商 GCP 或 AWS, 还是网络存储系统 NFS, iSCSI, Gluster, Ceph, Cinder, 或 Flocker。</li></ul><ul><li>批处理<br>除了服务之外，Kubernetes还可以管理您的批处理和 CI 工作负载，如果需要，替换出现故障的容器。</li></ul><h2 id="安装k8s"><a href="#安装k8s" class="headerlink" title="安装k8s"></a>安装k8s</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ubuntu server 16.04</div><div class="line"></div><div class="line">master: 10.21.0.33</div><div class="line">node1: 10.21.0.35</div><div class="line">node2: 10.21.0.16</div></pre></td></tr></table></figure><h3 id="修改源"><a href="#修改源" class="headerlink" title="修改源"></a>修改源</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">cp /etc/apt/sources.list&#123;,_bak&#125;</div><div class="line"></div><div class="line">echo &apos;deb http://mirrors.aliyun.com/ubuntu/ xenial main</div><div class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial main</div><div class="line"></div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main</div><div class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates main</div><div class="line"></div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial universe</div><div class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial universe</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe</div><div class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates universe</div><div class="line"></div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security main</div><div class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security main</div><div class="line">deb http://mirrors.aliyun.com/ubuntu/ xenial-security universe</div><div class="line">deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security universe&apos; \</div><div class="line">&gt;/etc/apt/sources.list</div></pre></td></tr></table></figure><h4 id="阿里k8s源"><a href="#阿里k8s源" class="headerlink" title="阿里k8s源"></a>阿里k8s源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">apt-get update &amp;&amp; apt-get install -y apt-transport-https</div><div class="line">curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - </div><div class="line">cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</div><div class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</div><div class="line">EOF</div></pre></td></tr></table></figure><h4 id="国内Docker源"><a href="#国内Docker源" class="headerlink" title="国内Docker源"></a>国内Docker源</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">echo &apos;&#123;</div><div class="line">&quot;registry-mirrors&quot;:[&quot;https://registry.docker-cn.com&quot;]</div><div class="line">&#125;&apos; &gt; /etc/docker/daemon.json</div></pre></td></tr></table></figure><h4 id="安装docker、k8s"><a href="#安装docker、k8s" class="headerlink" title="安装docker、k8s"></a>安装docker、k8s</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apt-get install docker.io</div><div class="line">apt-get install kubeadm</div></pre></td></tr></table></figure><h2 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h2><h3 id="Install-and-Set-Up-kubectl"><a href="#Install-and-Set-Up-kubectl" class="headerlink" title="Install and Set Up kubectl"></a>Install and Set Up kubectl</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apt-get update</div><div class="line">apt-get install kubelet kubeadm kubectl kubernetes-cni --allow-unauthenticated</div></pre></td></tr></table></figure><h3 id="初始化master"><a href="#初始化master" class="headerlink" title="初始化master"></a>初始化master</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#初始化</div><div class="line">kubeadm version</div><div class="line">kubeadm init --kubernetes-version=&apos;v1.14.1&apos;</div><div class="line"></div><div class="line">export KUBECONFIG=/etc/kubernetes/admin.conf</div></pre></td></tr></table></figure><p><img src="/2019/05/20/Kubernetes/init.png" alt=""></p><h2 id="Node加入master"><a href="#Node加入master" class="headerlink" title="Node加入master"></a>Node加入master</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kubeadm join 10.21.0.33:6443 --token q1trpk.x4ft1fibd02vuyd2 \</div><div class="line">--discovery-token-ca-cert-hash sha256:9fa3ba3fd1c43e46b8b4f6edaac9818a17cb4923537563a97313284c63d5bc50</div></pre></td></tr></table></figure><p><img src="/2019/05/20/Kubernetes/add-nodes.png" alt=""></p><h2 id="列出节点"><a href="#列出节点" class="headerlink" title="列出节点"></a>列出节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">shell&gt; kubectl get nodes</div><div class="line">NAME STATUS ROLES AGE VERSION</div><div class="line">k8s-master NotReady master 49m v1.14.1</div><div class="line">node1 NotReady &lt;none&gt; 52s v1.14.1</div><div class="line">node2 NotReady &lt;none&gt; 19s v1.14.1</div><div class="line"></div><div class="line">#状态显示NotReady，是因为集群内缺少网络控制器</div></pre></td></tr></table></figure><h3 id="addons-Networking"><a href="#addons-Networking" class="headerlink" title="addons - Networking"></a>addons - Networking</h3><p>添加网络插件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &apos;\n&apos;)&quot;</div><div class="line"></div><div class="line">shell&gt; kubectl get node</div><div class="line">NAME STATUS ROLES AGE VERSION</div><div class="line">k8s-master Ready master 54m v1.14.1</div><div class="line">node1 Ready &lt;none&gt; 6m5s v1.14.1</div><div class="line">node2 Ready &lt;none&gt; 5m32s v1.14.1</div></pre></td></tr></table></figure></p><p><img src="/2019/05/20/Kubernetes/addros.png" alt=""></p><h3 id="token"><a href="#token" class="headerlink" title="token"></a>token</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">## 查看当前的 token 表</div><div class="line">kubeadm token list</div><div class="line"></div><div class="line">## 新建token</div><div class="line">kubeadm token create --print-join-command</div></pre></td></tr></table></figure><h3 id="删除K8s节点"><a href="#删除K8s节点" class="headerlink" title="删除K8s节点"></a>删除K8s节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">master上运行：</div><div class="line">kubectl drain &lt;node name&gt; --delete-local-data --force --ignore-daemonsets</div><div class="line">kubectl delete node &lt;node name&gt;</div><div class="line"></div><div class="line">节点上运行：</div><div class="line">kubeadm reset</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cobbler Web Interface</title>
      <link href="/2019/05/17/Cobbler-Web-Interface/"/>
      <url>/2019/05/17/Cobbler-Web-Interface/</url>
      
        <content type="html"><![CDATA[<h1 id="cobbler-web"><a href="#cobbler-web" class="headerlink" title="cobbler-web"></a>cobbler-web</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install cobbler-web</div><div class="line">systemctl restart httpd</div></pre></td></tr></table></figure><p>web: <a href="https://you_ip/cobbler_web" target="_blank" rel="external">https://you_ip/cobbler_web</a><br>usr/pwd:cobbler</p><p><img src="/2019/05/17/Cobbler-Web-Interface/0.png" alt=""></p><h2 id="know-error"><a href="#know-error" class="headerlink" title="know error:"></a>know error:</h2><ul><li><p>cobbler web</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Internal Server Error</div><div class="line">The server encountered an internal error or misconfiguration and was unable to complete your request.</div><div class="line"></div><div class="line">Please contact the server administrator at root@localhost to inform them of the time this error occurred, and the actions you performed just before this error.</div><div class="line"></div><div class="line">More information about this error may be available in the server error log.</div></pre></td></tr></table></figure></li><li><p>fix</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">wget https://bootstrap.pypa.io/get-pip.py</div><div class="line"></div><div class="line">python get-pip.py</div><div class="line"></div><div class="line">pip install Django==1.8.9</div><div class="line"></div><div class="line">python -c &quot;import django; print(django.get_version())&quot;</div><div class="line"></div><div class="line">systemctl restart httpd</div></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cobbler </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cobbler with VIP</title>
      <link href="/2019/05/15/cobbler-with-VIP/"/>
      <url>/2019/05/15/cobbler-with-VIP/</url>
      
        <content type="html"><![CDATA[<h2 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h2><p><img src="/2019/05/15/cobbler-with-VIP/cobbler-vip.svg" alt=""></p><p>主要从两个方面实现跨域</p><ul><li>virtual network<br>实现网络互通</li><li>DHCP relay<br>实现dhcp分配</li></ul><h2 id="cobbler-Server"><a href="#cobbler-Server" class="headerlink" title="cobbler Server"></a>cobbler Server</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">## 修改dnsmasq配置，统一指定为tftp外网ip</div><div class="line">dhcp-boot=pxelinux.0,server.name,172.16.1.181</div></pre></td></tr></table></figure><h2 id="dhcp-relay"><a href="#dhcp-relay" class="headerlink" title="dhcp relay"></a>dhcp relay</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dhcrelay -i ens160 -d 10.10.10.1</div></pre></td></tr></table></figure><p>dhcp relay内主机测试</p><p>cobbler log:<br><img src="/2019/05/15/cobbler-with-VIP/cobbler-log.png" alt=""></p><p>dhcp relay log：<br><img src="/2019/05/15/cobbler-with-VIP/dhcrelay.png" alt=""></p><p><img src="/2019/05/15/cobbler-with-VIP/vip-pxe.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cobbler </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cobbler</title>
      <link href="/2019/05/05/cobbler/"/>
      <url>/2019/05/05/cobbler/</url>
      
        <content type="html"><![CDATA[<p>Setup PXE Boot Environment Using Cobbler On CentOS 7</p><h1 id="Install-Cobbler"><a href="#Install-Cobbler" class="headerlink" title="Install Cobbler"></a>Install Cobbler</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#CentOS7</div><div class="line">#yum install -y ed patch perl perl-Compress-Zlib perl-Digest-SHA1 perl-LockFile-Simple perl-libwww-perl #编译环境</div><div class="line"></div><div class="line">yum -y install epel-release</div><div class="line">yum install cobbler dnsmasq xinetd pykickstart debmirror</div></pre></td></tr></table></figure><h1 id="Configure-Cobbler"><a href="#Configure-Cobbler" class="headerlink" title="Configure Cobbler"></a>Configure Cobbler</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">## /etc/cobbler/settings</div><div class="line"></div><div class="line">server=192.168.122.22</div><div class="line">sed -i &quot;s/server: 127.0.0.1/server: $server/&quot; /etc/cobbler/settings</div><div class="line">sed -i &quot;s/next_server: 127.0.0.1/next_server: $server/&quot; /etc/cobbler/settings</div><div class="line">sed -i &apos;s/manage_dhcp: 0/manage_dhcp: 1/&apos; /etc/cobbler/settings</div><div class="line">sed -i &apos;s/manage_dns: 0/manage_dns: 1/&apos; /etc/cobbler/settings</div><div class="line">sed -i &apos;s/pxe_just_once: 0/pxe_just_once: 1/&apos; /etc/cobbler/settings</div><div class="line">sed -ri &quot;/default_password_crypted/s#(.*: ).*#\1\&quot;`openssl passwd -1 -salt &apos;cobbler&apos; &apos;cobbler&apos;`\&quot;#&quot; /etc/cobbler/settings</div><div class="line"></div><div class="line">sed -i &apos;/disable/c\\tdisable\t\t\t= no&apos; /etc/xinetd.d/tftp</div><div class="line"></div><div class="line"># sed -i -e &apos;s/\=\ yes/\=\ no/g&apos; /etc/xinetd.d/rsync</div></pre></td></tr></table></figure><p>/etc/cobbler/modules.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[dns]</div><div class="line">module = manage_dnsmasq</div><div class="line"></div><div class="line">[dhcp]</div><div class="line">module = manage_dnsmasq</div><div class="line"></div><div class="line">[tftpd]</div><div class="line">module = manage_in_tftpd</div></pre></td></tr></table></figure></p><h2 id="Configure-DHCP"><a href="#Configure-DHCP" class="headerlink" title="Configure DHCP"></a>Configure DHCP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># Cobbler generated configuration file for dnsmasq</div><div class="line"># $date</div><div class="line">#</div><div class="line"></div><div class="line"># resolve.conf .. ?</div><div class="line">#no-poll</div><div class="line">#enable-dbus</div><div class="line">read-ethers</div><div class="line">addn-hosts = /var/lib/cobbler/cobbler_hosts</div><div class="line"></div><div class="line">dhcp-range=192.168.122.5,192.168.122.254,255.255.255.0</div><div class="line">dhcp-ignore=tag:!known</div><div class="line">dhcp-option=3,$next_server</div><div class="line">dhcp-lease-max=1000</div><div class="line">dhcp-authoritative</div><div class="line">dhcp-boot=pxelinux.0</div><div class="line">dhcp-boot=net:normalarch,pxelinux.0</div><div class="line">dhcp-boot=net:ia64,$elilo</div><div class="line"></div><div class="line">$insert_cobbler_system_definitions</div></pre></td></tr></table></figure><h2 id="etc-debmirror-conf"><a href="#etc-debmirror-conf" class="headerlink" title="/etc/debmirror.conf"></a>/etc/debmirror.conf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sed -i &apos;s/@dists=&quot;sid&quot;;/#@dists=&quot;sid&quot;;/g&apos; /etc/debmirror.conf</div><div class="line">sed -i &apos;s/@arches=&quot;i386&quot;;/#@arches=&quot;i386&quot;;/g&apos; /etc/debmirror.conf</div></pre></td></tr></table></figure><h1 id="Importing-ISO-files-to-Cobbler-server"><a href="#Importing-ISO-files-to-Cobbler-server" class="headerlink" title="Importing ISO files to Cobbler server"></a>Importing ISO files to Cobbler server</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cobbler get-loaders #下载引导文件</div><div class="line">mount -o loop centos6.iso /mnt/</div><div class="line">cobbler import --arch=x86_64 --path=/mnt/ --name=Centos-6</div></pre></td></tr></table></figure><p><img src="/2019/05/05/cobbler/import_iso.png" alt=""></p><p>启动相关服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">systemctl enable xinetd</div><div class="line">systemctl enable cobblerd</div><div class="line">systemctl enable dnsmasq</div><div class="line">systemctl enable httpd</div><div class="line">systemctl enable rsyncd.service</div><div class="line"></div><div class="line">systemctl restart xinetd</div><div class="line">systemctl restart cobblerd</div><div class="line">systemctl restart dnsmasq</div><div class="line">systemctl restart httpd</div><div class="line">systemctl restart rsyncd.service</div></pre></td></tr></table></figure></p><h2 id="cobbler-commands"><a href="#cobbler-commands" class="headerlink" title="cobbler commands"></a>cobbler commands</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">cobbler check# 核对当前设置是否有问题</div><div class="line">cobbler list# 列出所有的cobbler元素</div><div class="line">cobbler report# 列出元素的详细信息</div><div class="line">cobbler sync# 同步配置到数据目录,更改配置最好都要执行下</div><div class="line">cobbler reposync# 同步yum仓库</div><div class="line">cobbler distro# 查看导入的发行版系统信息</div><div class="line">cobbler system# 查看添加的系统信息</div><div class="line">cobbler profile# 查看配置信息</div></pre></td></tr></table></figure><h2 id="测试tftp能否获取到引导文件"><a href="#测试tftp能否获取到引导文件" class="headerlink" title="测试tftp能否获取到引导文件"></a>测试tftp能否获取到引导文件</h2><p>curl tftp://192.168.122.22/pxelinux.0 |tail</p><h2 id="Adding-Kickstart-file-to-Cobbler-server"><a href="#Adding-Kickstart-file-to-Cobbler-server" class="headerlink" title="Adding Kickstart file to Cobbler server"></a>Adding Kickstart file to Cobbler server</h2><p>system-config-kickstart<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cobbler profile add --name=CentOS-6.5-basic --distro=CentOS-6.5-x86_64 --kickstart=/var/lib/cobbler/kickstarts/cetos6.x86_64.cfg</div><div class="line"></div><div class="line">cobbler profile list</div></pre></td></tr></table></figure></p><h2 id="boot"><a href="#boot" class="headerlink" title="boot"></a>boot</h2><p><img src="/2019/05/05/cobbler/pxe-boot.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cobbler </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansible optimize</title>
      <link href="/2019/04/30/ansible-optimize/"/>
      <url>/2019/04/30/ansible-optimize/</url>
      
        <content type="html"><![CDATA[<h2 id="1-开启SSH长连接"><a href="#1-开启SSH长连接" class="headerlink" title="1. 开启SSH长连接"></a>1. 开启SSH长连接</h2><p>[ssh_connection]<br>ssh_args = -o ControlMaster=auto -o ControlPersist=4h<br>control_path = /etc/ansible/ssh-socket/%%h-%%p-%%r</p><h2 id="2-开启pipelining"><a href="#2-开启pipelining" class="headerlink" title="2. 开启pipelining"></a>2. 开启pipelining</h2><p>pipelining = True<br>PS：如果开启pipelining，需要被控的远程服务器将/etc/sudoers中的”Defaults requiretty”注释掉，否则会出现类似如：you must have a ttyto run sudo 的报错。</p><h2 id="3-开启accelerate模式"><a href="#3-开启accelerate模式" class="headerlink" title="3. 开启accelerate模式"></a>3. 开启accelerate模式</h2><p>playbook中配置accelerate: true</p><p>[accelerate]<br>accelerate_port = 5099<br>accelerate_timeout = 30<br>accelerate_connect_timeout = 5.0<br>PS：使用accelerate模式，需要控制服务器和远程服务器都安装python-keyczar包</p><h2 id="4-对facts设置优化"><a href="#4-对facts设置优化" class="headerlink" title="4. 对facts设置优化"></a>4. 对facts设置优化</h2><p>各种方式的配置都是在ansible.cfg中配置。</p><p>1）json文件方式</p><p>gathering=smart<br>fact_caching_timeout=86400<br>fact_caching=jsonfile<br>fact_caching_connection=/path/to/ansible_fact_cache<br>这里的86400单位为秒，表示缓存的过期时间。保存facts信息的json文件保存在/path/to/ansible_fact_cache下面，文件名是按照inventory hostname来命名的。</p><p>2）redis方式</p><p>gathering=smart<br>fact_caching_timeout=86400<br>fact_caching=redis<br>需要注意的是，facts存储不支持远端的redis，需要在ansible的控制服务器上安装redis；同时，还需要安装python的redis模块。</p><p>3）memcache方式</p><p>gathering=smart<br>fact_caching_timeout=86400<br>fact_caching=memcached<br>与redis方式类似，需要运行memcached服务，同时，安装python的memcached依赖包。</p><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>优化前平均real为2s，以下为不同虚拟化及物理机优化后效果</p><p>host<br><img src="/2019/04/30/ansible-optimize/0.png" alt=""></p><p>kvm [NAT]<br><img src="/2019/04/30/ansible-optimize/1.png" alt=""></p><p>vmware [NAT]<br><img src="/2019/04/30/ansible-optimize/2.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansible-tower</title>
      <link href="/2019/04/28/ansible-tower/"/>
      <url>/2019/04/28/ansible-tower/</url>
      
        <content type="html"><![CDATA[<p>批量添加主机</p><h2 id="tower-manage"><a href="#tower-manage" class="headerlink" title="tower-manage"></a>tower-manage</h2><p>通过Tower自带的命令行工具tower-manage来批量导入主机，可以从主机的/etc/ansible/hosts中直接导入</p><ul><li>先创建名为test-1的inventory</li></ul><p><img src="/2019/04/28/ansible-tower/1.png" alt=""></p><ul><li>tower-manage 导入主机<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@AnsibleTower ansible]# tower-manage inventory_import --source=/etc/ansible/hosts --group-filter=test --inventory-name=test-1 --keep-vars</div><div class="line">2.427 INFO Updating inventory 2: test-1</div><div class="line">2.598 INFO Reading Ansible inventory source: /etc/ansible/hosts</div><div class="line">4.813 INFO Processing JSON output...</div><div class="line">4.814 INFO Loaded 1 groups, 2 hosts</div><div class="line">5.056 INFO Inventory import completed for (test-1 - 7) in 2.6s</div></pre></td></tr></table></figure></li></ul><p><img src="/2019/04/28/ansible-tower/2.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ansible</title>
      <link href="/2019/04/26/ansible/"/>
      <url>/2019/04/26/ansible/</url>
      
        <content type="html"><![CDATA[<h2 id="ansible简介"><a href="#ansible简介" class="headerlink" title="ansible简介"></a>ansible简介</h2><p>Doc: <a href="https://docs.ansible.com/" target="_blank" rel="external">https://docs.ansible.com/</a></p><ul><li><p>ansible是个什么东西呢？官方的title是“Ansible is Simple IT Automation”——简单的自动化IT工具。这个工具的目标有这么几项：让我们自动化部署APP；自动化管理配置项；自动化的持续交付；自动化的（AWS）云服务管理。</p></li><li><p>ansible以SSH方式进行管理通讯</p></li><li><p>Ansible由5个部分组成：</p></li></ul><ol><li>Ansible： 核心</li><li>Modules： 包括 Ansible 自带的核心模块及自定义模块</li><li>Plugins： 完成模块功能的补充，包括连接插件、邮件插件等</li><li>Playbooks： 剧本(编排好一步一步的执行)；定义 Ansible 多任务配置文件，有 Ansible 自动执行</li><li>Inventory： 定义 Ansible 管理主机的清单</li></ol><h2 id="安装要求"><a href="#安装要求" class="headerlink" title="安装要求"></a>安装要求</h2><ul><li>控制器：Python2.6/2.7</li><li>受管节点要求：Python2.4 以上版本，若低于 Python2.5 需要安装 pythonsimplejson; 若启用了 selinux，则需要安装 libselinux-python。</li><li>如果存在多环境Python 记得修改主控端的/usr/bin/ansible 的python环境</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install epel-release</div><div class="line">yum install ansibl</div></pre></td></tr></table></figure><h2 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@ansible ~]# ansible 192.168.122.129 -m ping -k</div><div class="line">SSH password: </div><div class="line">192.168.122.129 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;changed&quot;: false, </div><div class="line">    &quot;ping&quot;: &quot;pong&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#返回：  &quot;ping&quot;: &quot;pong&quot; 说明是成功了！</div></pre></td></tr></table></figure><h3 id="common模块使用"><a href="#common模块使用" class="headerlink" title="common模块使用"></a>common模块使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">格式:</div><div class="line">ansbile 操作目标 -m 模块名 -a 模块参数</div><div class="line">ansible-doc -l 命令查看到当前 ansible 都支持哪些模块</div><div class="line">ansible-doc -s 模块名 又可以查看该模块有哪些参数可以使用</div><div class="line"></div><div class="line">ansible all -m command &apos;ip a eth0&apos;</div><div class="line">ansible all -m command -a &quot;echo jie |passwd --stdin testuser&quot; #command本身不理解这种形式的操作</div><div class="line">ansible all -m shell -a &quot;echo jie |passwd --stdin testuser&quot;</div></pre></td></tr></table></figure><h2 id="常用命令的介绍"><a href="#常用命令的介绍" class="headerlink" title="常用命令的介绍"></a>常用命令的介绍</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">ansible --help</div><div class="line">-v,–verbose # 详细模式，如果命令执行成功，输出详细的结果(-vv –vvv -vvvv)</div><div class="line">-i PATH,–inventory=PATH #指定host文件的路径，默认是/etc/ansible/hosts</div><div class="line">-f NUM,–forks=NUM # NUM是指定一个整数，默认是5，指定fork开启同步进程的个数。</div><div class="line">-m NAME,–module-name=NAME #指定使用的module名称，默认是command</div><div class="line">-m DIRECTORY,–module-path=DIRECTORY #指定module的目录来加载module，默认是/usr/share/ansible,</div><div class="line">-a,MODULE_ARGS #指定module模块的参数</div><div class="line">-k,–ask-pass # 提示输入ssh的密码，而不是使用基于ssh的密钥认证</div><div class="line">–sudo # 指定使用sudo获得root权限</div><div class="line">-K,–ask-sudo-pass #提示输入sudo密码，与–sudo一起使用</div><div class="line">-u USERNAME,–user=USERNAME # 指定移动端的执行用户</div><div class="line">-C,–check #测试此命令执行会改变什么内容，不会真正的去执行</div></pre></td></tr></table></figure><h2 id="hosts文件格式"><a href="#hosts文件格式" class="headerlink" title="hosts文件格式"></a>hosts文件格式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">1、正常写法,name1为别名：</div><div class="line">[test1]</div><div class="line">name1 ansible_ssh_host=192.168.1.111 ansible_ssh_user=&quot;root&quot; ansible_ssh_pass=&quot;1234&quot; ansible_ssh_port=22</div><div class="line">name2 ansible_ssh_host=192.168.1.222 ansible_ssh_user=&quot;root&quot; ansible_ssh_pass=&quot;1234&quot; ansible_ssh_port=22</div><div class="line">2、连续的IP写法,表示192.168.1.20到192.168.1.50，共31台主机：</div><div class="line">[test1]</div><div class="line">name1 ansible_ssh_host=192.168.1.[20:50] ansible_ssh_user=&quot;root&quot; ansible_ssh_pass=&quot;1234&quot; ansible_ssh_port=22</div><div class="line">3、带参数的群组，vars底下为群组共同便变量，包括已定义变量和自定义变量：</div><div class="line">[test1]</div><div class="line">name1 ansible_ssh_host=192.168.1.[20:50]</div><div class="line">[test1:vars]</div><div class="line">ansible_ssh_user=root</div><div class="line">ansible_ssh_pass=&quot;1234&quot;</div><div class="line">testvar=&quot;test&quot;</div><div class="line">4、群组整合，children底下为父群组test的子群组，调用方式为ansible test -m ping：</div><div class="line">[dbtest]</div><div class="line">name1 ansible_ssh_host=192.168.1.[20:50] ansible_ssh_user=&quot;root&quot; ansible_ssh_pass=&quot;1234&quot; ansible_ssh_port=22</div><div class="line">[webtest]</div><div class="line">name2 ansible_ssh_host=192.168.2.[20:50] ansible_ssh_user=&quot;root&quot; ansible_ssh_pass=&quot;1234&quot; ansible_ssh_port=22</div><div class="line">[test:children]</div><div class="line">dbtest</div><div class="line">webtest</div><div class="line">5、调用两个主机组的写法，以下webservers和dbservers都会被调用：</div><div class="line">ansible webservers:dbservers -m win_ping</div><div class="line">6、在webservers组中但不在dbsersers中的调用：</div><div class="line">ansible webservers:!dbservers -m win_ping</div><div class="line">7、在webservers组中并且在dbservers组中的才会调用：</div><div class="line">ansible webservers:&amp;dbservers -m win_ping</div><div class="line">8、在调用前加~，代表正则表达式：</div><div class="line">ansible ~(web|db).*.91it.org -m win_ping</div><div class="line">9、组合的例子：</div><div class="line">webserver:dbservers:&amp;nginx:!ntp</div><div class="line">10、hosts文件中没有定义的IP或别名，在进行调用中，会提示错误。ansible对单台服务器的调用，服务器IP或域名必须有写在hosts里。</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ansible </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>portainer</title>
      <link href="/2018/07/02/portainer/"/>
      <url>/2018/07/02/portainer/</url>
      
        <content type="html"><![CDATA[<h2 id="Portainer"><a href="#Portainer" class="headerlink" title="Portainer"></a>Portainer</h2><ul><li>Simple management UI for Docker</li><li>homepage: <a href="https://portainer.io" target="_blank" rel="external">https://portainer.io</a><a id="more"></a></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">docker volume create portainer_data</div><div class="line">docker run --name portainer \</div><div class="line">    -p 9000:9000 \</div><div class="line">    -v /var/run/docker.sock:/var/run/docker.sock \</div><div class="line">    -v portainer_data:/data \</div><div class="line">    -d portainer/portainer</div></pre></td></tr></table></figure><h2 id="create-user"><a href="#create-user" class="headerlink" title="create user"></a>create user</h2><p><img src="/2018/07/02/portainer/./pic0.png" alt=""><br><img src="/2018/07/02/portainer/./pic1.png" alt=""><br><img src="/2018/07/02/portainer/./pic2.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> virtualization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> gui </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MegaCli</title>
      <link href="/2018/06/22/MegaCli/"/>
      <url>/2018/06/22/MegaCli/</url>
      
        <content type="html"><![CDATA[<h2 id="MegaCli"><a href="#MegaCli" class="headerlink" title="MegaCli"></a>MegaCli</h2><ul><li>一款管理维护硬件RAID软件，可以通过它来了解当前raid卡的所有信息，包括 raid卡的型号，raid的阵列类型，raid 上各磁盘状态等等。</li></ul><p>通常，我们对硬盘当前的状态不太好确定，一般通过机房人员巡检来完成，怎么通过软件的方式来检查确定这个问题呢？MegaCli就可以做到，一般通过 MegaCli 的Media Error Count: 0 Other Error Count: 0 这两个数值来确定阵列中磁盘是否有问题；Medai Error Count 表示磁盘可能错误，可能是磁盘有坏道，这个值不为0值得注意，数值越大，危险系数越高，Other Error Count 表示磁盘可能存在松动，可能需要重新再插入。MegaCli 可以对阵列中所有的磁盘进行检测，我们可以通过脚本的方式来检测相关参数，从而通知管理人员。<br><a id="more"></a></p><h2 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">unzip 8-07-14_MegaCLI.zip</div><div class="line">cd Linux</div><div class="line">rpm -Uvh MegaCli-8.07.14-1.noarch.rpm</div><div class="line">echo &quot;alias MegaCli=&apos;/opt/MegaRAID/MegaCli/MegaCli64&apos;&quot; &gt;&gt; ~/.bashrc</div><div class="line">source ~/.bashrc</div></pre></td></tr></table></figure><h2 id="example"><a href="#example" class="headerlink" title="example"></a>example</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">显示适配器个数： MegaCli -adpCount</div><div class="line">显示适配器时间： MegaCli -AdpGetTime –aALL</div><div class="line">显示所有适配器信息： MegaCli -AdpAllInfo -aAll</div><div class="line">显示所有逻辑磁盘组信息： MegaCli -LDInfo -LALL -aAll</div><div class="line">显示所有的物理信息： MegaCli -PDList -aAll</div><div class="line">查看充电状态： MegaCli -AdpBbuCmd -GetBbuStatus -aALL |grep ‘Charger Status’</div><div class="line">显示BBU(后备电池)状态信息： MegaCli -AdpBbuCmd -GetBbuStatus -aALL</div><div class="line">显示BBU容量信息： MegaCli -AdpBbuCmd -GetBbuCapacityInfo -aALL</div><div class="line">显示BBU设计参数： MegaCli -AdpBbuCmd -GetBbuDesignInfo -aALL</div><div class="line">显示当前BBU属性： MegaCli -AdpBbuCmd -GetBbuProperties -aALL</div><div class="line">显示Raid卡型号，Raid设置，Disk相关信息： MegaCli -cfgdsply -aALL</div><div class="line">查看Cache 策略设置： MegaCli -cfgdsply -aALL |grep Policy</div><div class="line">查看充电进度百分比： MegaCli -AdpBbuCmd -GetBbuStatus -aALL |grep ‘Relative State of Charge’</div></pre></td></tr></table></figure><p><img src="/2018/06/22/MegaCli/./0.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>emby</title>
      <link href="/2018/05/26/emby/"/>
      <url>/2018/05/26/emby/</url>
      
        <content type="html"><![CDATA[<h2 id="Emby"><a href="#Emby" class="headerlink" title="Emby"></a>Emby</h2><ul><li>Your personal media on any device</li><li>Bringing all of your home videos, music, and photos together into one place has never been easier. Your personal Emby Server automatically converts and streams your media on-the-fly to play on any device.</li></ul><p>Homepage: </p><ul><li><a href="https://emby.media/" target="_blank" rel="external">https://emby.media/</a></li></ul><h2 id="Emby-Server-for-Docker"><a href="#Emby-Server-for-Docker" class="headerlink" title="Emby Server for Docker:"></a>Emby Server for Docker:</h2><p>Install Emby Server<br>Emby Docker instructions can be found on Docker Hub:<br><a href="https://hub.docker.com/r/emby/embyserver" target="_blank" rel="external">https://hub.docker.com/r/emby/embyserver</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">mkdir -p /Docker/emby/&#123;programdata,share&#125;</div><div class="line"></div><div class="line">docker run --name emby \</div><div class="line">    --volume /Docker/emby/programdata:/config \</div><div class="line">    --volume /Docker/emby/share:/mnt/share \</div><div class="line">    -v /home/xy/space/kvm_tmp/thunder/:/mnt/thunder \                                                                                                  </div><div class="line">    --device /dev/dri/renderD128 \</div><div class="line">    --publish 8096:8096 \</div><div class="line">    --publish 8920:8920 \</div><div class="line">    --env UID=1000 \ </div><div class="line">    --env GID=100 \</div><div class="line">    --env GIDLIST=44 \</div><div class="line">    -d emby/embyserver:latest</div></pre></td></tr></table></figure></p><h2 id="Library-Setup-Page"><a href="#Library-Setup-Page" class="headerlink" title="Library Setup Page"></a>Library Setup Page</h2><ul><li><a href="https://github.com/MediaBrowser/Wiki/wiki/Library%20setup#library-setup-page" target="_blank" rel="external">https://github.com/MediaBrowser/Wiki/wiki/Library%20setup#library-setup-page</a></li><li>The configuration will display the media libraries you’ve configured and allow you to add, remove, rename or change the paths they’re mapped to.</li><li>A media library is a grouping of one or more physical folders on your file system.</li><li>To get started, click the button to add a media library.</li></ul><p><img src="/2018/05/26/emby/./0.png" alt=""></p><p><img src="/2018/05/26/emby/./5.png" alt=""></p><p><img src="/2018/05/26/emby/./4.png" alt=""></p><h2 id="Mobile-client"><a href="#Mobile-client" class="headerlink" title="Mobile client"></a>Mobile client</h2><p><img width="45%" height="auto" hspace="10" src="/2018/05/26/emby/./1.png" align="left"></p><p><img width="45%" height="auto" hspace="10" src="/2018/05/26/emby/./3.PNG" align="left"></p>]]></content>
      
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dockerfile</title>
      <link href="/2018/05/02/dockerfile/"/>
      <url>/2018/05/02/dockerfile/</url>
      
        <content type="html"><![CDATA[<p>Dockerfile是docker构建镜像的基础，也是docker区别于其他容器的重要特征，正是有了Dockerfile，docker的自动化和可移植性才成为可能。</p><p>FROM , 从一个基础镜像构建新的镜像<br>MAINTAINER , 维护者信息<br>ENV , 设置环境变量<br>RUN , 非交互式运行shell命令<br>ADD , 将外部文件拷贝到镜像里,src可以为url<br>WORKDIR /path/to/workdir, 切换目录用，可以多次切换(相当于cd命令)，对RUN,CMD,ENTRYPOINT生效<br>USER , 设置用户ID<br>VULUME &lt;#dir&gt;, 设置volume<br>EXPOSE 80 443<br>ENTRYPOINT [‘executable’, ‘param1’,’param2’]执行命令<br>CMD [“param1”,”param2”]<br>CMD [“start”]</p><p>docker创建、启动container时执行的命令，如果设置了ENTRYPOINT，则CMD将作为参数<br>container启动时执行的命令，但是一个Dockerfile中只能有一条CMD命令，多条则只执行最后一条CMD.</p>]]></content>
      
      
      <categories>
          
          <category> virtualization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Integrate Collabora Online Server with Nextcloud</title>
      <link href="/2018/04/13/nextcloud/"/>
      <url>/2018/04/13/nextcloud/</url>
      
        <content type="html"><![CDATA[<p>Homepage</p><ul><li><a href="https://nextcloud.com" target="_blank" rel="external">https://nextcloud.com</a></li><li><a href="https://www.collaboraoffice.com/code/" target="_blank" rel="external">https://www.collaboraoffice.com/code/</a></li></ul><h2 id="nextcloud"><a href="#nextcloud" class="headerlink" title="nextcloud"></a>nextcloud</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">docker pull nextcloud</div><div class="line"></div><div class="line">nextcloud_data=&apos;/Docker/nextcolud&apos;</div><div class="line"></div><div class="line">docker run -t --name nextcloud \</div><div class="line">-p 80:80 \</div><div class="line">-v $nextcloud_data:/var/www/html/data \</div><div class="line">-d nextcloud</div></pre></td></tr></table></figure><h2 id="collabora-online"><a href="#collabora-online" class="headerlink" title="collabora online"></a>collabora online</h2><ul><li>Collabora Online is a powerful LibreOffice-based online office suite with collaborative editing, which supports all major document, spreadsheet and presentation file formats and works in all modern browsers.</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker pull collabora/code</div><div class="line"></div><div class="line">docker run -t --name collabora \</div><div class="line">-p 9980:9980 \</div><div class="line">-e &quot;username=admin&quot; -e &quot;password=S3cRet&quot; \</div><div class="line">--restart always --cap-add MKNOD \</div><div class="line">-d collabora/code</div></pre></td></tr></table></figure><h3 id="set-up-ssl"><a href="#set-up-ssl" class="headerlink" title="set up ssl"></a>set up ssl</h3><p><img src="/2018/04/13/nextcloud/./pic.png" alt=""><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vim +70 loolwsd.xml</div><div class="line">docker restart collabora</div></pre></td></tr></table></figure></p><p>docker ps<br><img src="/2018/04/13/nextcloud/./pic1.png" alt=""></p><h2 id="set-up-collabora-online"><a href="#set-up-collabora-online" class="headerlink" title="set up collabora online"></a>set up collabora online</h2><p><img src="/2018/04/13/nextcloud/./pic2.png" alt=""><br><img src="/2018/04/13/nextcloud/./pic3.png" alt=""><br><img src="/2018/04/13/nextcloud/./pic4.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
            <tag> collabora </tag>
            
            <tag> cloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>fastDFS</title>
      <link href="/2018/03/31/fastDFS/"/>
      <url>/2018/03/31/fastDFS/</url>
      
        <content type="html"><![CDATA[<h2 id="FastDFS介绍"><a href="#FastDFS介绍" class="headerlink" title="FastDFS介绍"></a>FastDFS介绍</h2><ul><li><p>FastDFS 是一个开源的轻量级高性能分布式文件系统（DFS），主要解决了海量数据存储问题，特别适合以中小文件（建议范围：4KB &lt; file_size &lt; 500MB）为载体的在线服务。它的主要功能包括：文件存储，文件同步和文件访问，以及高容量和负载平衡。</p></li><li><p>源码地址：<a href="https://github.com/happyfish100/fastdfs" target="_blank" rel="external">https://github.com/happyfish100/fastdfs</a></p></li></ul><p>FastDFS 系统有三个角色：跟踪服务器(Tracker Server)、存储服务器(Storage Server)和客户端(Client)。</p><ul><li>Tracker Server: 跟踪服务器，主要做调度工作，起到均衡的作用；负责管理所有的 storage server 和 group，每个 storage 在启动后会连接Tracker，告知自己所属 group 等信息，并保持周期性心跳。</li><li>Storage Server：存储服务器，主要提供容量和备份服务；以 group 为单位，每个 group 内可以有多台 storage server，数据互为备份。</li><li>Client:客户端，上传下载数据的服务器，也就是我们自己的项目所部署在的服务器。<br><img src="/2018/03/31/fastDFS/./pic0.png" alt=""></li></ul><p>sysinfo:</p><ul><li>tracker/nginx          192.168.1.241                    </li><li>storage/nginx          192.168.1.239                fastdfs-nginx-module</li><li>storage/nginx          192.168.1.242                fastdfs-nginx-module</li></ul><h2 id="dep-list"><a href="#dep-list" class="headerlink" title="dep list"></a>dep list</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">### libfastcommon</div><div class="line">## https://github.com/happyfish100/libfastcommon</div><div class="line">./make.sh</div><div class="line">./make.sh install</div><div class="line"></div><div class="line">## FastDFS</div><div class="line">## https://sourceforge.net/projects/fastdfs/files/</div><div class="line">## https://github.com/happyfish100/fastdfs/releases</div><div class="line">./make.sh</div><div class="line">./make.sh install</div></pre></td></tr></table></figure><h2 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">## https://github.com/happyfish100/fastdfs-nginx-module</div><div class="line"></div><div class="line">./configure --add-module=/home/fastdfs-nginx-module/src</div><div class="line">make;</div><div class="line">make install;</div></pre></td></tr></table></figure><p>mkdir -p /data/fastDFS/{tracker,storage,client}</p><h2 id="setup-tracker"><a href="#setup-tracker" class="headerlink" title="setup tracker"></a>setup tracker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">## tracker.conf</div><div class="line">base_path=/data/fastDFS/tracker</div><div class="line">bind_addr=</div><div class="line">port=22122</div><div class="line"></div><div class="line">## tracker-nginx</div><div class="line">upstream fdfs &#123;</div><div class="line">ip_hash;</div><div class="line">server 192.168.1.239:7079;</div><div class="line">server 192.168.1.242:7079;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server&#123;</div><div class="line">listen 80;</div><div class="line">location /group1/ &#123;</div><div class="line">proxy_set_header Host \$host;</div><div class="line">proxy_set_header X-Real-IP \$remote_addr;</div><div class="line">proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;</div><div class="line"></div><div class="line">proxy_buffering off;</div><div class="line">proxy_pass http://fdfs;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="Storage-conf"><a href="#Storage-conf" class="headerlink" title="Storage.conf"></a>Storage.conf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"># storage.conf</div><div class="line"></div><div class="line">base_path=/data/fastDFS/storage </div><div class="line">store_path0=/data/fastDFS/storage</div><div class="line">tracker_server=192.168.1.239:22122                    ##can&apos;t use localhost</div><div class="line"></div><div class="line"># /etc/fdfs/mod_fastdfs.conf</div><div class="line">#include http.conf</div><div class="line">connect_timeout=2</div><div class="line">network_timeout=30</div><div class="line">base_path=/tmp</div><div class="line">load_fdfs_parameters_from_tracker=true</div><div class="line">storage_sync_file_max_delay = 86400</div><div class="line">use_storage_id = false</div><div class="line">storage_ids_filename = storage_ids.conf</div><div class="line">tracker_server=192.168.1.241:22122</div><div class="line">storage_server_port=23000</div><div class="line">group_name=group1</div><div class="line">url_have_group_name = true</div><div class="line">store_path_count=2</div><div class="line">store_path0=/data/fastDFS/storage/S0</div><div class="line">store_path1=/data/fastDFS/storage/S1</div><div class="line">log_level=info</div><div class="line">log_filename=</div><div class="line">response_mode=proxy</div><div class="line">if_alias_prefix=</div><div class="line">flv_support = true</div><div class="line">flv_extension = flv</div><div class="line">group_count = 0</div><div class="line"></div><div class="line"></div><div class="line"># storage-nginx</div><div class="line">server &#123;</div><div class="line">    listen 7079;</div><div class="line"></div><div class="line">    location /group1/ &#123;</div><div class="line">        root /data/fastDFS/storage;</div><div class="line">        ngx_fastdfs_module;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="client-conf"><a href="#client-conf" class="headerlink" title="client.conf"></a>client.conf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">base_path=/data/fastDFS/client</div><div class="line">tracker_server=192.168.1.239:22122</div></pre></td></tr></table></figure><h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">fdfs_test client.conf upload 1.txt</div><div class="line">...</div><div class="line">[2018-03-30 23:49:38] DEBUG - base_path=/data/fastDFS/client, connect_timeout=30, network_timeout=60, tracker_server_count=1, anti_steal_token=0, anti_steal_secret_key length=0, use_connection_pool=0, g_connection_pool_max_idle_time=3600s, use_storage_id=0, storage server id count: 0</div><div class="line">storage_upload_by_filename</div><div class="line">group_name=group1, remote_filename=M00/00/00/rBCWJlq8mpKAao5IAE1SKjXnN3o586.txt</div><div class="line">...</div><div class="line">example file url: http://192.168.1.239/group1/M00/00/00/rBCWJlq8mpKAao5IAE1SKjXnN3o586_big.txt</div><div class="line"></div><div class="line">## fdfs_monitor client.conf</div><div class="line">[2018-03-31 01:37:43] DEBUG - base_path=/tmp/fastdfs, connect_timeout=30, network_timeout=60, tracker_server_count=1, anti_steal_token=0, anti_steal_secret_key length=0, use_connection_pool=0, g_connection_pool_max_idle_time=3600s, use_storage_id=0, storage server id count: 0</div><div class="line"></div><div class="line">server_count=1, server_index=0</div><div class="line"></div><div class="line">tracker server is 127.0.0.1:22122</div><div class="line"></div><div class="line">group count: 1</div><div class="line"></div><div class="line">Group 1:</div><div class="line">group name = group1</div><div class="line">disk total space = 98172 MB</div><div class="line">disk free space = 88804 MB</div><div class="line">trunk free space = 0 MB</div><div class="line">storage server count = 2</div><div class="line">active server count = 1</div><div class="line">storage server port = 23000</div><div class="line">storage HTTP port = 8888</div><div class="line">store path count = 2</div><div class="line">subdir count per path = 256</div><div class="line">current write server index = 0</div><div class="line">current trunk file id = 0</div><div class="line"></div><div class="line">Storage 1:</div><div class="line">id = 192.168.1.239</div><div class="line">ip_addr = 192.168.1.239 ACTIVE</div><div class="line">http domain = </div><div class="line">version = 5.11</div><div class="line">join time = 2018-03-31 01:17:30</div><div class="line">...</div><div class="line">Storage 2:</div><div class="line">id = 192.168.1.242</div><div class="line">ip_addr = 192.168.1.242 INIT</div><div class="line">http domain = </div><div class="line">version = 5.05</div><div class="line">join time = 2018-03-31 01:22:23</div><div class="line">...</div></pre></td></tr></table></figure><h2 id="more"><a href="#more" class="headerlink" title="more"></a>more</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">## 删除节点</div><div class="line">fdfs_monitor client.conf delete group2 192.168.1.242</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>RSA</title>
      <link href="/2018/03/09/RSA/"/>
      <url>/2018/03/09/RSA/</url>
      
        <content type="html"><![CDATA[<h2 id="加密方式"><a href="#加密方式" class="headerlink" title="加密方式"></a>加密方式</h2><ul><li><p>对称加密：对称加密是最快速、最简单的一种加密方式，加密（encryption）与解密（decryption）用的是同样的密钥（secret key）。对称加密有很多种算法，由于它效率很高，所以被广泛使用在很多加密协议的核心当中。对称加密通常使用的是相对较小的密钥，一般小于256 bit。因为密钥越大，加密越强，但加密与解密的过程越慢。如果你只用1 bit来做这个密钥，那黑客们可以先试着用0来解密，不行的话就再用1解；但如果你的密钥有1 MB大，黑客们可能永远也无法破解，但加密和解密的过程要花费很长的时间。密钥的大小既要照顾到安全性，也要照顾到效率。对称加密的一大缺点是密钥的管理与分配，换句话说，如何把密钥发送到需要解密你的消息的人的手里是一个问题。在发送密钥的过程中，密钥有很大的风险会被黑客们拦截。现实中通常的做法是将对称加密的密钥进行非对称加密，然后传送给需要它的人。</p></li><li><p>非对称加密：非对称加密为数据的加密与解密提供了一个非常安全的方法，它使用了一对密钥，公钥（public key）和私钥（private key）。私钥只能由一方安全保管，不能外泄，而公钥则可以发给任何请求它的人。非对称加密使用这对密钥中的一个进行加密，而解密则需要另一个密钥。比如，你向银行请求公钥，银行将公钥发给你，你使用公钥对消息加密，那么只有私钥的持有人–银行才能对你的消息解密。与对称加密不同的是，银行不需要将私钥通过网络发送出去，因此安全性大大提高。目前最常用的非对称加密算法是RSA算法。虽然非对称加密很安全，但是和对称加密比起来，它非常的慢，所以我们还是要用对称加密来传送消息，但对称加密所使用的密钥我们可以通过非对称加密的方式发送出去。</p></li></ul><h2 id="RSA算法的作用："><a href="#RSA算法的作用：" class="headerlink" title="RSA算法的作用："></a>RSA算法的作用：</h2><ul><li><p>1、加密：公钥加密私钥解密<br>   主要用于将数据资料加密不被其他人非法获取，保证数据安全性。使用公钥将数据资料加密，只有私钥可以解密。即使密文在网络上被第三方获取由于没有私钥则无法解密。从而保证数据安全性。</p><p>  A在自己电脑上生成RSA钥匙文件，一个私钥文件一个公钥文件，并将他的公钥传送给B。<br>此时B要传送信息给A，于是B用A的公钥加密他的消息，然后传送给A。【网络上传输的密文，没有A的私钥无法解密，其他人获取之后也没用】<br>A用他的私钥解密B的消息。</p></li><li><p>2、认证：私钥加密公钥解密<br>   主要用于身份验证，判断某个身份的真实性。使用私钥加密之后，用对应的公钥解密从而验证身份真实性</p><p>  A要验证B是否是真实用户<br>  B将自己公钥给A<br>  B将文件用自己私钥加密传送给A<br>  A根据B的公钥解密，如果成功则为真实身份用户</p></li></ul><h2 id="RSA加密、认证"><a href="#RSA加密、认证" class="headerlink" title="RSA加密、认证"></a>RSA加密、认证</h2><p><img src="/2018/03/09/RSA/./RSA.png" alt=""></p><h2 id="公钥与私钥使用场景"><a href="#公钥与私钥使用场景" class="headerlink" title="公钥与私钥使用场景"></a>公钥与私钥使用场景</h2><ul><li><p>(1)私钥用来进行解密和签名，是给自己用的。</p></li><li><p>(2)公钥由本人公开，用于加密和验证签名，是给别人用的。</p></li><li><p>(3)当该用户发送文件时，用私钥签名，别人用他给的公钥验证签名，可以保证该信息是由他发送的。当该用户接受文件时，别人用他的公钥加密，他用私钥解密，可以保证该信息只能由他接收到。</p></li></ul><p><a href="https://zh.wikipedia.org/zh-cn/RSA加密演算法" target="_blank" rel="external">https://zh.wikipedia.org/zh-cn/RSA加密演算法</a></p>]]></content>
      
      
      <categories>
          
          <category> security </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Port Knocking</title>
      <link href="/2018/02/05/Port-Knocking/"/>
      <url>/2018/02/05/Port-Knocking/</url>
      
        <content type="html"><![CDATA[<h2 id="Port-Knocking"><a href="#Port-Knocking" class="headerlink" title="Port Knocking"></a>Port Knocking</h2><ul><li><p>适用于需要访问不向公众开放的服务器的用户。服务器可以关闭所有端口，直到用户提供一个秘密的敲门序列 （序列很容易实现，而且需要的资源不多）。<br>打开秘密端口之后，应用常用的安全机制（比如密码或证书）。只需在防火墙级上提供一个额外的安全层，需要秘密端口的所有服务就会正常工作。<br>这种方法的要点在于关闭所有端口并监视外部连接尝试。当识别出预定义的尝试序列（称为敲门序列 ）时，可以执行打开端口等操作，让外部的用户能够进来。敲门序列的复杂程度由您决定，从简单的列表（比如依次尝试 TCP 端口 7000、UDP 端口 7100 和 TCP 端口 7200）到一次性序列集合都可以。（按密码学术语来说，一次性序列与 “一次一密” 相似，这是已知最安全的加密方法。）外面的用户必须知道使用 SSH 所需的端口号和密码，还必须知道打开端口并启用密码所需的敲门序列。如果没有这个序列，连接尝试就会静悄悄地失败。</p></li><li><p>wiki: <a href="https://en.wikipedia.org/wiki/Port_knocking" target="_blank" rel="external">https://en.wikipedia.org/wiki/Port_knocking</a></p></li></ul><h2 id="Set-Port-Knocking-With-Knockd-and-Iptables"><a href="#Set-Port-Knocking-With-Knockd-and-Iptables" class="headerlink" title="Set Port Knocking With Knockd and Iptables"></a>Set Port Knocking With Knockd and Iptables</h2><p>home page: <a href="http://www.zeroflux.org/projects/knock" target="_blank" rel="external">http://www.zeroflux.org/projects/knock</a></p><h2 id="BUILDING"><a href="#BUILDING" class="headerlink" title="BUILDING"></a>BUILDING</h2><ul><li>To build knockd, make sure you have libpcap and the autoconf tools installed. Then run the following:<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">autoreconf -fi</div><div class="line">./configure --prefix=/usr/local</div><div class="line">make</div><div class="line">sudo make install</div></pre></td></tr></table></figure></li></ul><h2 id="Configurations"><a href="#Configurations" class="headerlink" title="Configurations"></a>Configurations</h2><p>/etc/knockd.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[options]</div><div class="line">    logfile = /var/log/knockd.log</div><div class="line"></div><div class="line">[opencloseSSH]</div><div class="line">  sequence = 2222:udp,3333:tcp,4444:udp</div><div class="line">  seq_timeout = 5</div><div class="line">  tcpflags = syn</div><div class="line">  start_command = /sbin/iptables -I INPUT -s %IP% -p tcp --dport 22 -j ACCEPT</div><div class="line">  cmd_timeout = 10</div><div class="line">  stop_command = /sbin/iptables -D INPUT -s %IP% -p tcp --dport 22 -j ACCEPT</div></pre></td></tr></table></figure></p><p>/etc/default/knockd<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">START_KNOCKD=1</div><div class="line">KNOCKD_OPTS=&quot;-i eth0&quot;</div></pre></td></tr></table></figure></p><h2 id="start-amp-test"><a href="#start-amp-test" class="headerlink" title="start &amp; test"></a>start &amp; test</h2><p>knockd -d -c /etc/knockd.conf</p><p>open port<br><img src="/2018/02/05/Port-Knocking/./pic0.png" alt=""></p><p>close port<br><img src="/2018/02/05/Port-Knocking/./pic2.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> security </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Krypton</title>
      <link href="/2018/01/08/Krypton/"/>
      <url>/2018/01/08/Krypton/</url>
      
        <content type="html"><![CDATA[<video autoplay loop playsinline="" muted style="width: 100%; height: 100%;"><br>    <source src="https://krypt.co/static/dist/img/demo_final.mp4" type="video/mp4"><br></video><h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ldd --version &gt; 2.14</div><div class="line">yum -y install curl yum-utils</div><div class="line"></div><div class="line">curl https://krypt.co/kr | sh</div></pre></td></tr></table></figure><h2 id="add-pub-key"><a href="#add-pub-key" class="headerlink" title="add pub key"></a>add pub key</h2><p>kr pair</p><p>kr add xy@192.168.1.126</p><h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><p>ssh xy@192.168.1.126<br><img src="/2018/01/08/Krypton/./pic0.png" alt=""></p><h2 id="phone-apps"><a href="#phone-apps" class="headerlink" title="phone apps"></a>phone apps</h2><p><img src="/2018/01/08/Krypton/./pic1.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> security </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ntop</title>
      <link href="/2017/12/03/ntop/"/>
      <url>/2017/12/03/ntop/</url>
      
        <content type="html"><![CDATA[<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">cd /etc/yum.repos.d/</div><div class="line">wget http://packages.ntop.org/centos-stable/ntop.repo -O ntop.repo</div><div class="line">wget http://packages.ntop.org/centos-stable/epel-6.repo -O epel.repo</div><div class="line">wget https://copr.fedoraproject.org/coprs/saltstack/zeromq4/repo/epel-6/saltstack-zeromq4-epel-6.repo</div><div class="line">rpm -ivh http://packages.ntop.org/rpm6/extra/hiredis-0.10.1-3.el6.x86_64.rpm http://packages.ntop.org/rpm6/extra/hiredis-devel-0.10.1-3.el6.x86_64.rpm</div><div class="line"></div><div class="line">yum erase zeromq3 ## (Do this once to make sure zeromq3 is not installed)</div><div class="line">yum install pfring n2disk nprobe ntopng ntopng-data cento</div><div class="line"></div><div class="line">yum install ntop</div></pre></td></tr></table></figure><h2 id="run-ntopNG"><a href="#run-ntopNG" class="headerlink" title="run ntopNG"></a>run ntopNG</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">## https://www.ntop.org/products/traffic-analysis/ntop/</div><div class="line"></div><div class="line">nprobe -i bond0 --zmq tcp://192.168.122.122:5556</div><div class="line">ntopng -i tcp://192.168.122.122:5556</div><div class="line"></div><div class="line">ntop manually</div><div class="line">/etc/init.d/ntop start</div><div class="line"></div><div class="line">http://localhost:3000</div></pre></td></tr></table></figure><p><img src="/2017/12/03/ntop/./pic0.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>MasterPassword</title>
      <link href="/2017/11/25/MasterPassword/"/>
      <url>/2017/11/25/MasterPassword/</url>
      
        <content type="html"><![CDATA[<video autoplay controls loop playsinline="" style="width: 100%; height: 100%;"><br><source src="https://masterpassword.app/vid/about.webm" type="video/webm; codecs=vp8,vorbis"><br><source src="https://masterpassword.app/vid/about.mp4" type="video/mp4"><br><source src="https://masterpassword.app/vid/about.ogv" type="video/ogg; codecs=theora,vorbis"><br></video><p>Homepage:     <a href="http://masterpasswordapp.com/" target="_blank" rel="external">http://masterpasswordapp.com/</a><br>git:                  <a href="https://github.com/Lyndir/MasterPassword" target="_blank" rel="external">https://github.com/Lyndir/MasterPassword</a></p><h2 id="Master-Password"><a href="#Master-Password" class="headerlink" title="Master Password"></a>Master Password</h2><pre><code>Master Password is a completely new way of thinking about passwords.It consists of an algorithm that implements the core idea and applications for various platforms making the alogirthm available to users on a variety of devices and platforms.To skip the intro and go straight to the information on how to use the code, click here.Master Password is available for :calling: iOS, :desktop_computer: macOS, :calling: Android, :desktop_computer: Desktop, and ⌨ Console.Master Password is also available from the following package managers: macOS: Homebrew (brew install mpw). Get in touch if you are interested in adding Master Password to any other package managers.There are many reasons for using Master Password instead of an ordinary password manager, read below for the details, but if you want my personal favourites, they would be:I don&apos;t need to worry about keeping backups of my countless authentication credentials.I don&apos;t need to worry that when I travel, I might not have access to my passwords vault.I don&apos;t need to trust an external party, proprietary code or a service to be online and stay online.If I feel at risk of my device being stolen or confiscated, I can set a fake master password, delete my user or wipe it worry-free.We also have a Frequently Asked Questions.</code></pre><h2 id="use"><a href="#use" class="headerlink" title="use"></a>use</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">mpw -u USER -P -p SITENAME -m &lt;&lt; EOF</div><div class="line">PASSWORD</div><div class="line">EOF</div><div class="line"></div><div class="line">USER&apos;s password for SITENAME:</div><div class="line">[]: Haqx6)ForaBoku</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> security </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux I/O Scheduler</title>
      <link href="/2017/11/22/Linux-I-O-Scheduler/"/>
      <url>/2017/11/22/Linux-I-O-Scheduler/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Linux I/O 调度器是Linux内核中的一个组成部分，用户可以通过调整这个调度器来优化系统性能。本文首先介绍Linux I/O 调度器的结构，然后介绍如何根据不同的存储器来设置Linux I/O 调度器从而达到优化系统性能。</p><h2 id="Linux-I-O-系统简介"><a href="#Linux-I-O-系统简介" class="headerlink" title="Linux I/O 系统简介"></a>Linux I/O 系统简介</h2><p>Linux I/O调度器(Linux I/O Scheduler)是LinuxI/O体系的一个组件，它介于通用块层和块设备驱动程序之间。如图 1 所示。</p><p>图1 Linux I/O调度器介于通用块层和块设备驱动程序之间<br><img src="/2017/11/22/Linux-I-O-Scheduler/./pic0.png" alt=""></p><p>当Linux内核组件要读写一些数据时，并不是请求一发出，内核便立即执行该请求，而是将其推迟执行。当传输一个新数据块时，内核需要检查它能否通过。Linux IO调度程序是介于通用块层和块设备驱动程序之间，所以它接收来自通用块层的请求，试图合并请求，并找到最合适的请求下发到块设备驱动程序中。之后块设备驱动程序会调用一个函数来响应这个请求。</p><h2 id="Linux整体I-O体系可以分为七层，它们分别是："><a href="#Linux整体I-O体系可以分为七层，它们分别是：" class="headerlink" title="Linux整体I/O体系可以分为七层，它们分别是："></a>Linux整体I/O体系可以分为七层，它们分别是：</h2><ul><li><p>VFS虚拟文件系统：内核要跟多种文件系统打交道，内核抽象了这VFS，专门用来适配各种文件系统，并对外提供统一操作接口。</p></li><li><p>磁盘缓存：磁盘缓存是一种将磁盘上的一些数据保留着RAM中的软件机制，这使得对这部分数据的访问可以得到更快的响应。磁盘缓存在Linux中有三种类型：Dentry cache ，Page cache ， Buffer cache。</p></li><li><p>映射层：内核从块设备上读取数据，这样内核就必须确定数据在物理设备上的位置，这由映射层(Mapping Layer)来完成。</p></li><li><p>通用块层：由于绝大多数情况的I/O操作是跟块设备打交道，所以Linux在此提供了一个类似vfs层的块设备操作抽象层。下层对接各种不同属性的块设备，对上提供统一的Block IO请求标准。</p></li><li><p>I/O调度层：大多数的块设备都是磁盘设备，所以有必要根据这类设备的特点以及应用特点来设置一些不同的调度器。</p></li><li><p>块设备驱动：块设备驱动对外提供高级的设备操作接口。</p></li><li><p>物理硬盘：这层就是具体的物理设备。</p></li></ul><h2 id="5种类型的Linux-I-O调度器"><a href="#5种类型的Linux-I-O调度器" class="headerlink" title="5种类型的Linux I/O调度器"></a>5种类型的Linux I/O调度器</h2><p>Linux 从2.4内核开始支持I/O调度器,到目前为止有5种类型：Linux 2.4内核的 Linus Elevator、Linux 2.6内核的 Deadline、 Anticipatory、 CFQ、 Noop，其中Anticipatory从Linux 2.6.33版本后被删除了。目前主流的Linux发行版本使用Deadline、 CFQ、 Noop三种I/O调度器。下面依次简单介绍：</p><ul><li><p>Linus Elevator</p><p>  在2.4 内核中它是第一种I/O调度器。它的主要作用是为每个设备维护一个查询请求，当内核收到一个新请求时，如果能合并就合并。如果不能合并，就会尝试排序。如果既不能合并，也没有合适的位置插入，就放到请求队列的最后。</p></li><li><p>Anticipatory</p><p>  Anticipatory的中文含义是”预料的，预想的”，顾名思义有个I/O发生的时候，如果又有进程请求I/O操作，则将产生一个默认的6毫秒猜测时间，猜测下一个进程请求I/O是要干什么的。这个I/O调度器对读操作优化服务时间，在提供一个I/O的时候进行短时间等待，使进程能够提交到另外的I/O。Anticipatory算法从Linux 2.6.33版本后被删除了，因为使用CFQ通过配置也能达到Anticipatory的效果。</p></li><li><p>DeadLine</p><p>  Deadline翻译成中文是截止时间调度器，是对Linus Elevator的一种改进，它避免有些请求太长时间不能被处理。另外可以区分对待读操作和写操作。DEADLINE额外分别为读I/O和写I/O提供了FIFO队列。Deadline的工作流程如图 2 所示。</p></li></ul><p>图2 Deadline的工作流程<br><img src="/2017/11/22/Linux-I-O-Scheduler/./pic1.png" alt=""></p><ul><li><p>CFQ</p><p>  CFQ全称Completely Fair Scheduler ，中文名称完全公平调度器，它是现在许多 Linux 发行版的默认调度器，CFQ是内核默认选择的I/O调度器。它将由进程提交的同步请求放到多个进程队列中，然后为每个队列分配时间片以访问磁盘。对于通用的服务器是最好的选择,CFQ均匀地分布对I/O带宽的访问。CFQ为每个进程和线程,单独创建一个队列来管理该进程所产生的请求,以此来保证每个进程都能被很好的分配到I/O带宽，I/O调度器每次执行一个进程的4次请求。该算法的特点是按照I/O请求的地址进行排序，而不是按照先来后到的顺序来进行响应。简单来说就是给所有同步进程分配时间片，然后才排队访问磁盘，CFQ的工作流程如图 3 所示 。</p></li></ul><p>图3 CFQ的工作流程<br><img src="/2017/11/22/Linux-I-O-Scheduler/./pic2.png" alt=""></p><ul><li><p>NOOP</p><p>  NOOP全称No Operation,中文名称电梯式调度器，该算法实现了最简单的FIFO队列，所有I/O请求大致按照先来后到的顺序进行操作。NOOP实现了一个简单的FIFO队列,它像电梯的工作主法一样对I/O请求进行组织。它是基于先入先出(FIFO)队列概念的 Linux 内核里最简单的I/O 调度器。此调度程序最适合于固态硬盘。</p></li></ul><h3 id="I-O调度器的选择"><a href="#I-O调度器的选择" class="headerlink" title="I/O调度器的选择"></a>I/O调度器的选择</h3><p>目前主流Linux发行版本使用三种I/O调度器：DeadLine、CFQ、NOOP，通常来说Deadline适用于大多数环境,特别是写入较多的文件服务器，从原理上看，DeadLine是一种以提高机械硬盘吞吐量为思考出发点的调度算法，尽量保证在有I/O请求达到最终期限的时候进行调度，非常适合业务比较单一并且I/O压力比较重的业务，比如Web服务器，数据库应用等。CFQ 为所有进程分配等量的带宽,适用于有大量进程的多用户系统，CFQ是一种比较通用的调度算法，它是一种以进程为出发点考虑的调度算法，保证大家尽量公平,为所有进程分配等量的带宽,适合于桌面多任务及多媒体应用。NOOP 对于闪存设备和嵌入式系统是最好的选择。对于固态硬盘来说使用NOOP是最好的，DeadLine次之，而CFQ效率最低。</p><p>查看Linux系统的 I/O调度器</p><p>查看Linux系统的I/O调度器一般分成两个部分，一个是查看Linux系统整体使用的I/O调度器，另一个是查看某磁盘使用的I/O调度器。</p><p>查看当前系统支持的I/O调度器，使用如下命令：</p><h2 id="查看当前系统支持的I-O调度器"><a href="#查看当前系统支持的I-O调度器" class="headerlink" title="查看当前系统支持的I/O调度器"></a>查看当前系统支持的I/O调度器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">dmesg | grep -i scheduler</div><div class="line">[    1.508820] io scheduler noop registered</div><div class="line">[    1.508827] io scheduler deadline registered</div><div class="line">[    1.508850] io scheduler cfq registered (default)</div></pre></td></tr></table></figure><h2 id="查看一个硬盘使用的I-O调度器"><a href="#查看一个硬盘使用的I-O调度器" class="headerlink" title="查看一个硬盘使用的I/O调度器"></a>查看一个硬盘使用的I/O调度器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cat /sys/block/sda/queue/scheduler</div><div class="line">noop deadline [cfq]</div><div class="line">#显示当前使用的调度器是cfq</div></pre></td></tr></table></figure><h2 id="修改Linux系统的-I-O调度器"><a href="#修改Linux系统的-I-O调度器" class="headerlink" title="修改Linux系统的 I/O调度器"></a>修改Linux系统的 I/O调度器</h2><p>修改Linux系统的 I/O调度器有三种方法，分别是使用shell命令、使用grubby命令或者修改grub配置文件。下面依次介绍：</p><p>shell<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">echo noop &gt; /sys/block/sdb/queue/scheduler</div><div class="line">#把noop设置为一个磁盘的I/O调度器，你可以随时更改而无需重启计算机。</div></pre></td></tr></table></figure></p><p>grubby<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">永久修改默认的I/O调度器</div><div class="line">通过设置内核加载参数, 这样当机器重启的时候，系统自动把所有设备的 I/O调度器变成 DeadLine 。</div></pre></td></tr></table></figure></p><p>使用编辑器修改配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">vi cat /etc/default/grub</div><div class="line">#修改第五行，在行尾添加#</div><div class="line">elevator= cfq</div><div class="line">#然后保存文件，重新编译配置文件，</div><div class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</div><div class="line"></div><div class="line">重新启动计算机系统即可。</div></pre></td></tr></table></figure></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Linux I/O调度器是 Linux 内核中的一个组成部分，用户可以通过根据不同的存储器来设置 Linux I/O 调度器从而达到优化系统性能。 一般来说 NOOP 调度器最适合于固态硬盘，DeadLine 调度器适用于写入较多的文件服务器，比如Web服务器，数据库应用等，而CFQ 调度器适合于桌面多任务及媒体应用。</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> knowledge </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jenkins</title>
      <link href="/2017/11/17/jenkins/"/>
      <url>/2017/11/17/jenkins/</url>
      
        <content type="html"><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">java -version</div><div class="line">java version &quot;1.8.0_144&quot;</div><div class="line">Java(TM) SE Runtime Environment (build 1.8.0_144-b01)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)</div><div class="line">## jdk &gt; 1.8</div><div class="line"></div><div class="line">wget http://mirrors.jenkins.io/war-stable/2.73.1/jenkins.war</div><div class="line">java -jar jenkins.war --httpPort=7000</div></pre></td></tr></table></figure><h2 id="权限管理"><a href="#权限管理" class="headerlink" title="权限管理"></a>权限管理</h2><p>配置授权方式为’Role-Based Stategy’<br><img src="/2017/11/17/jenkins/./pic0.png" alt=""></p><p>管理角色<br><img src="/2017/11/17/jenkins/./pic1.png" alt=""><br><img src="/2017/11/17/jenkins/./pic2.png" alt=""></p><p>分配角色<br><img src="/2017/11/17/jenkins/./pic3.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>clamav</title>
      <link href="/2017/10/13/clamav/"/>
      <url>/2017/10/13/clamav/</url>
      
        <content type="html"><![CDATA[<h2 id="Install-clamav"><a href="#Install-clamav" class="headerlink" title="Install clamav"></a>Install clamav</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">sudo apt install clamav</div><div class="line"></div><div class="line">#在线升级病毒库</div><div class="line">freshclam</div><div class="line"></div><div class="line">#离线升级病毒库</div><div class="line">cd /var/lib/clamav</div><div class="line">wget -c http://database.clamav.net/main.cvd</div></pre></td></tr></table></figure><h2 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">clamscan -r /home</div><div class="line">#扫描所有用户的主目录就使用</div><div class="line"></div><div class="line">clamscan -r /</div><div class="line">#扫描您计算机上的所有文件并且显示所有的文件的扫描结果</div><div class="line"></div><div class="line">clamscan -r --bell -i /</div><div class="line">#扫描您计算机上的所有文件并且显示有问题的文件的扫描结果</div><div class="line"></div><div class="line">clamscan -r --bell -i /home</div><div class="line">/home/xy/sogou_pinyin_72m_dsn.exe: Win.Trojan.Agent-1267520 FOUND</div><div class="line">/home/xy/win.exe: Win.Trojan.5691975-1 FOUND</div><div class="line"></div><div class="line">----------- SCAN SUMMARY -----------</div><div class="line">Known viruses: 4566249</div><div class="line">Engine version: 0.99.2</div><div class="line">Scanned directories: 2306</div><div class="line">Scanned files: 23658</div><div class="line">Infected files: 2</div><div class="line">Total errors: 10</div><div class="line">Data scanned: 1681.83 MB</div><div class="line">Data read: 131779.84 MB (ratio 0.01:1)</div><div class="line">Time: 91.304 sec (1 m 31 s)</div></pre></td></tr></table></figure><h2 id="GUI"><a href="#GUI" class="headerlink" title="GUI"></a>GUI</h2><p>sudo apt install clamtk</p><p><img src="/2017/10/13/clamav/./pic0.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> security </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>MySQL大表删除技巧 [转]</title>
      <link href="/2017/10/11/mysql-del/"/>
      <url>/2017/10/11/mysql-del/</url>
      
        <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在生产环境有可能有删除某个不重要大表的需求，因为大表占用的大量磁盘空间，如果我们直接drop掉此表，通常需要20秒以上的时间，总会觉得会卡主MySQL，现在给大家一个正确的删除方法。</p><h3 id="首先我们查看此大表"><a href="#首先我们查看此大表" class="headerlink" title="首先我们查看此大表"></a>首先我们查看此大表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">shell&gt;ls log_api_call_01_01* -l</div><div class="line">-rw-r----- 1 mysql mysql 9362 Jun 22 15:35 log_api_call_01_01.frm</div><div class="line">-rw-r----- 1 mysql mysql 293334036112 Jun 22 15:38 log_api_call_01_01.ibd</div><div class="line">shell&gt;ln log_api_call_01_01.ibd log_api_call_01_01ibd.bak</div><div class="line">shell&gt;ls log_api_call_01_01* -l</div><div class="line">-rw-rw—- 1 MySQL mysql 9362 Apr 14 23:03 log_api_call_01_01.frm</div><div class="line">-rw-r----- 1 mysql mysql 293334036112 Jun 22 15:38 log_api_call_01_01.ibd</div><div class="line">-rw-r----- 1 mysql mysql 293334036112 Jun 22 15:38 log_api_call_01_01.ibd.bak</div><div class="line">mysql&gt;drop table log_api_call_01_01;</div><div class="line">Query Ok, 0 rows affacted(0.92 sec)</div></pre></td></tr></table></figure><p>通过这样的操作，可以减少mysql drop大表hang住的时间，然后在业务低峰期再去删除真实的那个<em>.b文</em>.bak件。</p><h3 id="原理"><a href="#原理" class="headerlink" title="原理:"></a>原理:</h3><p>就是利用OS HARD LINK的原理,<br>当多个文件名同时指向同一个INODE时,这个INODE的引用数N&gt;1, 删除其中任何一个文件名都会很快.<br>因为其直接的物理文件块没有被删除.只是删除了一个指针而已;<br>当INODE的引用数N=1时, 删除文件需要去把这个文件相关的所有数据块清除,所以会比较耗时;</p><h3 id="Tips："><a href="#Tips：" class="headerlink" title="Tips："></a>Tips：</h3><p>先用rename table替代drop table<br>mysql&gt; rename table log_api_call_01_01 to log_api_call_01_01_bak;<br>这个动作也很快只是相当于改一个文件名。<br>另外也可以考虑使用XFS文件系统，对于Drop表动作也比较快</p>]]></content>
      
      
      <categories>
          
          <category> db </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ELK with x-pack</title>
      <link href="/2017/09/16/ELK-x-pack/"/>
      <url>/2017/09/16/ELK-x-pack/</url>
      
        <content type="html"><![CDATA[<h2 id="Install-x-pack"><a href="#Install-x-pack" class="headerlink" title="Install x-pack"></a>Install x-pack</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/usr/share/elasticsearch/bin/elasticsearch-plugin install x-pack</div><div class="line">/etc/init.e/elasticsearch restart</div><div class="line"></div><div class="line">/usr/share/kibana/bin/kibana-plugin install x-pack</div><div class="line">/etc/init.d/kibana restart</div><div class="line"></div><div class="line">/usr/share/logstash/bin/logstash-plugin install x-pack</div><div class="line">initctl restart logstash</div><div class="line"></div><div class="line">User:       elastic</div><div class="line">Password:   changeme</div></pre></td></tr></table></figure><h2 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h2><p><img src="/2017/09/16/ELK-x-pack/./pic0.png" alt=""></p><p><img src="/2017/09/16/ELK-x-pack/./pic1.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
            <tag> log </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Xware</title>
      <link href="/2017/09/06/Xware/"/>
      <url>/2017/09/06/Xware/</url>
      
        <content type="html"><![CDATA[<h2 id="Add-user"><a href="#Add-user" class="headerlink" title="Add user"></a>Add user</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">useradd -m thunder</div><div class="line">su thunder</div><div class="line">mkdir -p $HOME/thunder /media/thunder</div><div class="line">chmod 777 $HOME/thunder</div><div class="line">sudo mount --bind $HOME/thunder /media/thunder</div></pre></td></tr></table></figure><h2 id="Running-server"><a href="#Running-server" class="headerlink" title="Running server"></a>Running server</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">shell&gt; ./portal</div><div class="line">try stopping xunlei service first...</div><div class="line">killall: ETMDaemon: no process killed</div><div class="line">killall: EmbedThunderManager: no process killed</div><div class="line">killall: vod_httpserver: no process killed</div><div class="line">setting xunlei runtime env...</div><div class="line">port: 9000 is usable.</div><div class="line"></div><div class="line">YOUR CONTROL PORT IS: 9000</div><div class="line"></div><div class="line">starting xunlei service...</div><div class="line">etm path: /home/thunder/Xware</div><div class="line">execv: /home/thunder/Xware/lib/ETMDaemon.</div><div class="line"></div><div class="line">getting xunlei service info...</div><div class="line">Connecting to 127.0.0.1:9000 (127.0.0.1:9000)</div><div class="line"></div><div class="line">THE ACTIVE CODE IS: enpgbe</div><div class="line"></div><div class="line">go to http://yuancheng.xunlei.com, bind your device with the active code.</div><div class="line">finished.</div></pre></td></tr></table></figure><h2 id="Bind-device"><a href="#Bind-device" class="headerlink" title="Bind device"></a>Bind device</h2><p><img src="/2017/09/06/Xware/./pic0.png" alt="pic"></p><p><img src="/2017/09/06/Xware/./pic1.png" alt="pic"></p><p><img src="/2017/09/06/Xware/./pic2.png" alt="pic"></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>KVM with XP hardware drives</title>
      <link href="/2017/09/01/kvm-xp/"/>
      <url>/2017/09/01/kvm-xp/</url>
      
        <content type="html"><![CDATA[<h2 id="XP-hardware"><a href="#XP-hardware" class="headerlink" title="XP hardware"></a>XP hardware</h2><pre><code>device model:virtiosound ac97</code></pre><h2 id="drive"><a href="#drive" class="headerlink" title="drive"></a>drive</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget -c https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.126-2/virtio-win-0.1.126.iso</div></pre></td></tr></table></figure><h2 id="virtual-disk"><a href="#virtual-disk" class="headerlink" title="virtual disk"></a>virtual disk</h2><p><img src="/2017/09/01/kvm-xp/./pic0.png" alt=""></p><h2 id="install-drive"><a href="#install-drive" class="headerlink" title="install drive"></a>install drive</h2><p><img src="/2017/09/01/kvm-xp/./pic1.png" alt=""></p><p><img src="/2017/09/01/kvm-xp/./pic2.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> virtualization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kvm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Supervisor</title>
      <link href="/2017/08/22/supervisor/"/>
      <url>/2017/08/22/supervisor/</url>
      
        <content type="html"><![CDATA[<h2 id="supervisor"><a href="#supervisor" class="headerlink" title="supervisor"></a>supervisor</h2><p>supervisor是以Python开发的一套通用的进程管理程序，能将一个普通的命令行进程变为后台daemon，并监控进程状态，异常退出时能自动重启。</p><h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">yum install epel-release</div><div class="line">yum install supervisor</div><div class="line"></div><div class="line">cp -a /etc/supervisor/supervisord.conf&#123;,.bak&#125;</div><div class="line">echo_supervisord_conf &gt; /etc/supervisor/supervisord.conf</div><div class="line">sed -i s@/tmp@/etc/supervisor@g /etc/supervisor/supervisord.conf</div><div class="line"></div><div class="line">echo &apos;[include]</div><div class="line">files = /etc/supervisor/conf.d/*.conf&apos; &gt;&gt; /etc/supervisor/supervisord.conf</div></pre></td></tr></table></figure><h2 id="etc-supervisor-conf-d-mysql-5-6-conf"><a href="#etc-supervisor-conf-d-mysql-5-6-conf" class="headerlink" title="/etc/supervisor/conf.d/mysql_5.6.conf"></a>/etc/supervisor/conf.d/mysql_5.6.conf</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[program:mysql_5.6]</div><div class="line">command=/data/mysql-5.6.37-linux-glibc2.12-x86_64/bin/mysqld_safe --defaults-file=./my.cnf</div><div class="line">directory=/data/mysql-5.6.37-linux-glibc2.12-x86_64</div><div class="line">user=xy</div><div class="line">autostart=true</div><div class="line">autorestart=true</div><div class="line">startsecs=3</div><div class="line">redirect_stderr=/data/logs/mysql-5.6.37.err</div><div class="line">stdout_logfile=/data/logs/mysql-5.6.37.log</div><div class="line">stdout_logfile_maxbytes=10MB</div></pre></td></tr></table></figure><h2 id="web-gui"><a href="#web-gui" class="headerlink" title="web gui"></a>web gui</h2><p>/etc/init.d/supervisor start<br>localhost:9001<br><img src="/2017/08/22/supervisor/./pic0.png" alt=""></p><p><img src="/2017/08/22/supervisor/./pic1.png" alt=""></p><p>注：supervisor还有许多选项，具体请参考supervisor文档<br><a href="http://supervisord.org/configuration.html" target="_blank" rel="external">http://supervisord.org/configuration.html</a></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> supervisor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IP Tunnel</title>
      <link href="/2017/08/22/ip-tunnel/"/>
      <url>/2017/08/22/ip-tunnel/</url>
      
        <content type="html"><![CDATA[<h2 id="IP隧道技术"><a href="#IP隧道技术" class="headerlink" title="IP隧道技术"></a>IP隧道技术</h2><p>是路由器把一种网络层协议封装到另一个协议中以跨过网络传送到另一个路由器的处理过程。IP 隧道（IPtunneling）是将一个IP报文封装在另一个IP报文的技术，这可以使得目标为一个IP地址的数据报文能被封装和转发到另一个IP地址。IP隧道技术亦称为IP封装技术（IP encapsulation）。IP隧道主要用于移动主机和虚拟私有网络（Virtual Private Network），在其中隧道都是静态建立的，隧道一端有一个IP地址，另一端也有唯一的IP地址。移动IPv4主要有三种隧道技术，它们分别是：IP in IP、最小封装以及通用路由封装。更多信息可以参看百度百科：IP隧道 和 隧道技术 。 Linux系统内核实现的IP隧道技术主要有三种（PPP、PPTP和L2TP等协议或软件不是基于内核模块的）：ipip、gre、sit 。这三种隧道技术都需要内核模块 tunnel4.ko 的支持。 </p><ol><li>ipip 需要内核模块 ipip.ko ，该方式最为简单！但是你不能通过IP-in-IP隧道转发广播或者IPv6数据包。你只是连接了两个一般情况下无法直接通讯的IPv4网络而已。至于兼容性，这部分代码已经有很长一段历史了，它的兼容性可以上溯到1.3版的内核。据网上查到信息，Linux的IP-in-IP隧道不能与其他操作系统或路由器互相通讯。它很简单，也很有效。</li><li>GRE 需要内核模块 ip_gre.ko ，GRE是最初由CISCO开发出来的隧道协议，能够做一些IP-in-IP隧道做不到的事情。比如，你可以使用GRE隧道传输多播数据包和IPv6数据包。</li><li>sit 作用是连接 ipv4 与 ipv6 的网络。个人感觉不如gre使用广泛 。</li></ol><p><img src="/2017/08/22/ip-tunnel/./pic0.png" alt="map"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">PC1</div><div class="line">wan: 192.168.122.1</div><div class="line">lan: 172.16.95.1</div><div class="line"></div><div class="line">PC2</div><div class="line">wan: 192.168.122.122</div><div class="line">lan: 172.17.42.1</div><div class="line">## 192.168.122.0/24网段，用于模拟外网,实际环境保证互通性即可。</div></pre></td></tr></table></figure><h2 id="192-168-122-1"><a href="#192-168-122-1" class="headerlink" title="192.168.122.1"></a>192.168.122.1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</div><div class="line">modprobe ip_gre</div><div class="line"></div><div class="line">ip tunnel add GRE1 mode gre local 192.168.122.1 remote 192.168.122.122 ttl 255</div><div class="line">ip addr add 10.10.10.10 dev GRE1 peer 10.10.10.20/32</div><div class="line">ip link set dev GRE1 up</div><div class="line"></div><div class="line">ip route add 172.17.42.0/24 dev GRE1</div></pre></td></tr></table></figure><h2 id="192-168-122-122"><a href="#192-168-122-122" class="headerlink" title="192.168.122.122"></a>192.168.122.122</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</div><div class="line">modprobe ip_gre</div><div class="line"></div><div class="line">ip tunnel add GRE1 mode gre local 192.168.122.122 remote 192.168.122.1 ttl 255</div><div class="line">ip addr add 10.10.10.20 dev GRE1 peer 10.10.10.10/32</div><div class="line">ip link set dev GRE1 up</div><div class="line"></div><div class="line">ip route add 172.16.95.0/24 dev GRE1</div></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> tunnel </tag>
            
            <tag> ip_gre </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>bond</title>
      <link href="/2017/08/12/bond/"/>
      <url>/2017/08/12/bond/</url>
      
        <content type="html"><![CDATA[<h2 id="bond"><a href="#bond" class="headerlink" title="bond"></a>bond</h2><blockquote><p>像Samba、Nfs这种共享文件系统，网络的吞吐量非常大，就造成网卡的压力很大，网卡bond是通过把多个物理网卡绑定为一个逻辑网卡，实现本地网卡的冗余，带宽扩容和负载均衡，具体的功能取决于采用的哪种模式。</p></blockquote><h2 id="bond的七种模式介绍"><a href="#bond的七种模式介绍" class="headerlink" title="bond的七种模式介绍"></a>bond的七种模式介绍</h2><ol><li><p>mode=0(balance-rr)(平衡抡循环策略)</p><p>链路负载均衡，增加带宽，支持容错，一条链路故障会自动切换正常链路。交换机需要配置聚合口，思科叫port channel。</p><p>特点：传输数据包顺序是依次传输（即：第1个包走eth0，下一个包就走eth1….一直循环下去，直到最后一个传输完毕），此模式提供负载平衡和容错能力；但是我们知道如果一个连接或者会话的数据包从不同的接口发出的话，中途再经过不同的链路，在客户端很有可能会出现数据包无序到达的问题，而无序到达的数据包需要重新要求被发送，这样网络的吞吐量就会下降</p></li><li><p>mode=1(active-backup)(主-备份策略)</p><p> 这个是主备模式，只有一块网卡是active，另一块是备用的standby，所有流量都在active链路上处理，交换机配置的是捆绑的话将不能工作，因为交换机往两块网卡发包，有一半包是丢弃的。</p><p> 特点：只有一个设备处于活动状态，当一个宕掉另一个马上由备份转换为主设备。mac地址是外部可见得，从外面看来，bond的MAC地址是唯一的，以避免switch(交换机)发生混乱。此模式只提供了容错能力；由此可见此算法的优点是可以提供高网络连接的可用性，但是它的资源利用率较低，只有一个接口处于工作状态，在有 N 个网络接口的情况下，资源利用率为1/N</p></li><li><p>mode=2(balance-xor)(平衡策略)</p><p> 表示XOR Hash负载分担，和交换机的聚合强制不协商方式配合。（需要xmit_hash_policy，需要交换机配置port channel）</p><p> 特点：基于指定的传输HASH策略传输数据包。缺省的策略是：(源MAC地址 XOR 目标MAC地址) % slave数量。其他的传输策略可以通过xmit_hash_policy选项指定，此模式提供负载平衡和容错能力</p></li><li><p>mode=3(broadcast)(广播策略)<br> 表示所有包从所有网络接口发出，这个不均衡，只有冗余机制，但过于浪费资源。此模式适用于金融行业，因为他们需要高可靠性的网络，不允许出现任何问题。需要和交换机的聚合强制不协商方式配合。</p><p> 特点：在每个slave接口上传输每个数据包，此模式提供了容错能力</p></li><li><p>mode=4(802.3ad)(IEEE 802.3ad 动态链接聚合)</p><p>表示支持802.3ad协议，和交换机的聚合LACP方式配合（需要xmit_hash_policy）.标准要求所有设备在聚合操作时，要在同样的速率和双工模式，而且，和除了balance-rr模式外的其它bonding负载均衡模式一样，任何连接都不能使用多于一个接口的带宽。</p><p>特点：创建一个聚合组，它们共享同样的速率和双工设定。根据802.3ad规范将多个slave工作在同一个激活的聚合体下。外出流量的slave选举是基于传输hash策略，该策略可以通过xmit_hash_policy选项从缺省的XOR策略改变到其他策略。需要注意的 是，并不是所有的传输策略都是802.3ad适应的，</p><p>尤其考虑到在802.3ad标准43.2.4章节提及的包乱序问题。不同的实现可能会有不同的适应 性。</p><p>必要条件：<br>条件1：ethtool支持获取每个slave的速率和双工设定</p><p>条件2：switch(交换机)支持IEEE 802.3ad Dynamic link aggregation</p><p>条件3：大多数switch(交换机)需要经过特定配置才能支持802.3ad模式</p></li><li><p>mode=5(balance-tlb)<br> (适配器传输负载均衡)是根据每个slave的负载情况选择slave进行发送，接收时使用当前轮到的slave。该模式要求slave接口的网络设备驱动有某种ethtool支持；而且ARP监控不可用。</p><p> 特点：不需要任何特别的switch(交换机)支持的通道bonding。在每个slave上根据当前的负载（根据速度计算）分配外出流量。如果正在接受数据的slave出故障了，另一个slave接管失败的slave的MAC地址。</p><p> 必要条件：<br>ethtool支持获取每个slave的速率</p></li><li><p>mode=6(balance-alb)(适配器适应性负载均衡)在5的tlb基础上增加了rlb(接收负载均衡receive load balance).不需要任何switch(交换机)的支持。接收负载均衡是通过ARP协商实现的.</p><p> 特点：该模式包含了balance-tlb模式，同时加上针对IPV4流量的接收负载均衡(receive load balance, rlb)，而且不需要任何switch(交换机)的支持。接收负载均衡是通过ARP协商实现的。bonding驱动截获本机发送的ARP应答，并把源硬件地址改写为bond中某个slave的唯一硬件地址，从而使得不同的对端使用不同的硬件地址进行通信。来自服务器端的接收流量也会被均衡。当本机发送ARP请求时，bonding驱动把对端的IP信息从ARP包中复制并保存下来。当ARP应答从对端到达 时，bonding驱动把它的硬件地址提取出来，并发起一个ARP应答给bond中的某个slave。</p><p> 使用ARP协商进行负载均衡的一个问题是：每次广播 ARP请求时都会使用bond的硬件地址，因此对端学习到这个硬件地址后，接收流量将会全部流向当前的slave。这个问题可以通过给所有的对端发送更新 （ARP应答）来解决，应答中包含他们独一无二的硬件地址，从而导致流量重新分布。</p><p> 当新的slave加入到bond中时，或者某个未激活的slave重新 激活时，接收流量也要重新分布。接收的负载被顺序地分布（round robin）在bond中最高速的slave上</p><p> 当某个链路被重新接上，或者一个新的slave加入到bond中，接收流量在所有当前激活的slave中全部重新分配，通过使用指定的MAC地址给每个 client发起ARP应答。下面介绍的updelay参数必须被设置为某个大于等于switch(交换机)转发延时的值，从而保证发往对端的ARP应答 不会被switch(交换机)阻截。</p><p>必要条件：条件1：ethtool支持获取每个slave的速率；</p><p>条件2：底层驱动支持设置某个设备的硬件地址，从而使得总是有个slave(curr_active_slave)使用bond的硬件地址，同时保证每个bond 中的slave都有一个唯一的硬件地址。如果curr_active_slave出故障，它的硬件地址将会被新选出来的 curr_active_slave接管</p></li></ol><p>其实mod=6与mod=0的区别：mod=6，先把eth0流量占满，再占eth1，….ethX；而mod=0的话，会发现2个口的流量都很稳定，基本一样的带宽。而mod=6，会发现第一个口流量很高，第2个口只占了小部分流量。</p><p>mode5和mode6不需要交换机端的设置，网卡能自动聚合。mode4需要支持802.3ad。mode0，mode2和mode3理论上需要静态聚合方式。</p><p>但实测中mode0可以通过mac地址欺骗的方式在交换机不设置的情况下不太均衡地进行接收。</p><h2 id="setup-bond"><a href="#setup-bond" class="headerlink" title="setup bond"></a>setup bond</h2><h3 id="检查Linux环境是否支持bonding"><a href="#检查Linux环境是否支持bonding" class="headerlink" title="检查Linux环境是否支持bonding"></a>检查Linux环境是否支持bonding</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">modinfo bonding |grep description</div><div class="line">description: Ethernet Channel Bonding Driver, v3.7.1</div><div class="line">yum install ifenslave</div></pre></td></tr></table></figure><h3 id="etc-modprobe-d-bonding-conf"><a href="#etc-modprobe-d-bonding-conf" class="headerlink" title="/etc/modprobe.d/bonding.conf"></a>/etc/modprobe.d/bonding.conf</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">alias bond0 bonding</div><div class="line">options bond0 miimon=80 mode=0</div></pre></td></tr></table></figure><h3 id="ifcfg-bond0"><a href="#ifcfg-bond0" class="headerlink" title="ifcfg-bond0"></a>ifcfg-bond0</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">DEVICE=bond0</div><div class="line">TYPE=Ethernet</div><div class="line">ONBOOT=yes</div><div class="line">NM_CONTROLLED=yes</div><div class="line">BOOTPROTO=none</div><div class="line"></div><div class="line">BROADCAST=192.168.122.255</div><div class="line">IPADDR=192.168.122.122</div><div class="line">NETMASK=255.255.255.0</div><div class="line">GATEWAY=192.168.122.1</div><div class="line">USERCTL=no</div></pre></td></tr></table></figure><h3 id="ifcfg-eth0"><a href="#ifcfg-eth0" class="headerlink" title="ifcfg-eth0"></a>ifcfg-eth0</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">DEVICE=eth0</div><div class="line">#HWADDR=52:54:00:95:76:B1</div><div class="line">TYPE=Ethernet</div><div class="line">#UUID=e744a12d-063a-428d-858b-48f4174c4fe1</div><div class="line">ONBOOT=yes</div><div class="line">NM_CONTROLLED=yes</div><div class="line">BOOTPROTO=none</div><div class="line"></div><div class="line">MASTER=bond0</div><div class="line">SLAVE=yes</div><div class="line">USERCTL=no</div></pre></td></tr></table></figure><h3 id="ifcfg-eth1"><a href="#ifcfg-eth1" class="headerlink" title="ifcfg-eth1"></a>ifcfg-eth1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">DEVICE=eth1</div><div class="line">#HWADDR=52:54:00:95:76:B1</div><div class="line">TYPE=Ethernet</div><div class="line">#UUID=e744a12d-063a-428d-858b-48f4174c4fe1</div><div class="line">ONBOOT=yes</div><div class="line">NM_CONTROLLED=yes</div><div class="line">BOOTPROTO=none</div><div class="line"></div><div class="line">MASTER=bond0</div><div class="line">SLAVE=yes</div><div class="line">USERCTL=no</div></pre></td></tr></table></figure><p><img src="/2017/08/12/bond/./bond0.png" alt=""></p><h3 id="etc-rc-local"><a href="#etc-rc-local" class="headerlink" title="/etc/rc.local"></a>/etc/rc.local</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &apos;ifenslave bond0 eth0 eth1&apos; &gt;&gt;/etc/rc.local</div></pre></td></tr></table></figure><h3 id="restart-network"><a href="#restart-network" class="headerlink" title="restart network"></a>restart network</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/etc/init.d/network restart</div></pre></td></tr></table></figure><p><img src="/2017/08/12/bond/./bond2.png" alt=""></p><p><img src="/2017/08/12/bond/./bond1.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> network </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>bing wallpapers</title>
      <link href="/2017/08/07/bing-wallpapers/"/>
      <url>/2017/08/07/bing-wallpapers/</url>
      
        <content type="html"><![CDATA[<p>Bash Shell 下载每日的Bing壁纸，并设置成桌面。</p><h2 id="shell-script"><a href="#shell-script" class="headerlink" title="shell script"></a>shell script</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">#update 170808 fix bug</div><div class="line">export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</div><div class="line">function wallpaper_today()&#123;</div><div class="line">  wget cn.bing.com/$(curl http://cn.bing.com/ \</div><div class="line">  |grep -oE &quot;g_img=\&#123;url:.*g_img.hdon = 1&quot; \</div><div class="line">  |awk -F&apos;:&apos; &apos;&#123;print $2&#125;&apos; \</div><div class="line">  |cut -d &apos;&quot;&apos; -f2)</div><div class="line">&#125;</div><div class="line"></div><div class="line">function wallpaper_tomorrow()&#123;</div><div class="line">  wget cn.bing.com/$(curl http://cn.bing.com/ \</div><div class="line">  |grep -oE &quot;var g_prefetch.*var hpWall&quot; \</div><div class="line">  |awk -F&apos;:&apos; &apos;&#123;print $3&#125;&apos; \</div><div class="line">  |cut -d &quot;&apos;&quot; -f2)</div><div class="line">&#125;</div><div class="line"></div><div class="line">function main()&#123;</div><div class="line">  DES=&quot;$HOME/wallpapers/$(date +%F)&quot;</div><div class="line">  [[ -d $DES ]] || mkdir -p $DES</div><div class="line">  cd $DES</div><div class="line">  case $1 in</div><div class="line">  now)wallpaper_today;;</div><div class="line">  tom)wallpaper_tomorrow;;</div><div class="line">  esac</div><div class="line">  filename=&quot;$( readlink -f $(ls -t1 |head -1) )&quot;</div><div class="line">  gsettings set org.gnome.desktop.background picture-uri &quot;file://$filename&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">main $1</div></pre></td></tr></table></figure><h2 id="nasa"><a href="#nasa" class="headerlink" title="nasa"></a>nasa</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">#update 170808 fix bug</div><div class="line">export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin</div><div class="line">function download()&#123;</div><div class="line">  base=&apos;http://apod.nasa.gov/apod/&apos;</div><div class="line">  wget -O /tmp/nasa $&#123;base&#125;astropix.html</div><div class="line">  href=$&#123;base&#125;`cat /tmp/nasa | grep -i &apos;&lt;img&apos; | awk -F &apos;&quot;&apos; &apos;&#123;print $2&#125;&apos;`</div><div class="line">  ext=$&#123;href##*.&#125;</div><div class="line">&#125;</div><div class="line">function main()&#123;</div><div class="line">  DES=&quot;$HOME/wallpapers/NASA/$(date +%F)&quot;</div><div class="line">  [[ -d $DES ]] || mkdir -p $DES</div><div class="line">  cd $DES</div><div class="line">  wget $href</div><div class="line">  filename=&quot;$( readlink -f $(ls -t1 |head -1) )&quot;</div><div class="line">  gsettings set org.gnome.desktop.background picture-uri &quot;file://$filename&quot;</div><div class="line">&#125;</div><div class="line">download</div><div class="line">main</div></pre></td></tr></table></figure><h2 id="crontab"><a href="#crontab" class="headerlink" title="crontab"></a>crontab</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0 12 * * * xy export $(env |grep -i dbus);bash /home/xy/shell/bing_wallpapers.sh tom &amp;&gt;/dev/null</div></pre></td></tr></table></figure><p><img src="/2017/08/07/bing-wallpapers/./Decaying_Startrails_nimiaRM_165652_1080_HD_EN-US1933491271.jpg" alt=""></p><p><img src="/2017/08/07/bing-wallpapers/./LoxodontaAfricana_ZH-CN10434704249_1920x1080.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>wssh</title>
      <link href="/2017/08/07/wssh/"/>
      <url>/2017/08/07/wssh/</url>
      
        <content type="html"><![CDATA[<h2 id="wssh"><a href="#wssh" class="headerlink" title="wssh"></a>wssh</h2><p>wssh is a SSH to WebSockets Bridge that lets you invoke a remote shell using nothing but HTTP.</p><p>The client connecting to wssh doesn’t need to speak the SSH protocol - rather, the SSH connection is terminated at the bridge level and the pty is wrapper through a thin layer of JSON and sent back to the client.</p><p>This means you can implement a WSSH client in just a few lines of code, even for a web browser.</p><h2 id="setup-wssh"><a href="#setup-wssh" class="headerlink" title="setup wssh"></a>setup wssh</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum install python-pip</div><div class="line">pip install gevent gevent-websocket paramiko flask</div><div class="line">git clone https://github.com/aluzzardi/wssh.git</div></pre></td></tr></table></figure><h2 id="Usage"><a href="#Usage" class="headerlink" title="Usage"></a>Usage</h2><p>Even though wssh primary purpose is to be used as a library in your applications, it ships with two command line tools: wsshd (the server) and wssh (the client).<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ wsshd </div><div class="line">wsshd/0.1.0 running on 0.0.0.0:5000</div><div class="line"></div><div class="line">$ wssh aluzzardi@mba -p</div><div class="line">Password: </div><div class="line">Last login: Mon Jul 23 23:20:27 2012 from localhost</div><div class="line">aluzzardi@mba:~$</div></pre></td></tr></table></figure></p><h2 id="Web-Interface"><a href="#Web-Interface" class="headerlink" title="Web Interface"></a>Web Interface</h2><p>wsshd provides a web interface giving you access to a Javascript client</p><p><img src="/2017/08/07/wssh/./wssh0.png" alt=""></p><p><img src="/2017/08/07/wssh/./wssh1.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WebVirtMgr</title>
      <link href="/2017/07/22/WebVirtMgr/"/>
      <url>/2017/07/22/WebVirtMgr/</url>
      
        <content type="html"><![CDATA[<p>WebVirtMgr 是一个基于 libvirt 开发的用来管理虚拟机的Web接口。可创建和配置新的域，并调整域的资源分配，可通过 SSH 隧道的 VNC 浏览器提供完整的图形控制台来访问 guest 域，支持 KVM。</p><h2 id="1-Installation"><a href="#1-Installation" class="headerlink" title="1. Installation"></a>1. Installation</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git https://github.com/retspen/webvirtmgr/wiki/Install-WebVirtMgr</div><div class="line"></div><div class="line">$ sudo yum -y install http://dl.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm</div><div class="line">$ sudo yum -y install git python-pip libvirt-python libxml2-python python-websockify supervisor nginx</div></pre></td></tr></table></figure><h2 id="2-Install-python-requirements-and-setup-Django-environment"><a href="#2-Install-python-requirements-and-setup-Django-environment" class="headerlink" title="2. Install python requirements and setup Django environment"></a>2. Install python requirements and setup Django environment</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> git://github.com/retspen/webvirtmgr.git</div><div class="line">$ <span class="built_in">cd</span> webvirtmgr</div><div class="line">$ sudo pip install -r requirements.txt <span class="comment"># or python-pip (RedHat, Fedora, CentOS, OpenSuse)</span></div><div class="line">$ ./manage.py syncdb</div><div class="line">$ ./manage.py collectstatic</div><div class="line"></div><div class="line"><span class="comment">##Enter the user information:</span></div><div class="line"></div><div class="line">You just installed Django<span class="string">'s auth system, which means you don'</span>t have any superusers defined.</div><div class="line">Would you like to create one now? (yes/no): yes (Put: yes)</div><div class="line">Username (Leave blank to use <span class="string">'admin'</span>): admin (Put: your username or login)</div><div class="line">E-mail address: username@domain.local (Put: your email)</div><div class="line">Password: xxxxxx (Put: your password)</div><div class="line">Password (again): xxxxxx (Put: confirm password)</div><div class="line">Superuser created successfully.</div><div class="line"></div><div class="line"><span class="comment">##Adding additional superusers</span></div><div class="line">$ ./manage.py createsuperuser</div></pre></td></tr></table></figure><h2 id="3-Setup-Nginx"><a href="#3-Setup-Nginx" class="headerlink" title="3. Setup Nginx"></a>3. Setup Nginx</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo cp <span class="_">-a</span>  webvirtmgr /var/www/</div><div class="line">mv /etc/nginx/conf.d/default.conf&#123;,.bak&#125;</div><div class="line">chown -R nginx:</div></pre></td></tr></table></figure><h2 id="etc-nginx-conf-d-webvirtmgr-conf"><a href="#etc-nginx-conf-d-webvirtmgr-conf" class="headerlink" title="/etc/nginx/conf.d/webvirtmgr.conf"></a>/etc/nginx/conf.d/webvirtmgr.conf</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">  listen 80 default_server;</div><div class="line"></div><div class="line">  server_name <span class="formula">$hostname;</span></div><div class="line">  #access_log /var/log/nginx/webvirtmgr_access_log;</div><div class="line"></div><div class="line">  location /static/ &#123;</div><div class="line">  root /var/www/webvirtmgr/webvirtmgr; # or /srv instead of /var</div><div class="line">  expires max;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  location / &#123;</div><div class="line">  proxy_pass http://127.0.0.1:8000;</div><div class="line">  proxy_set_header X-Real-IP $remote_addr;</div><div class="line">  proxy_set_header X-Forwarded-for <span class="formula">$proxy_add_x_forwarded_for;</span></div><div class="line">  proxy_set_header Host $host:<span class="formula">$server_port;</span></div><div class="line">  proxy_set_header X-Forwarded-Proto $scheme;</div><div class="line">  proxy_connect_timeout 600;</div><div class="line">  proxy_read_timeout 600;</div><div class="line">  proxy_send_timeout 600;</div><div class="line">  client_max_body_size 1024M; # Set higher depending on your needs</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="4-Setup-Supervisor"><a href="#4-Setup-Supervisor" class="headerlink" title="4. Setup Supervisor"></a>4. Setup Supervisor</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">cat &gt;&gt; /etc/supervisor.conf</div><div class="line">[program:webvirtmgr]</div><div class="line">command=/usr/bin/python /var/www/webvirtmgr/manage.py run_gunicorn -c /var/www/webvirtmgr/conf/gunicorn.conf.py</div><div class="line">directory=/var/www/webvirtmgr</div><div class="line">autostart=true</div><div class="line">autorestart=true</div><div class="line">logfile=/var/log/supervisor/webvirtmgr.log</div><div class="line">log_stderr=true</div><div class="line">user=nginx</div><div class="line"></div><div class="line">[program:webvirtmgr-console]</div><div class="line">command=/usr/bin/python /var/www/webvirtmgr/console/webvirtmgr-console</div><div class="line">directory=/var/www/webvirtmgr</div><div class="line">autostart=true</div><div class="line">autorestart=true</div><div class="line">stdout_logfile=/var/log/supervisor/webvirtmgr-console.log</div><div class="line">redirect_stderr=true</div><div class="line">user=nginx</div><div class="line"></div><div class="line">vim +23 ./webvirtmgr/conf/gunicorn.conf.py</div><div class="line">0.0.0.0:8000</div><div class="line"></div><div class="line">```tex</div><div class="line">grep -Rn &apos;6080&apos; ./webvirtmgr</div><div class="line">./webvirtmgr/webvirtmgr/settings.py:147:WS_PORT = 6080</div><div class="line">./webvirtmgr/console/webvirtmgr-console:57: default=WS_PORT or 6080)</div></pre></td></tr></table></figure><p>连接KVM<br><img src="/2017/07/22/WebVirtMgr/./pic0.png" alt="pic"></p><p>虚拟机设置<br><img src="/2017/07/22/WebVirtMgr/./pic1.png" alt="pic"></p><p>web连接虚拟机<br><img src="/2017/07/22/WebVirtMgr/./pic2.png" alt="pic"></p><h2 id="know-errors"><a href="#know-errors" class="headerlink" title="know errors"></a>know errors</h2><p>Cannot recv data: Host key verification failed.: Connection reset by peer</p><p>su -s /bin/bash nginx<br>ssh-keygen<br>ssh-copy-id root@192.168.35.128</p>]]></content>
      
      
      <categories>
          
          <category> virtualization </category>
          
      </categories>
      
      
        <tags>
            
            <tag> webvirtmgr </tag>
            
            <tag> kvm </tag>
            
            <tag> virt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ELK</title>
      <link href="/2017/07/18/ELK/"/>
      <url>/2017/07/18/ELK/</url>
      
        <content type="html"><![CDATA[<p>ELK堆栈设置有四个主要组件：<br>Logstash：处理传入日志的Logstash的服务器组件<br>Elasticsearch：存储所有日志<br>Kibana：用于搜索和可视化日志的Web界面，将通过Nginx<br>Filebeat代理：安装在将其日志发送到Logstash的客户端服务器，Filebeat充当日志传送代理，利用伐木工具网络协议与Logstash进行通信<br><img src="/2017/07/18/ELK/./pic0.jpg" alt="pic"></p><p>Home page:<br>  <a href="https://www.elastic.co/cn/products" target="_blank" rel="external">https://www.elastic.co/cn/products</a></p><p>Docs:<br>  <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/_installation.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/current/_installation.html</a></p><h2 id="setup-java8"><a href="#setup-java8" class="headerlink" title="setup java8"></a>setup java8</h2><p>yum install java-1.8.0 -y</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Home page:</div><div class="line">  http://www.oracle.com/technetwork/java/javase/downloads/index.html</div><div class="line"></div><div class="line">http://download.oracle.com/otn-pub/java/jdk/8u131-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk-8u131-linux-x64.rpm</div><div class="line"></div><div class="line">http://download.oracle.com/otn-pub/java/jdk/8u131-b11/d54c1d3a095b4ff2b6607d096fa80163/jdk-8u131-linux-x64.tar.gz</div></pre></td></tr></table></figure><h2 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">wget -c https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.4.3.rpm \</div><div class="line">  https://artifacts.elastic.co/downloads/logstash/logstash-5.4.3.rpm \</div><div class="line">  https://artifacts.elastic.co/downloads/kibana/kibana-5.4.3-x86_64.rpm</div><div class="line"></div><div class="line">rpm -ivh elasticsearch-5.4.3.rpm</div><div class="line">chkconfig --add elasticsearch</div><div class="line">chkconfig elasticsearch on</div><div class="line"></div><div class="line"><span class="comment">## make sure elasticsearch is running</span></div><div class="line">shell&gt; curl -XGET <span class="string">'localhost:9200/?pretty'</span></div><div class="line">&#123;</div><div class="line">  <span class="string">"name"</span> : <span class="string">"0rQVMcY"</span>,</div><div class="line">  <span class="string">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</div><div class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"WctRHe5eTtm85OBYiDrgcA"</span>,</div><div class="line">  <span class="string">"version"</span> : &#123;</div><div class="line">  <span class="string">"number"</span> : <span class="string">"5.4.3"</span>,</div><div class="line">  <span class="string">"build_hash"</span> : <span class="string">"eed30a8"</span>,</div><div class="line">  <span class="string">"build_date"</span> : <span class="string">"2017-06-22T00:34:03.743Z"</span>,</div><div class="line">  <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</div><div class="line">  <span class="string">"lucene_version"</span> : <span class="string">"6.5.1"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">## /etc/elasticsearch/elasticsearch.yml</span></div><div class="line">```tex</div><div class="line">node.name: node-1</div><div class="line">path.data: /var/lib/elasticsearch</div><div class="line">path.logs: /var/<span class="built_in">log</span>/elasticsearch</div><div class="line">bootstrap.system_call_filter: <span class="literal">false</span></div><div class="line">network.host: 192.168.1.28</div><div class="line">http.port: 9200</div><div class="line"></div><div class="line"><span class="comment">## /etc/security/limits.conf</span></div><div class="line">```tex</div><div class="line">* soft nofile 65536</div><div class="line">* hard nofile 131072</div><div class="line">* soft nproc 2048</div><div class="line">* hard nproc 4096</div><div class="line"></div><div class="line"><span class="comment">## /etc/security/limits.d/90-nproc.conf</span></div><div class="line">* soft nproc 2048</div><div class="line">root soft nproc unlimited</div><div class="line"></div><div class="line">shell&gt; chown -R elasticsearch /var/lib/elasticsearch/ /var/<span class="built_in">log</span>/elasticsearch/</div><div class="line"></div><div class="line"><span class="comment">## /etc/sysconfig/elasticsearch</span></div><div class="line">ES_HOME=/usr/share/elasticsearch</div><div class="line">JAVA_HOME=/usr/java/jdk1.8.0_111</div><div class="line">CONF_DIR=/etc/elasticsearch</div><div class="line">DATA_DIR=/var/lib/elasticsearch</div><div class="line">LOG_DIR=/var/<span class="built_in">log</span>/elasticsearch</div><div class="line">PID_DIR=/var/run/elasticsearch</div></pre></td></tr></table></figure><h2 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">rpm -ivh logstash-5.4.3.rpm</div><div class="line"></div><div class="line">## install plugin</div><div class="line">/usr/share/logstash/bin/logstash-plugin install logstash-input-beats</div><div class="line">Validating logstash-input-beats</div><div class="line">Installing logstash-input-beats</div><div class="line">Installation successful</div><div class="line"></div><div class="line">## /etc/logstash/conf.d/01-beats-input.conf</div><div class="line">input &#123;</div><div class="line">  beats &#123;</div><div class="line">  port =&gt; 5044</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">## /etc/logstash/conf.d/10-syslog-filter.conf</div><div class="line">filter &#123;</div><div class="line">  if [type] == &quot;syslog&quot; &#123;</div><div class="line">  grok &#123;</div><div class="line">  match =&gt; &#123; &quot;message&quot; =&gt; &quot;%&#123;SYSLOGTIMESTAMP:syslog_timestamp&#125; %&#123;SYSLOGHOST:syslog_hostname&#125; %&#123;DATA:syslog_program&#125;(?:\[%&#123;POSINT:syslog_pid&#125;\])?: %&#123;GREEDYDATA:syslog_message&#125;&quot; &#125;</div><div class="line">  add_field =&gt; [ &quot;received_at&quot;, &quot;%&#123;@timestamp&#125;&quot; ]</div><div class="line">  add_field =&gt; [ &quot;received_from&quot;, &quot;%&#123;host&#125;&quot; ]</div><div class="line">  &#125;</div><div class="line">  syslog_pri &#123; &#125;</div><div class="line">  date &#123;</div><div class="line">  match =&gt; [ &quot;syslog_timestamp&quot;, &quot;MMM d HH:mm:ss&quot;, &quot;MMM dd HH:mm:ss&quot; ]</div><div class="line">  &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">## /etc/logstash/conf.d/logstash-simple.conf</div><div class="line">input &#123; stdin &#123; &#125; &#125;</div><div class="line">output &#123;</div><div class="line">  elasticsearch &#123; hosts =&gt; [&quot;localhost:9200&quot;] &#125;</div><div class="line">  stdout &#123; codec =&gt; rubydebug &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">## set up logstash</div><div class="line">#Doc: https://www.elastic.co/guide/en/beats/libbeat/5.4/logstash-installation.html#logstash-setup</div><div class="line"></div><div class="line">## Updating the Beats Input Plugin for Logstash</div><div class="line">/usr/share/logstash/bin/logstash-plugin update logstash-input-beats</div><div class="line"></div><div class="line">initctl start logstash</div></pre></td></tr></table></figure><h2 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">rpm -ivh kibana-5.4.3-x86_64.rpm</div><div class="line">chkconfig --add kibana</div><div class="line">chkconfig kibana on</div><div class="line"></div><div class="line">## /etc/kibana/kibana.yml</div><div class="line">server.port: 5601</div><div class="line">server.host: 0.0.0.0</div><div class="line"></div><div class="line">curl -i localhost:5601</div><div class="line">  HTTP/1.1 200 OK</div><div class="line">  kbn-name: kibana</div><div class="line">  kbn-version: 5.4.3</div><div class="line">  cache-control: no-cache</div><div class="line">  content-type: text/html; charset=utf-8</div><div class="line">  content-length: 217</div><div class="line">  accept-ranges: bytes</div><div class="line">  Date: Wed, 05 Jul 2017 07:59:59 GMT</div><div class="line"></div><div class="line"></div><div class="line">##在Elasticsearch中加载Filebeat索引模板</div><div class="line">```bash</div><div class="line">curl -O https://gist.githubusercontent.com/thisismitch/3429023e8438cc25b86c/raw/d8c479e2a1adcea8b1fe86570e42abab0f10f364/filebeat-index-template.json</div><div class="line">shell&gt; curl -XPUT &apos;http://localhost:9200/_template/filebeat?pretty&apos; -d@filebeat-index-template.json</div><div class="line">&#123;</div><div class="line">  &quot;acknowledged&quot; : true</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="Filebeat"><a href="#Filebeat" class="headerlink" title="Filebeat"></a>Filebeat</h2><p><a href="https://www.elastic.co/downloads/beats/filebeat" target="_blank" rel="external">https://www.elastic.co/downloads/beats/filebeat</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-5.4.3-x86_64.rpm</div><div class="line">rpm -ivh filebeat-5.4.3-x86_64.rpm</div><div class="line"></div><div class="line"><span class="comment">## start</span></div><div class="line">chkconfig --add filebeat</div><div class="line">chkconfig filebeat on</div><div class="line"></div><div class="line">/etc/init.d/filebeat start</div><div class="line">./filebeat <span class="_">-e</span> -c filebeat.yml</div><div class="line"></div><div class="line"><span class="comment">## /etc/filebeat/filebeat.yml</span></div><div class="line">filebeat.prospectors:</div><div class="line">- input_type: <span class="built_in">log</span></div><div class="line">  paths:</div><div class="line">  - /var/<span class="built_in">log</span>/secure</div><div class="line">  - /var/<span class="built_in">log</span>/messages</div><div class="line">  - /var/<span class="built_in">log</span>/*.log</div><div class="line">output.elasticsearch:</div><div class="line">  hosts: [<span class="string">"192.168.1.28:9200"</span>]</div><div class="line">output.logstash:</div><div class="line">  hosts: [<span class="string">"192.168.1.28:5044"</span>]</div><div class="line"></div><div class="line"><span class="comment">#此时浏览http://localhost:9200/_search?pretty #也应该能看到一堆输出，表明elasticsearch接收到logstash的数据了</span></div></pre></td></tr></table></figure></p><p><img src="/2017/07/18/ELK/./ELK0.png" alt="pic"></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ELK </tag>
            
            <tag> log </tag>
            
            <tag> logstash </tag>
            
            <tag> elasticsearch </tag>
            
            <tag> kibana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssh scan</title>
      <link href="/2017/07/11/ssh-scan/"/>
      <url>/2017/07/11/ssh-scan/</url>
      
        <content type="html"><![CDATA[<h2 id="ssh-scan"><a href="#ssh-scan" class="headerlink" title="ssh_scan"></a>ssh_scan</h2><pre><code>是一个面向 Linux 和 UNIX 服务器的易用的 SSH 服务参数配置和策略的扫描器程序，其思路来自Mozilla OpenSSH 安全指南，这个指南为 SSH 服务参数配置提供了一个可靠的安全策略基线的建议，如加密算法（Ciphers），报文认证信息码算法（MAC），密钥交换算法（KexAlgos）和其它</code></pre><p>git <a href="https://github.com/mozilla/ssh_scan" target="_blank" rel="external">https://github.com/mozilla/ssh_scan</a></p><h2 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h2><h4 id="Debian-Ubuntu"><a href="#Debian-Ubuntu" class="headerlink" title="Debian/Ubuntu"></a>Debian/Ubuntu</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apt-get install rubygems</div><div class="line">gem install ssh_scan</div></pre></td></tr></table></figure><h4 id="CentOS-RHEL"><a href="#CentOS-RHEL" class="headerlink" title="CentOS/RHEL"></a>CentOS/RHEL</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install ruby rubygems</div><div class="line">gem install ssh_scan</div></pre></td></tr></table></figure><h2 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">shell&gt; ssh_scan -t 127.0.0.1 -p 22</div><div class="line">[</div><div class="line">  &#123;</div><div class="line">  <span class="string">"ssh_scan_version"</span>: <span class="string">"0.0.25"</span>,</div><div class="line">  <span class="string">"ip"</span>: <span class="string">"127.0.0.1"</span>,</div><div class="line">  <span class="string">"hostname"</span>: <span class="string">"localhost"</span>,</div><div class="line">  <span class="string">"port"</span>: 22,</div><div class="line">  <span class="string">"server_banner"</span>: <span class="string">"SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.2"</span>,</div><div class="line">  <span class="string">"ssh_version"</span>: 2.0,</div><div class="line">  <span class="string">"os"</span>: <span class="string">"ubuntu"</span>,</div><div class="line">  <span class="string">"os_cpe"</span>: <span class="string">"o:canonical:ubuntu:16.04"</span>,</div><div class="line">  <span class="string">"ssh_lib"</span>: <span class="string">"openssh"</span>,</div><div class="line">  <span class="string">"ssh_lib_cpe"</span>: <span class="string">"a:openssh:openssh:7.2p2"</span>,</div><div class="line">  <span class="string">"key_algorithms"</span>: [</div><div class="line">  <span class="string">"curve25519-sha256@libssh.org"</span>,</div><div class="line">  <span class="string">"ecdh-sha2-nistp521"</span>,</div><div class="line">  <span class="string">"ecdh-sha2-nistp384"</span>,</div><div class="line">  <span class="string">"ecdh-sha2-nistp256"</span>,</div><div class="line">  <span class="string">"diffie-hellman-group-exchange-sha256"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"encryption_algorithms_client_to_server"</span>: [</div><div class="line">  <span class="string">"chacha20-poly1305@openssh.com"</span>,</div><div class="line">  <span class="string">"aes256-gcm@openssh.com"</span>,</div><div class="line">  <span class="string">"aes128-gcm@openssh.com"</span>,</div><div class="line">  <span class="string">"aes256-ctr"</span>,</div><div class="line">  <span class="string">"aes192-ctr"</span>,</div><div class="line">  <span class="string">"aes128-ctr"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"encryption_algorithms_server_to_client"</span>: [</div><div class="line">  <span class="string">"chacha20-poly1305@openssh.com"</span>,</div><div class="line">  <span class="string">"aes256-gcm@openssh.com"</span>,</div><div class="line">  <span class="string">"aes128-gcm@openssh.com"</span>,</div><div class="line">  <span class="string">"aes256-ctr"</span>,</div><div class="line">  <span class="string">"aes192-ctr"</span>,</div><div class="line">  <span class="string">"aes128-ctr"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"mac_algorithms_client_to_server"</span>: [</div><div class="line">  <span class="string">"hmac-sha2-512-etm@openssh.com"</span>,</div><div class="line">  <span class="string">"hmac-sha2-256-etm@openssh.com"</span>,</div><div class="line">  <span class="string">"umac-128-etm@openssh.com"</span>,</div><div class="line">  <span class="string">"umac-128@openssh.com"</span>,</div><div class="line">  <span class="string">"hmac-sha2-512"</span>,</div><div class="line">  <span class="string">"hmac-sha2-256"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"mac_algorithms_server_to_client"</span>: [</div><div class="line">  <span class="string">"hmac-sha2-512-etm@openssh.com"</span>,</div><div class="line">  <span class="string">"hmac-sha2-256-etm@openssh.com"</span>,</div><div class="line">  <span class="string">"umac-128-etm@openssh.com"</span>,</div><div class="line">  <span class="string">"umac-128@openssh.com"</span>,</div><div class="line">  <span class="string">"hmac-sha2-512"</span>,</div><div class="line">  <span class="string">"hmac-sha2-256"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"compression_algorithms_client_to_server"</span>: [</div><div class="line">  <span class="string">"none"</span>,</div><div class="line">  <span class="string">"zlib@openssh.com"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"compression_algorithms_server_to_client"</span>: [</div><div class="line">  <span class="string">"none"</span>,</div><div class="line">  <span class="string">"zlib@openssh.com"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"languages_client_to_server"</span>: [</div><div class="line"></div><div class="line">  ],</div><div class="line">  <span class="string">"languages_server_to_client"</span>: [</div><div class="line"></div><div class="line">  ],</div><div class="line">  <span class="string">"auth_methods"</span>: [</div><div class="line">  <span class="string">"publickey"</span>,</div><div class="line">  <span class="string">"password"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"fingerprints"</span>: &#123;</div><div class="line">  <span class="string">"rsa"</span>: &#123;</div><div class="line">  <span class="string">"known_bad"</span>: <span class="string">"false"</span>,</div><div class="line">  <span class="string">"md5"</span>: <span class="string">"c1:53:4b:ae:b9:38:c6:11:a2:1d:51:2d:de:19:45:c1"</span>,</div><div class="line">  <span class="string">"sha1"</span>: <span class="string">"26:7d:79:42:4e:6e:9b:03:d1:e4:f0:45:c1:b2:6c:f2:61:9d:4c:d6"</span>,</div><div class="line">  <span class="string">"sha256"</span>: <span class="string">"9a:46:57:e9:08:a3:ce:2a:72:dd:f0:9f:ce:16:6e:ff:58:36:24:df:0a:d1:17:ea:41:60:1c:07:63:ea:7a:07"</span></div><div class="line">  &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"duplicate_host_key_ips"</span>: [</div><div class="line"></div><div class="line">  ],</div><div class="line">  <span class="string">"compliance"</span>: &#123;</div><div class="line">  <span class="string">"policy"</span>: <span class="string">"Mozilla Modern"</span>,</div><div class="line">  <span class="string">"compliant"</span>: <span class="literal">false</span>,</div><div class="line">  <span class="string">"recommendations"</span>: [</div><div class="line">  <span class="string">"Remove these authentication methods: password"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"references"</span>: [</div><div class="line">  <span class="string">"https://wiki.mozilla.org/Security/Guidelines/OpenSSH"</span></div><div class="line">  ],</div><div class="line">  <span class="string">"grade"</span>: <span class="string">"B"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"start_time"</span>: <span class="string">"2017-07-11 20:34:29 +0800"</span>,</div><div class="line">  <span class="string">"end_time"</span>: <span class="string">"2017-07-11 20:34:29 +0800"</span>,</div><div class="line">  <span class="string">"scan_duration_seconds"</span>: 0.075674793</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> security </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Keepalived LVS</title>
      <link href="/2017/07/05/keepalived-lvs/"/>
      <url>/2017/07/05/keepalived-lvs/</url>
      
        <content type="html"><![CDATA[<p>1、介绍</p><p>Keeaplived 主要有两种应用场景，一个是通过配置keepalived结合ipvs做到负载均衡（LVS+Keepalived）。另一个是通过自身健康检查、资源接管功能做高可用（双机热备），实现故障转移。</p><p>2、keepalived主要作用</p><p>keepalived采用VRRP（virtual router redundancy protocol），虚拟路由冗余协议，以软件的形式实现服务器热备功能。通常情况下是将两台linux服务器组成一个热备组（master-backup），同一时间热备组内只有一台主服务器（master）提供服务，同时master会虚拟出一个共用IP地址（VIP），这个VIP只存在master上并对外提供服务。如果keepalived检测到master宕机或服务故障，备服务器（backup）会自动接管VIP成为master，keepalived并将master从热备组移除，当master恢复后，会自动加入到热备组，默认再抢占成为master，起到故障转移功能。</p><p>3、工作在三层、四层和七层原理</p><p>Layer3：工作在三层时，keepalived会定期向热备组中的服务器发送一个ICMP数据包，来判断某台服务器是否故障，如果故障则将这台服务器从热备组移除。</p><p>Layer4：工作在四层时，keepalived以TCP端口的状态判断服务器是否故障，比如检测mysql 3306端口，如果故障则将这台服务器从热备组移除。</p><h2 id="keepalived-UserGuide"><a href="#keepalived-UserGuide" class="headerlink" title="keepalived UserGuide:"></a>keepalived UserGuide:</h2><p><a href="http://www.keepalived.org/pdf/UserGuide.pdf" target="_blank" rel="external">http://www.keepalived.org/pdf/UserGuide.pdf</a></p><h2 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h2><p><img src="/2017/07/05/keepalived-lvs/./pic0.png" alt=""></p><p><img src="/2017/07/05/keepalived-lvs/./lvs.png" alt="map"></p><h2 id="Install-Keepalived"><a href="#Install-Keepalived" class="headerlink" title="Install Keepalived"></a>Install Keepalived</h2><p><a href="http://www.keepalived.org/download.html" target="_blank" rel="external">http://www.keepalived.org/download.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">yum install -y openssl-devel libnl3-devel ipset-devel iptables-devel libnfnetlink-devel net-snmp-devel libnl-devel</div><div class="line"></div><div class="line">version=<span class="string">'1.3.5'</span></div><div class="line">wget http://www.keepalived.org/software/keepalived-<span class="variable">$&#123;version&#125;</span>.tar.gz</div><div class="line"><span class="built_in">cd</span> keepalived-<span class="variable">$&#123;version&#125;</span>/</div><div class="line">./configure &amp;&amp; make -j4</div><div class="line"></div><div class="line">make install</div><div class="line"></div><div class="line">cp <span class="_">-a</span> keepalived/etc/init.d/keepalived /etc/init.d/</div><div class="line">chmod +x /etc/init.d/keepalived</div><div class="line">sed -i <span class="string">'s@daemon keepalived@daemon /usr/local/sbin/keepalived@'</span> /etc/init.d/keepalived</div><div class="line">cp <span class="_">-a</span> keepalived/etc/sysconfig/keepalived /etc/sysconfig/</div><div class="line">cp <span class="_">-a</span> keepalived/etc/keepalived/ /etc/</div><div class="line">chkconfig --add keepalived</div><div class="line">chkconfig keepalived on</div><div class="line"></div><div class="line">keepalived --version</div><div class="line">Keepalived v1.3.5 (03/19,2017), git commit v1.3.5-6-g6fa32f2</div><div class="line"></div><div class="line">Copyright(C) 2001-2017 Alexandre Cassen, &lt;acassen@gmail.com&gt;</div><div class="line"></div><div class="line">Build options: PIPE2 LIBNL3 LIBIPTC LIBIPSET_DYNAMIC LVS LIBIPVS_NETLINK VRRP VRRP_AUTH VRRP_VMAC SOCK_NONBLOCK SOCK_CLOEXEC FIB_ROUTING SO_MARK</div></pre></td></tr></table></figure><h2 id="KeepAlived-Master-configure"><a href="#KeepAlived-Master-configure" class="headerlink" title="KeepAlived Master configure"></a>KeepAlived Master configure</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">#/etc/keepalived/keepalived.conf</div><div class="line">! Configuration File for keepalived</div><div class="line">global_defs &#123;</div><div class="line">  router_id LVS_MASTER</div><div class="line">&#125;</div><div class="line"></div><div class="line">vrrp_instance VI_1 &#123;</div><div class="line">  state MASTER</div><div class="line">  interface eth3 ##指定VIP网卡</div><div class="line">  virtual_router_id 60</div><div class="line">##     nopreempt</div><div class="line">##     当主down时，备接管，主恢复，不自动接管;;</div><div class="line">##     设置不抢占，该配置只能设置在state为BACKUP的主机上，  --而且priority必须要高于另一台主机。</div><div class="line">  priority 100</div><div class="line">  advert_int 1</div><div class="line">  authentication &#123;</div><div class="line">  auth_type PASS</div><div class="line">  auth_pass 1111</div><div class="line">  &#125;</div><div class="line">  virtual_ipaddress &#123;</div><div class="line">  192.168.2.120 ##VIP地址</div><div class="line">  &#125;</div><div class="line">     notify_master /etc/keepalived/be_master.sh</div><div class="line">&#125;</div><div class="line"></div><div class="line">virtual_server 192.168.2.120 80 &#123;</div><div class="line">  delay_loop 6</div><div class="line">  lb_algo rr</div><div class="line">  lb_kind DR</div><div class="line">  nat_mask 255.255.255.0</div><div class="line">  persistence_timeout 50</div><div class="line">  ##这个参数的意义是保持客户端的请求在这个时间段内全部发到同一个真实服务器</div><div class="line">  protocol TCP</div><div class="line"></div><div class="line">  real_server 192.168.2.134 80 &#123;</div><div class="line">      weight 1</div><div class="line">      TCP_CHECK &#123;</div><div class="line">          connect_timeout 3</div><div class="line">          nb_get_retry 3</div><div class="line">          delay_before_retry 3</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  real_server 192.168.2.135 80 &#123;</div><div class="line">      weight 1</div><div class="line">      TCP_CHECK &#123;</div><div class="line">          connect_timeout 3</div><div class="line">          nb_get_retry 3</div><div class="line">          delay_before_retry 3</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/etc/keepalived/be_master.sh</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">export</span> PAHT=<span class="variable">$PATH</span></div><div class="line">interface=$(route -n |awk <span class="string">'/^0/ &#123;print $NF&#125;'</span>)</div><div class="line">ipaddr=$(ip ad |grep -v inet6 | awk <span class="string">"/<span class="variable">$interface</span>\$/ &#123;print \$2&#125;"</span> |cut <span class="_">-d</span><span class="string">'/'</span> <span class="_">-f</span>1 |head -n1)</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$(date +%F' '%T)</span></span></div><div class="line"><span class="variable">$&#123;ipaddr&#125;</span> change to master." \</div><div class="line">     |mailx <span class="_">-s</span> <span class="string">"keepalived Master-Backup Change Status"</span> -r xjl@ops.com Triggers@qq.com</div></pre></td></tr></table></figure><h2 id="check-VIP"><a href="#check-VIP" class="headerlink" title="check VIP"></a>check VIP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">shell&gt; /etc/init.d/keepalived start</div><div class="line">shell&gt; ip a s eth3</div><div class="line">3: eth3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</div><div class="line">  link/ether 00:0c:29:6c:dc:eb brd ff:ff:ff:ff:ff:ff</div><div class="line">  inet 192.168.2.129/24 brd 192.168.2.255 scope global eth3</div><div class="line">  inet 192.168.2.120/32 scope global eth3</div><div class="line">  inet6 fe80::20c:29ff:fe6c:dceb/64 scope link</div><div class="line">  valid_lft forever preferred_lft forever</div><div class="line"></div><div class="line">shell&gt; pidof keepalived |wc -w</div><div class="line">3</div><div class="line"><span class="comment">##共启动3个进程:</span></div><div class="line"><span class="comment">##  一个父进程，负责监控其子进程;</span></div><div class="line"><span class="comment">##  vrrp子进程;</span></div><div class="line"><span class="comment">##  checkers子进程</span></div></pre></td></tr></table></figure><h2 id="KeepAlived-backup-configure"><a href="#KeepAlived-backup-configure" class="headerlink" title="KeepAlived backup configure"></a>KeepAlived backup configure</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#/etc/keepalived/keepalived.conf</div><div class="line">## 修改Master配置文件以下几项即可：</div><div class="line">global_defs &#123;</div><div class="line">router_id LVS_backup</div><div class="line">&#125;</div><div class="line"></div><div class="line">vrrp_instance VI_1 &#123;</div><div class="line">  interface eth0</div><div class="line">  state BACKUP</div><div class="line">  priority 50</div><div class="line"></div><div class="line">  notify_master /etc/keepalived/be_master.sh</div><div class="line">  notify_backup /etc/keepalived/be_backup.sh</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">shell&gt; /etc/init.d/keepalived start</div><div class="line">shell&gt; ip a s eth4</div><div class="line">2: eth4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</div><div class="line">  link/ether 00:50:56:3d:a5:e6 brd ff:ff:ff:ff:ff:ff</div><div class="line">  inet 192.168.2.128/24 brd 192.168.2.255 scope global eth4</div><div class="line">  inet6 fe80::250:56ff:fe3d:a5e6/64 scope link</div><div class="line">  valid_lft forever preferred_lft forever</div></pre></td></tr></table></figure><h2 id="all-web-server"><a href="#all-web-server" class="headerlink" title="all web server"></a>all web server</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">VIP=<span class="string">'192.168.2.120'</span></div><div class="line">ip addr add <span class="variable">$VIP</span> dev lo</div><div class="line"> <span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore</div><div class="line"> <span class="built_in">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/lo/arp_announce</div><div class="line"> <span class="built_in">echo</span> <span class="string">"1"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_ignore</div><div class="line"> <span class="built_in">echo</span> <span class="string">"2"</span> &gt;/proc/sys/net/ipv4/conf/all/arp_announce</div><div class="line"> sysctl -p &gt;/dev/null 2&gt;&amp;1</div></pre></td></tr></table></figure><p>test web page<br><img src="/2017/07/05/keepalived-lvs/./pic2.png" alt=""></p><h2 id="模拟KeepAlived故障"><a href="#模拟KeepAlived故障" class="headerlink" title="模拟KeepAlived故障"></a>模拟KeepAlived故障</h2><p>stop lvs_master keepslaved<br><img src="/2017/07/05/keepalived-lvs/./pic3.png" alt=""></p><p>lvs_backup:<br><img src="/2017/07/05/keepalived-lvs/./pic4.png" alt=""></p><p>关闭lvs_master之后 lvs_backup 自动接管vip并开始接受请求;<br>可以看到当backup接管master时，发出了邮件<br><img src="/2017/07/05/keepalived-lvs/./pic5.png" alt=""></p><p>当master恢复后，backup会被接管;<br><img src="/2017/07/05/keepalived-lvs/./pic6.png" alt=""></p><p><img src="/2017/07/05/keepalived-lvs/./pic7.png" alt=""></p><h2 id="模拟-web-server故障"><a href="#模拟-web-server故障" class="headerlink" title="模拟 web server故障"></a>模拟 web server故障</h2><p>关闭web1后，自动将服务器从virtual server table里面移除，此时只能访问web2;<br>web1恢复后会自动添加到virtual server table<br><img src="/2017/07/05/keepalived-lvs/./pic8.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LVS </tag>
            
            <tag> keepalived </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Varnish</title>
      <link href="/2017/06/28/Varnish/"/>
      <url>/2017/06/28/Varnish/</url>
      
        <content type="html"><![CDATA[<h2 id="Varnish-cache"><a href="#Varnish-cache" class="headerlink" title="Varnish cache"></a>Varnish cache</h2><pre><code>或称Varnish，是一套高性能的反向网站缓存服务器（reverse proxy server）。Varnish目前被用在挪威最大的报社Verdens Gang上。</code></pre><h2 id="Dependence"><a href="#Dependence" class="headerlink" title="Dependence"></a>Dependence</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">yum install -y ncurses-devel libedit-devel pcre*</div><div class="line"></div><div class="line">## setup Python3</div><div class="line">```bash</div><div class="line">wget https://www.python.org/ftp/python/3.5.0/Python-3.5.0.tar.xz</div><div class="line">./configure --prefix=/usr/local/python3 &amp;&amp; make -j4</div><div class="line">make -j4 install</div></pre></td></tr></table></figure><h2 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">curl -s https://packagecloud.io/install/repositories/varnishcache/varnish5/script.rpm.sh | sudo bash</div><div class="line"></div><div class="line">OR</div><div class="line"></div><div class="line">wget https://repo.varnish-cache.org/source/varnish-5.1.2.tar.gz</div><div class="line">tar czf varnish-5.1.2.tar.gz</div><div class="line">./autogen.sh</div><div class="line">./configure &amp;&amp; make -j4</div><div class="line">make -j4 install</div></pre></td></tr></table></figure><h2 id="varnish-vcl"><a href="#varnish-vcl" class="headerlink" title="varnish.vcl"></a>varnish.vcl</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">vcl 4.0;</div><div class="line"></div><div class="line">backend default &#123;</div><div class="line">  .host = "192.168.1.252";</div><div class="line">  .port = "3000";</div><div class="line">&#125;</div><div class="line"></div><div class="line">sub vcl_backend_response &#123;</div><div class="line">  set beresp.ttl = 10s;</div><div class="line">  set beresp.grace = 1h;</div><div class="line">&#125;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">varnishd <span class="_">-f</span> /varnish/varnish.vcl <span class="_">-s</span> malloc,1G -T 127.0.0.1:2000 <span class="_">-a</span> :80</div><div class="line"><span class="comment">## 通过配置文件启动</span></div><div class="line"></div><div class="line">varnishd <span class="_">-s</span> malloc,1G -T 127.0.0.1:2000 <span class="_">-a</span> :80 -b 192.168.1.28:3000</div><div class="line"><span class="comment">## 1G内存作为缓存，监听本地80端口，代理192.168.1.28:3000</span></div></pre></td></tr></table></figure><h2 id="Usage-varnishd-options"><a href="#Usage-varnishd-options" class="headerlink" title="Usage: varnishd [options]"></a>Usage: varnishd [options]</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">Basic options:</div><div class="line">  -a address[:port][,proto] # HTTP listen address and port</div><div class="line">  # Can be specified multiple times.</div><div class="line">  # default: ":80,HTTP/1"</div><div class="line">  -b address[:port] # Backend address and port</div><div class="line">  # default: ":80"</div><div class="line">  -f vclfile # VCL program</div><div class="line">  # Can be specified multiple times.</div><div class="line">  -n dir # Working directory</div><div class="line"></div><div class="line">-b can be used only once, and not together with -f</div><div class="line"></div><div class="line">Documentation options:</div><div class="line">  -? # Prints this usage message</div><div class="line">  -x parameter # Parameter documentation</div><div class="line">  -x vsl # VSL record documentation</div><div class="line">  -x cli # CLI command documentation</div><div class="line">  -x builtin # Builtin VCL program</div><div class="line"></div><div class="line">Operations options:</div><div class="line">  -F # Run in foreground</div><div class="line">  -T address[:port] # CLI address</div><div class="line">  # Can be specified multiple times.</div><div class="line">  -M address:port # Reverse CLI destination</div><div class="line">  # Can be specified multiple times.</div><div class="line">  -P file # PID file</div><div class="line">  -i identity # Identity of varnish instance</div><div class="line">  -I clifile # Initialization CLI commands</div><div class="line"></div><div class="line">Tuning options:</div><div class="line">  -t TTL # Default TTL</div><div class="line">  -p param=value # set parameter</div><div class="line">  # Can be specified multiple times.</div><div class="line">  -s [name=]kind[,options] # Storage specification</div><div class="line">  # Can be specified multiple times.</div><div class="line">  # -s malloc</div><div class="line">  # -s file</div><div class="line">  -l vsl[,vsm] # Size of shared memory file</div><div class="line">  # vsl: space for VSL records [80m]</div><div class="line">  # vsm: space for stats counters [1m]</div><div class="line"></div><div class="line">Security options:</div><div class="line">  -r param[,param...] # Set parameters read-only from CLI</div><div class="line">  # Can be specified multiple times.</div><div class="line">  -S secret-file # Secret file for CLI authentication</div><div class="line">  -j jail[,options] # Jail specification</div><div class="line">  # -j unix</div><div class="line">  # -j none</div><div class="line"></div><div class="line">Advanced/Dev/Debug options:</div><div class="line">  -d # debug mode</div><div class="line">  # Stay in forground, CLI on stdin.</div><div class="line">  -C # Output VCL code compiled to C language</div><div class="line">  -V # version</div><div class="line">  -h kind[,options] # Hash specification</div><div class="line">  -W waiter # Waiter implementation</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> web </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cache </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>unsion</title>
      <link href="/2017/06/26/unsion/"/>
      <url>/2017/06/26/unsion/</url>
      
        <content type="html"><![CDATA[<h2 id="Unison"><a href="#Unison" class="headerlink" title="Unison"></a>Unison</h2><p>Unison是一款跨windows/linux/MAC OS平台的文件同步工具，不仅支持本地对本地同步，也支持通过SSH、RSH和Socket等网络协议进行同步，并且Unison支持双向同步操作。</p><h2 id="binnary"><a href="#binnary" class="headerlink" title="binnary"></a>binnary</h2><p>wget <a href="http://www.cis.upenn.edu/~bcpierce/unison/download/releases/unison-2.9.1/unison.linux-static-textui" target="_blank" rel="external">http://www.cis.upenn.edu/~bcpierce/unison/download/releases/unison-2.9.1/unison.linux-static-textui</a><br>chmod +x unison.linux-static-textui<br>./unison.linux-static-textui -version &amp;&amp; cp ./unison.linux-static-textui /usr/bin/unison</p><h2 id="source"><a href="#source" class="headerlink" title="source"></a>source</h2><h3 id="CentOS"><a href="#CentOS" class="headerlink" title="CentOS"></a>CentOS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#2.45.28 是 CentOS 下可成功 compile 的最新版本, compile 需安裝 ocaml,</span></div><div class="line"><span class="comment">#它是用 Objective Caml 寫的</span></div><div class="line"></div><div class="line"><span class="comment">#之後的版本都會出現如下錯誤</span></div><div class="line"><span class="comment">#File "unison-2.48.3/fsmonitor/linux/watcher.ml", line 55, characters 5-10:</span></div><div class="line"><span class="comment">#Error: Syntax error</span></div><div class="line"></div><div class="line">http://www.cis.upenn.edu/~bcpierce/unison/download/releases/</div><div class="line">wget http://www.cis.upenn.edu/~bcpierce/unison/download/releases/unison-2.45.28/unison-2.45.28.tar.gz</div><div class="line"></div><div class="line">tar xzf unison-2.45.28.tar.gz &amp;&amp; make</div><div class="line">cp ./unison /usr/bin/</div><div class="line">unison -version</div></pre></td></tr></table></figure><h2 id="Local-and-Remote"><a href="#Local-and-Remote" class="headerlink" title="Local and Remote"></a>Local and Remote</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">unison -batch -prefer newer /home/dir/ ssh://192.168.1.2//home/dir/</div></pre></td></tr></table></figure><h2 id="unison-options"><a href="#unison-options" class="headerlink" title="unison options"></a>unison options</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">Usage: unison [options]</div><div class="line">    or unison root1 root2 [options]</div><div class="line">    or unison profilename [options]</div><div class="line"></div><div class="line">Options: </div><div class="line">  -addprefsto xxx     file to add new prefs to</div><div class="line">  -addversionno       add version number to name of unison executable on server</div><div class="line">  -auto               automatically accept default actions</div><div class="line">  -backup xxx         add a regexp to the backup list</div><div class="line">  -backups            keep backup copies of files (deprecated: use 'backup')</div><div class="line">  -batch              batch mode: ask no questions at all</div><div class="line">  -contactquietly      Suppress the 'contacting server' message during startup</div><div class="line">  -debug xxx          debug module xxx ('all' -&gt; everything, 'verbose' -&gt; more)</div><div class="line">  -doc xxx            show documentation ('-doc topics' lists topics)</div><div class="line">  -dumbtty            do not try to change terminal settings in text UI</div><div class="line">  -editor xxx         command for displaying the output of the merge program</div><div class="line">  -fastcheck xxx      do fast update detection (`true', `false', or `default')</div><div class="line">  -follow xxx         add a regexp to the follow list</div><div class="line">  -force xxx          force changes from this replica to the other</div><div class="line">  -group              synchronize group</div><div class="line">  -height n           height (in lines) of main window in graphical interface</div><div class="line">  -ignore xxx         add a regexp to the ignore list</div><div class="line">  -ignorecase         ignore upper/lowercase spelling of filenames</div><div class="line">  -ignorenot xxx      add a regexp to the ignorenot list</div><div class="line">  -key xxx            define a keyboard shortcut for this profile</div><div class="line">  -killserver         kill server when done (even when using sockets)</div><div class="line">  -label xxx          provide a descriptive string label for this profile</div><div class="line">  -log                record actions in file specified by logfile preference</div><div class="line">  -logfile xxx        Log file name</div><div class="line">  -maxbackups n       number of backed up versions of a file</div><div class="line">  -merge xxx          command for merging conflicting files</div><div class="line">  -merge2 xxx         command for merging files (when no common version exists)</div><div class="line">  -numericids         don't map uid/gid values by user/group names</div><div class="line">  -owner              synchronize owner</div><div class="line">  -path xxx           path to synchronize</div><div class="line">  -perms n            part of the permissions which is synchronized</div><div class="line">  -prefer xxx         choose this replica's version for conflicting changes</div><div class="line">  -root xxx           root of a replica</div><div class="line">  -rootalias xxx      Register alias for canonical root names</div><div class="line">  -rshargs xxx        other arguments (if any) for remote shell command</div><div class="line">  -rshcmd xxx         path to the rsh executable</div><div class="line">  -servercmd xxx      name of unison executable on remote server</div><div class="line">  -silent             print nothing (except error messages)</div><div class="line">  -socket xxx         act as a server on a socket</div><div class="line">  -sortbysize         list changed files by size, not name</div><div class="line">  -sortfirst xxx      add a regexp to the sortfirst list</div><div class="line">  -sortlast xxx       add a regexp to the sortlast list</div><div class="line">  -sortnewfirst       list new before changed files</div><div class="line">  -sshcmd xxx         path to the ssh executable</div><div class="line">  -statusdepth n      status display depth for local files</div><div class="line">  -terse              suppress status messages</div><div class="line">  -testserver         exit immediately after the connection to the server</div><div class="line">  -times              synchronize modification times</div><div class="line">  -ui xxx             select user interface ('text' or 'graphic')</div><div class="line">  -version            print version and exit</div><div class="line">  -xferbycopying      optimize transfers using local copies, if possible</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sync </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CPU IO priority</title>
      <link href="/2017/06/26/CPU-IO-priority/"/>
      <url>/2017/06/26/CPU-IO-priority/</url>
      
        <content type="html"><![CDATA[<h2 id="ionice"><a href="#ionice" class="headerlink" title="ionice"></a>ionice</h2><p>修改进程IO调度策略</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">ionice --help</div><div class="line"></div><div class="line">Usage:</div><div class="line"> ionice [options] -p &lt;pid&gt;...</div><div class="line"> ionice [options] -P &lt;pgid&gt;...</div><div class="line"> ionice [options] -u &lt;uid&gt;...</div><div class="line"> ionice [options] &lt;command&gt;</div><div class="line"></div><div class="line">Show or change the I/O-scheduling class and priority of a process.</div><div class="line"></div><div class="line">Options:</div><div class="line"> -c, --class &lt;class&gt; name or number of scheduling class,</div><div class="line">  0: none, 1: realtime, 2: best-effort, 3: idle</div><div class="line"> -n, --classdata &lt;num&gt; priority (0..7) in the specified scheduling class,</div><div class="line">  only for the realtime and best-effort classes</div><div class="line"> -p, --pid &lt;pid&gt;... act on these already running processes</div><div class="line"> -P, --pgid &lt;pgrp&gt;... act on already running processes in these groups</div><div class="line"> -t, --ignore ignore failures</div><div class="line"> -u, --uid &lt;uid&gt;... act on already running processes owned by these users</div><div class="line"></div><div class="line"> -h, --help display this help and exit</div><div class="line"> -V, --version output version information and exit</div><div class="line"></div><div class="line">For more details see ionice(1).</div><div class="line"></div><div class="line">ilde：</div><div class="line">空闲磁盘调度，该调度策略是在当前系统没有其他进程需要进行磁盘IO时，才能进行磁盘；因此该策略对当前系统的影响基本为0；当然，该调度策略不能带有任何优先级参数；目前，普通用户是可以使用该调度策略（自从内核2.6.25开始）。</div><div class="line"></div><div class="line">Best effort：</div><div class="line">是缺省的磁盘IO调度策略；(1)该调度策略可以指定优先级参数(范围是0~7，数值越小，优先级越高)；(2)针对处于同一优先级的程序将采round-robin方式；(3)对于best effort调度策略，8个优先级等级可以说明在给定的一个调度窗口中时间片的大小。(4)目前，普调用户(非root用户)是可以使用该调度策略。(5)在内核2.6.26之前，没有设置IO优先级的进程会使用“none”作为调度策略，但是这种策略使得进程看起来像是采用了best effort调度策略，因为其优先级是通过关于cpu nice有关的公式计算得到的：io_priority = (cpu_nice + 20) /5。(6)在内核2.6.26之后，如果当前系统使用的是CFQ调度器，那么如果进程没有设置IO优先级级别，将采用与内核2.6.26之前版本同样</div><div class="line">的方式，推到出io优先级级别。</div><div class="line"></div><div class="line">Real time：</div><div class="line">实时调度策略，如果设置了该磁盘IO调度策略，则立即访问磁盘，不管系统中其他进程是否有IO。因此使用实时调度策略，需要注意的是，该访问策略可能会使得其他进程处于等待状态。</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">shell&gt; ionice -c1 -n7 tail <span class="_">-f</span> /etc/passwd</div><div class="line"></div><div class="line">shell&gt; ps -aux |grep <span class="string">'/etc/passwd'</span></div><div class="line">root 7221 0.0 0.0 71252 4164 pts/31 S+ 12:09 0:00 sudo ionice -c1 -n7 tail <span class="_">-f</span> /etc/passwd</div><div class="line">root 7222 0.0 0.0 11448 684 pts/31 S+ 12:09 0:00 tail <span class="_">-f</span> /etc/passwd</div><div class="line">xy 7247 0.0 0.0 15956 2324 pts/28 S+ 12:10 0:00 grep --color=auto /etc/passwd</div><div class="line"></div><div class="line">shell&gt; ionice -p 7222</div><div class="line">realtime: prio 7</div><div class="line"></div><div class="line">shell&gt; ionice -p 6666 -c3</div><div class="line"><span class="comment">#修改PID:6666的IO调度策略为ilde</span></div></pre></td></tr></table></figure><h2 id="nice"><a href="#nice" class="headerlink" title="nice"></a>nice</h2><p>修改进程CPU调度策略<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">shell&gt; nice --help</div><div class="line">Usage: nice [OPTION] [COMMAND [ARG]...]</div><div class="line">Run COMMAND with an adjusted niceness, which affects process scheduling.</div><div class="line">With no COMMAND, print the current niceness. Niceness values range from</div><div class="line">-20 (most favorable to the process) to 19 (least favorable to the process).</div><div class="line"></div><div class="line">Mandatory arguments to long options are mandatory for short options too.</div><div class="line">  -n, --adjustment=N add integer N to the niceness (default 10)</div><div class="line">  --help display this help and exit</div><div class="line">  --version output version information and exit</div></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">nice -n -5 mysqld_safe</div><div class="line"><span class="comment">#OR</span></div><div class="line">nice --5 mysqld_safe</div></pre></td></tr></table></figure><h2 id="renice"><a href="#renice" class="headerlink" title="renice"></a>renice</h2><p>修改以及存在的进程CPU调度策略<br><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">shell&gt; renice --help</div><div class="line"></div><div class="line">Usage:</div><div class="line"> renice [-n] &lt;priority&gt; [-p|--pid] &lt;pid&gt;...</div><div class="line"> renice [-n] &lt;priority&gt; -g|--pgrp &lt;pgid&gt;...</div><div class="line"> renice [-n] &lt;priority&gt; -u|--user &lt;user&gt;...</div><div class="line"></div><div class="line">Alter the priority of running processes.</div><div class="line"></div><div class="line">Options:</div><div class="line"> -n, --priority &lt;num&gt; specify the nice increment value</div><div class="line"> -p, --pid &lt;id&gt; interpret argument as process ID (default)</div><div class="line"> -g, --pgrp &lt;id&gt; interpret argument as process group ID</div><div class="line"> -u, --user &lt;name&gt;|&lt;id&gt; interpret argument as username or user ID</div><div class="line"></div><div class="line"> -h, --help display this help and exit</div><div class="line"> -V, --version output version information and exit</div></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">renice -5 -p 6666</div><div class="line">OR</div><div class="line">renice -5 6666</div><div class="line"><span class="comment">#PID:6666 nice设置为-5</span></div></pre></td></tr></table></figure><h2 id="taskset"><a href="#taskset" class="headerlink" title="taskset"></a>taskset</h2><p>把进程运行到指定CPU（即修改进程的”CPU亲和性”）：<br>两个名词<br>SMP (Symmetrical Multi-Processing)：指在一个计算机上汇集了一组处理器(多CPU)，各CPU之间共享内存子系统以及总线结构<br>CPU affinity：中文唤作“CPU亲和性”，是指在CMP架构下，能够将一个或多个进程绑定到一个或多个处理器上运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">shell&gt; taskset -c -p 3 2362</div><div class="line">pid 2362<span class="string">'s current affinity list: 0-3</span></div><div class="line">pid 2362's new affinity list: 3</div><div class="line"><span class="comment">#指定PID 2362,到cpu#3上</span></div><div class="line"></div><div class="line"><span class="comment">#启动时指定</span></div><div class="line">taskset -c 1  mysqld_safe</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>freeNAS</title>
      <link href="/2017/06/19/freeNAS/"/>
      <url>/2017/06/19/freeNAS/</url>
      
        <content type="html"><![CDATA[<h2 id="freeNAS-ISO"><a href="#freeNAS-ISO" class="headerlink" title="freeNAS ISO"></a>freeNAS ISO</h2><p><a href="https://download.freenas.org/" target="_blank" rel="external">https://download.freenas.org/</a><br><a href="https://download.freenas.org/9.10/latest/x64/FreeNAS-9.10.2-U5.iso" target="_blank" rel="external">https://download.freenas.org/9.10/latest/x64/FreeNAS-9.10.2-U5.iso</a></p><h2 id="setup-iSCSI"><a href="#setup-iSCSI" class="headerlink" title="setup iSCSI"></a>setup iSCSI</h2><p>Sharing –&gt; Portals –&gt; Add Portal<br><img src="/2017/06/19/freeNAS/./pic0.png" alt="pic0"></p><p>Sharing –&gt; Initiators –&gt; Add Initiator<br><img src="/2017/06/19/freeNAS/./pic1.png" alt="pic1"></p><p>Sharing –&gt; Authorized Access –&gt; Add Authorized Access<br><img src="/2017/06/19/freeNAS/./pic2.png" alt="pic2"></p><p>Sharing –&gt; Targets –&gt; Add Target<br><img src="/2017/06/19/freeNAS/./pic3.png" alt="pic3"></p><p>Sharing –&gt; Extents –&gt; Add Extent<br><img src="/2017/06/19/freeNAS/./pic4.png" alt="pic4"></p><p>Sharing –&gt; Associated Targets –&gt; Add Target / Extent<br><img src="/2017/06/19/freeNAS/./pic5.png" alt="pic5"></p><h2 id="Ubuntu-iSCSI-Initiator"><a href="#Ubuntu-iSCSI-Initiator" class="headerlink" title="Ubuntu iSCSI Initiator"></a>Ubuntu iSCSI Initiator</h2><h2 id="install-iscsi"><a href="#install-iscsi" class="headerlink" title="install iscsi"></a>install iscsi</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt install open-iscsi -y</div></pre></td></tr></table></figure><h2 id="CHAP-Settings"><a href="#CHAP-Settings" class="headerlink" title="CHAP Settings"></a>CHAP Settings</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vim /etc/iscsi/iscsid.conf</div><div class="line">node.session.auth.authmethod = CHAP</div><div class="line">node.session.auth.username = xy</div><div class="line">node.session.auth.password = 123456789123</div><div class="line"></div><div class="line">/etc/init.d/open-iscsi start</div></pre></td></tr></table></figure><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">shell&gt; iscsiadm -m discovery -t sendtargets -p 192.168.2.130</div><div class="line">192.168.2.130:3260,257 iqn.test</div><div class="line"></div><div class="line">shell&gt; iscsiadm -m node -T iqn.test -p 192.168.2.130:3260 <span class="_">-l</span></div><div class="line">Logging <span class="keyword">in</span> to [iface: default, target: iqn.test, portal: 192.168.2.130,3260] (multiple)</div><div class="line">Login to [iface: default, target: iqn.test, portal: 192.168.2.130,3260] successful.</div><div class="line"></div><div class="line">shell&gt; lsblk</div><div class="line">NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINT</div><div class="line">sdb 8:16 0 931.5G 0 disk</div><div class="line">├─sdb2 8:18 0 881.5G 0 part</div><div class="line">│ ├─sysvg-lvswap 253:1 0 6G 0 lvm [SWAP]</div><div class="line">│ ├─sysvg-lvhome 253:2 0 500G 0 lvm /home</div><div class="line">│ └─sysvg-lvroot 253:0 0 50G 0 lvm /</div><div class="line">└─sdb1 8:17 0 50G 0 part</div><div class="line">sdc 8:32 0 1000M 0 disk</div><div class="line">└─sdc1 8:33 0 997M 0 part</div><div class="line">sda 8:0 0 119.2G 0 disk</div><div class="line">└─sda1 8:1 0 119.2G 0 part</div><div class="line"></div><div class="line">fdisk /dev/sdc</div><div class="line">mount /dev/sdc1 /mnt/</div><div class="line"></div><div class="line"><span class="comment">## logout</span></div><div class="line">shell&gt; iscsiadm -m node -T iqn.test -p 192.168.2.130:3260 -u</div></pre></td></tr></table></figure><h2 id="More"><a href="#More" class="headerlink" title="More"></a>More</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#登录</div><div class="line">iscsiadm –m node --targetname THE_TARGET_IQN --login</div><div class="line"></div><div class="line">#退出</div><div class="line">iscsiadm –m node --targetname THE_TARGET_IQN --logout</div><div class="line"></div><div class="line">#显示连接设置</div><div class="line">iscsiadm -m node -p 192.168.2.130 -o show</div><div class="line"></div><div class="line">#删除装置：</div><div class="line">iscsiadm –m node --op delete --targetname THE_TARGET_IQN</div></pre></td></tr></table></figure><h2 id="win7-iSCSI-Initiator"><a href="#win7-iSCSI-Initiator" class="headerlink" title="win7 iSCSI Initiator"></a>win7 iSCSI Initiator</h2><p>Run:<br>iscsicpl.exe</p><p>Refresh –&gt; Conect<br><img src="/2017/06/19/freeNAS/./win0.png" alt="win"></p><p>Advanced –&gt; Enable CHAP log on<br><img src="/2017/06/19/freeNAS/./win1.png" alt="win"></p><p>Initialize Disk<br><img src="/2017/06/19/freeNAS/./win2.png" alt="win"></p><p>New Simple Volume<br><img src="/2017/06/19/freeNAS/./win3.png" alt="win"><br><img src="/2017/06/19/freeNAS/./win4.png" alt="win"></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NAS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix discovery access user ip</title>
      <link href="/2017/06/19/zabbix-discovery-access-user-ip/"/>
      <url>/2017/06/19/zabbix-discovery-access-user-ip/</url>
      
        <content type="html"><![CDATA[<h2 id="zabbix-agentd-conf"><a href="#zabbix-agentd-conf" class="headerlink" title="zabbix_agentd.conf"></a>zabbix_agentd.conf</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">UserParameter=discovery.access,/script/discovery_access.sh</div><div class="line">UserParameter=check.access[*],/script/discovery_access.sh check <span class="formula">$1 $</span>2</div></pre></td></tr></table></figure><h2 id="bash-shell-script"><a href="#bash-shell-script" class="headerlink" title="bash shell script"></a>bash shell script</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/bin/bash</span></div><div class="line"><span class="comment">#discovery_access.sh</span></div><div class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin</div><div class="line">portarray=( $(awk <span class="string">'/Acc|Fai/ &#123;print $(NF-3)&#125;'</span> /var/<span class="built_in">log</span>/secure |sort |uniq) )</div><div class="line">length=<span class="variable">$&#123;#portarray[@]&#125;</span></div><div class="line"></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">zabbix_json</span></span>()&#123;</div><div class="line"><span class="built_in">printf</span> <span class="string">"&#123;\n"</span></div><div class="line"><span class="built_in">printf</span> <span class="string">'\t'</span><span class="string">"\"data\":["</span></div><div class="line"><span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$length</span>;i++))</div><div class="line"><span class="keyword">do</span></div><div class="line"><span class="built_in">printf</span> <span class="string">'\n\t\t&#123;'</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"\"&#123;#ACCESS_IP&#125;\":\"<span class="variable">$&#123;portarray[$i]&#125;</span>\"&#125;"</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$i</span> <span class="_">-lt</span> $[<span class="variable">$length</span>-1] ];<span class="keyword">then</span></div><div class="line"><span class="built_in">printf</span> <span class="string">','</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"\n\t]\n"</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"&#125;\n"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">function</span> <span class="function"><span class="title">check</span></span>()&#123;</div><div class="line"><span class="built_in">shift</span> 1</div><div class="line">awk <span class="string">"/<span class="variable">$1</span>/ &#123;print \$(NF-3)&#125;"</span> /var/<span class="built_in">log</span>/secure |grep <span class="variable">$2</span> |sort |uniq -c |awk <span class="string">'&#123;print $1&#125;'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">[[ <span class="variable">$1</span> = check ]] \</div><div class="line">&amp;&amp; check $* \</div><div class="line">|| zabbix_json</div></pre></td></tr></table></figure><h2 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">setfacl -m user:zabbix:r-- /var/<span class="built_in">log</span>/secure</div></pre></td></tr></table></figure><h2 id="zabbix-server"><a href="#zabbix-server" class="headerlink" title="zabbix server"></a>zabbix server</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">shell&gt; zabbix_get <span class="_">-s</span> localhost -k discovery.access</div><div class="line">&#123;</div><div class="line">     <span class="string">"data"</span>:[</div><div class="line">          &#123;<span class="string">"&#123;#ACCESS_IP&#125;"</span>:<span class="string">"192.168.1.128"</span>&#125;</div><div class="line">     ]</div><div class="line">&#125;</div><div class="line"></div><div class="line">shell&gt; zabbix_get <span class="_">-s</span> localhost -k check.access[Accepted,192.168.1.128]</div><div class="line">64</div><div class="line"></div><div class="line">shell&gt; zabbix_get <span class="_">-s</span> localhost -k check.access[Failed,192.168.1.128]</div><div class="line">1</div></pre></td></tr></table></figure><p>Discovery rules –&gt; Create discovesy rule<br><img src="/2017/06/19/zabbix-discovery-access-user-ip/./pic0.png" alt="pic0"></p><p>Item prototypes –&gt; Create item prototype<br><img src="/2017/06/19/zabbix-discovery-access-user-ip/./pic1.png" alt="pic1"><br><img src="/2017/06/19/zabbix-discovery-access-user-ip/./pic3.png" alt="pic3"></p><p>Latest data<br><img src="/2017/06/19/zabbix-discovery-access-user-ip/./pic2.png" alt="pic2"></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL Slow Query Monitor webpage</title>
      <link href="/2017/06/08/MySQL-Slow-Query-Monitor-webpage/"/>
      <url>/2017/06/08/MySQL-Slow-Query-Monitor-webpage/</url>
      
        <content type="html"><![CDATA[<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- install.sql</span></div><div class="line"><span class="comment">-- Create the database needed for the Query-Digest-UI</span></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> slow_query_log;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> slow_query_log;</div><div class="line"><span class="keyword">USE</span> slow_query_log;</div><div class="line"></div><div class="line"><span class="comment">-- Create the global query review table</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`global_query_review`</span> (</div><div class="line">  <span class="string">`checksum`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`fingerprint`</span> <span class="built_in">text</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`sample`</span> longtext <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`first_seen`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`last_seen`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`reviewed_by`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`reviewed_on`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`comments`</span> <span class="built_in">text</span>,</div><div class="line">  <span class="string">`reviewed_status`</span> <span class="built_in">varchar</span>(<span class="number">24</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`checksum`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div><div class="line"></div><div class="line"><span class="comment">-- Create the historical query review table</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`global_query_review_history`</span> (</div><div class="line">  <span class="string">`hostname_max`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`db_max`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`checksum`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`sample`</span> longtext <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`ts_min`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0000-00-00 00:00:00'</span>,</div><div class="line">  <span class="string">`ts_max`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0000-00-00 00:00:00'</span>,</div><div class="line">  <span class="string">`ts_cnt`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Query_time_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Query_time_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Query_time_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Query_time_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Query_time_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Query_time_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Lock_time_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Lock_time_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Lock_time_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Lock_time_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Lock_time_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Lock_time_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_sent_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_sent_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_sent_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_sent_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_sent_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_sent_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_examined_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_examined_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_examined_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_examined_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_examined_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_examined_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_affected_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_affected_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_affected_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_affected_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_affected_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_affected_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_read_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_read_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_read_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_read_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_read_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Rows_read_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Merge_passes_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Merge_passes_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Merge_passes_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Merge_passes_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Merge_passes_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Merge_passes_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_ops_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_ops_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_ops_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_bytes_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_bytes_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_bytes_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_wait_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_wait_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_wait_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_ops_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_ops_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_bytes_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_bytes_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_wait_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_IO_r_wait_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_rec_lock_wait_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_rec_lock_wait_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_rec_lock_wait_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_rec_lock_wait_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_rec_lock_wait_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_queue_wait_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_queue_wait_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_queue_wait_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_queue_wait_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_queue_wait_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_pages_distinct_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_pages_distinct_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_pages_distinct_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_pages_distinct_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`InnoDB_pages_distinct_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`QC_Hit_cnt`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`QC_Hit_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Full_scan_cnt`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Full_scan_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Full_join_cnt`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Full_join_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Tmp_table_cnt`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Tmp_table_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Filesort_cnt`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Filesort_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Tmp_table_on_disk_cnt`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Tmp_table_on_disk_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Filesort_on_disk_cnt`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Filesort_on_disk_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Bytes_sum`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Bytes_min`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Bytes_max`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Bytes_pct_95`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Bytes_stddev`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`Bytes_median`</span> <span class="built_in">float</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`hostname_max`</span> (<span class="string">`hostname_max`</span>,<span class="string">`checksum`</span>,<span class="string">`ts_min`</span>,<span class="string">`ts_max`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`ts_min`</span> (<span class="string">`ts_min`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`checksum`</span> (<span class="string">`checksum`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql &lt; install.sql</div><div class="line">mysql <span class="_">-e</span> <span class="string">"grant ALL ON slow_query_log.* to 'slowlog'@'localhost' IDENTIFIED BY '123456';flush privileges;"</span></div></pre></td></tr></table></figure><h2 id="Query-Digest-UI"><a href="#Query-Digest-UI" class="headerlink" title="Query-Digest-UI"></a>Query-Digest-UI</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> https://github.com/kormoc/Query-Digest-UI.git</div><div class="line"><span class="built_in">cd</span> Query-Digest-UI</div><div class="line">cp config.php.example config.php</div><div class="line"></div><div class="line"><span class="comment"># configure</span></div><div class="line">vi config.php</div><div class="line"><span class="variable">$reviewhost</span> = array(</div><div class="line">// Replace hostname and database <span class="keyword">in</span> this setting</div><div class="line">// use host=hostname;port=portnum <span class="keyword">if</span> not the default port</div><div class="line">  <span class="string">'dsn'</span> =&gt; <span class="string">'mysql:host=192.168.1.190;port=3306;dbname=slow_query_log'</span>,</div><div class="line">  <span class="string">'user'</span> =&gt; <span class="string">'slowlog'</span>,</div><div class="line">  <span class="string">'password'</span> =&gt; <span class="string">'123456'</span>,</div><div class="line">// See http://www.percona.com/doc/percona-toolkit/2.1/pt-query-digest.html<span class="comment">#cmdoption-pt-query-digest--review</span></div><div class="line">  <span class="string">'review_table'</span> =&gt; <span class="string">'global_query_review'</span>,</div><div class="line">// This table is optional. You don<span class="string">'t need it, but you lose detailed stats</span></div><div class="line">// Set to a blank string to disable</div><div class="line">// See http://www.percona.com/doc/percona-toolkit/2.1/pt-query-digest.html#cmdoption-pt-query-digest--review-history</div><div class="line">  'history_table<span class="string">' =&gt; '</span>global_query_review_history<span class="string">',</span></div><div class="line">);</div></pre></td></tr></table></figure><p><img src="/2017/06/08/MySQL-Slow-Query-Monitor-webpage/./pic0.png" alt="pic0"></p><h2 id="Anemometer"><a href="#Anemometer" class="headerlink" title="Anemometer"></a>Anemometer</h2><p>Put some data in the DB<br>Next, grab that slow query log file you have (mine’s called “slow.log”!), and run pt-query-digest on it: NOTE: I’m using a BASH 3.0 shell here on my MySQL database server! This is so the “$HOSTNAME” variable properly replaces with “db.example.com”)</p><ul><li>For pt-query-digest version &lt; 2.2</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ pt-query-digest --user=anemometer --password=superSecurePass \</div><div class="line">  --review h=db.example.com,D=slow_query_log,t=global_query_review \</div><div class="line">  --review-history h=db.example.com,D=slow_query_log,t=global_query_review_history \</div><div class="line">  --no-report --limit=0% \</div><div class="line">  --filter=<span class="string">" \$event-&gt;&#123;Bytes&#125; = length(\$event-&gt;&#123;arg&#125;) and \$event-&gt;&#123;hostname&#125;=\"<span class="variable">$HOSTNAME</span>\""</span> \</div><div class="line">  /var/lib/mysql/db.example.com-slow.log</div></pre></td></tr></table></figure><ul><li>For pt-query-digest version &gt;= 2.2<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ pt-query-digest --user=anemometer --password=superSecurePass \</div><div class="line">  --review h=db.example.com,D=slow_query_log,t=global_query_review \</div><div class="line">  --history h=db.example.com,D=slow_query_log,t=global_query_review_history \</div><div class="line">  --no-report --limit=0% \</div><div class="line">  --filter=<span class="string">" \$event-&gt;&#123;Bytes&#125; = length(\$event-&gt;&#123;arg&#125;) and \$event-&gt;&#123;hostname&#125;=\"<span class="variable">$HOSTNAME</span>\""</span> \</div><div class="line">  /var/lib/mysql/db.example.com-slow.log</div><div class="line">Pipeline process 11 (aggregate fingerprint) caused an error: Argument <span class="string">"57A"</span> isn<span class="string">'t numeric in numeric gt (&gt;) at (eval 40) line 6, &lt;&gt; line 27.</span></div><div class="line">Pipeline process 11 (aggregate fingerprint) caused an error: Argument "57B" isn't numeric <span class="keyword">in</span> numeric gt (&gt;) at (<span class="built_in">eval</span> 40) line 6, &lt;&gt; line 28.</div><div class="line">Pipeline process 11 (aggregate fingerprint) caused an error: Argument <span class="string">"57C"</span> isn<span class="string">'t numeric in numeric gt (&gt;) at (eval 40) line 6, &lt;&gt; line 29.</span></div></pre></td></tr></table></figure></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git <span class="built_in">clone</span> https://github.com/box/Anemometer.git anemometer</div><div class="line"><span class="built_in">cd</span> anemometer</div><div class="line">cp sample.config.inc.php config.inc.php</div></pre></td></tr></table></figure><p>configure<br><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">vi config.inc.php</div><div class="line">#45</div><div class="line"><span class="formula">$conf['datasources']['mysql56'] = array(</span></div><div class="line">  'host' =&gt; '127.0.0.1',</div><div class="line">  'port' =&gt; 3333,</div><div class="line">  'db' =&gt; 'slow_query_log',</div><div class="line">  'user' =&gt; 'slowlog',</div><div class="line">  'password' =&gt; '123456',</div><div class="line">  'tables' =&gt; array(</div><div class="line">  'global_query_review' =&gt; 'fact',</div><div class="line">  'global_query_review_history' =&gt; 'dimension'</div><div class="line">  ),</div><div class="line">  'source_type' =&gt; 'slow_query_log'</div><div class="line">);</div><div class="line"></div><div class="line">#286</div><div class="line">$conf['plugins'] = array(</div><div class="line">  ...</div><div class="line">  'explain' =&gt; function (<span class="formula">$sample) &#123;</span></div><div class="line">  $conn['host'] = '127.0.0.1';</div><div class="line">  <span class="formula">$conn['port'] = 3333 ;</span></div><div class="line">  $conn['db'] = 'slow_query_log';</div><div class="line">  <span class="formula">$conn['user'] = 'slowlog';</span></div><div class="line">  $conn['password'] = '123456';</div><div class="line">  return <span class="formula">$conn;</span></div><div class="line">## fix Error in Query Explain Plugin: Missing field host</div><div class="line">#http://www.it165.net/database/html/201604/15309.html</div><div class="line"></div><div class="line">  $conn['user'] = 'slowlog';</div><div class="line">  <span class="formula">$conn['password'] = '123456';</span></div><div class="line"></div><div class="line">  return $conn;</div><div class="line">  &#125;,</div><div class="line">);</div></pre></td></tr></table></figure></p><p><img src="/2017/06/08/MySQL-Slow-Query-Monitor-webpage/./pic1.png" alt="pic1"></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix discovery tcp status</title>
      <link href="/2017/06/08/zabbix-discovery-tcp-status/"/>
      <url>/2017/06/08/zabbix-discovery-tcp-status/</url>
      
        <content type="html"><![CDATA[<h2 id="zabbix-agentd-conf"><a href="#zabbix-agentd-conf" class="headerlink" title="zabbix_agentd.conf"></a>zabbix_agentd.conf</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">UserParameter=discovery.tcp_status,/script/discovery_tcp_status.sh</div><div class="line">UserParameter=tcp_status.check[*],/script/tcp_status_check.sh <span class="formula">$1</span></div></pre></td></tr></table></figure><h2 id="discovery-tcp-status-sh"><a href="#discovery-tcp-status-sh" class="headerlink" title="discovery_tcp_status.sh"></a>discovery_tcp_status.sh</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">export</span> PATH=/bin:/sbin:/usr/sbin:/usr/bin</div><div class="line"><span class="comment">#/bin/bash</span></div><div class="line">portarray=( $(ss -nt |awk <span class="string">'&#123;print $1&#125;'</span> |sort -u) )</div><div class="line">length=<span class="variable">$&#123;#portarray[@]&#125;</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"&#123;\n"</span></div><div class="line"><span class="built_in">printf</span> <span class="string">'\t'</span><span class="string">"\"data\":["</span></div><div class="line"><span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$length</span>;i++))</div><div class="line">  <span class="keyword">do</span></div><div class="line">  <span class="built_in">printf</span> <span class="string">'\n\t\t&#123;'</span></div><div class="line">  <span class="built_in">printf</span> <span class="string">"\"&#123;#TCP_STATUS&#125;\":\"<span class="variable">$&#123;portarray[$i]&#125;</span>\"&#125;"</span></div><div class="line">  <span class="keyword">if</span> [ <span class="variable">$i</span> <span class="_">-lt</span> $[<span class="variable">$length</span>-1] ];<span class="keyword">then</span></div><div class="line">  <span class="built_in">printf</span> <span class="string">','</span></div><div class="line">  <span class="keyword">fi</span></div><div class="line">  <span class="keyword">done</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"\n\t]\n"</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"&#125;\n"</span></div></pre></td></tr></table></figure><h2 id="tcp-status-check-sh"><a href="#tcp-status-check-sh" class="headerlink" title="tcp_status_check.sh"></a>tcp_status_check.sh</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="built_in">export</span> PATH=/bin:/sbin:/usr/sbin:/usr/bin</div><div class="line">ss -nt | awk <span class="string">'&#123;++s[$1]&#125; END &#123;for(k in s) print k,s[k]&#125;'</span> | awk <span class="string">"/<span class="variable">$1</span>/ &#123;print \$NF&#125;"</span></div></pre></td></tr></table></figure><h1 id="zabbix-server"><a href="#zabbix-server" class="headerlink" title="zabbix server"></a>zabbix server</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">shell&gt; zabbix_get <span class="_">-s</span> localhost -k discovery.tcp_status</div><div class="line">&#123;</div><div class="line">    <span class="string">"data"</span>:[</div><div class="line">        &#123;<span class="string">"&#123;#TCP_STATUS&#125;"</span>:<span class="string">"ESTAB"</span>&#125;,</div><div class="line">        &#123;<span class="string">"&#123;#TCP_STATUS&#125;"</span>:<span class="string">"LAST-ACK"</span>&#125;,</div><div class="line">        &#123;<span class="string">"&#123;#TCP_STATUS&#125;"</span>:<span class="string">"SYN-SENT"</span>&#125;,</div><div class="line">        &#123;<span class="string">"&#123;#TCP_STATUS&#125;"</span>:<span class="string">"State"</span>&#125;</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line"></div><div class="line">shell&gt; zabbix_get <span class="_">-s</span> localhost -k tcp_status.check[ESTAB]</div><div class="line">60</div></pre></td></tr></table></figure><h2 id="Create-discovery-rule"><a href="#Create-discovery-rule" class="headerlink" title="Create discovery rule"></a>Create discovery rule</h2><p>Discovery rules –&gt;Create discovery rule<br><img src="/2017/06/08/zabbix-discovery-tcp-status/./pic0.png" alt="pic0"></p><p>Item prototypes –&gt; Create item prototype<br><img src="/2017/06/08/zabbix-discovery-tcp-status/./pic1.png" alt="pic1"></p><p>Trigger prototypes –&gt; Create trigger prototype<br><img src="/2017/06/08/zabbix-discovery-tcp-status/./pic2.png" alt="pic2"></p><p>Latest data<br><img src="/2017/06/08/zabbix-discovery-tcp-status/./pic3.png" alt="pic3"></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Grafana configure</title>
      <link href="/2017/05/27/Grafana-configure/"/>
      <url>/2017/05/27/Grafana-configure/</url>
      
        <content type="html"><![CDATA[<h2 id="set-Templating"><a href="#set-Templating" class="headerlink" title="set Templating"></a>set Templating</h2><p>设置模板<br><img src="/2017/05/27/Grafana-configure/./g1.png" alt="pic"></p><h2 id="Graph-–-gt-General-–-gt-Repeat-Panel"><a href="#Graph-–-gt-General-–-gt-Repeat-Panel" class="headerlink" title="Graph –&gt; General –&gt; Repeat Panel"></a>Graph –&gt; General –&gt; Repeat Panel</h2><p>配置重复数据源<br><img src="/2017/05/27/Grafana-configure/./g2.png" alt="pic"></p><h2 id="Metrics-–-gt-Query-Mode-–-gt-Metrics"><a href="#Metrics-–-gt-Query-Mode-–-gt-Metrics" class="headerlink" title="Metrics –&gt; Query Mode –&gt; Metrics"></a>Metrics –&gt; Query Mode –&gt; Metrics</h2><p><img src="/2017/05/27/Grafana-configure/./g3.png" alt="pic"></p><p>通过”sa_process”选框即可按进程筛选:<br><img src="/2017/05/27/Grafana-configure/./g4.png" alt="pic"></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Grafana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix restart agentd services</title>
      <link href="/2017/05/27/zabbix-restart-agentd-services/"/>
      <url>/2017/05/27/zabbix-restart-agentd-services/</url>
      
        <content type="html"><![CDATA[<h2 id="zabbix-agentd-conf"><a href="#zabbix-agentd-conf" class="headerlink" title="zabbix_agentd.conf"></a>zabbix_agentd.conf</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">EnableRemoteCommands=1</div></pre></td></tr></table></figure><h2 id="etc-sudoers"><a href="#etc-sudoers" class="headerlink" title="/etc/sudoers"></a>/etc/sudoers</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">zabbix ALL=NOPASSWD: /usr/bin/python</div><div class="line"></div><div class="line">##注释掉如下一行，否则命令无法执行：</div><div class="line"># Default requiretty</div></pre></td></tr></table></figure><h2 id="zabbix-web"><a href="#zabbix-web" class="headerlink" title="zabbix web"></a>zabbix web</h2><p>Configuration–&gt; Actions–&gt; Create action<br>Conditions:可以加入更多信息，使判断更具针对性<br><img src="/2017/05/27/zabbix-restart-agentd-services/./zabbix0.png" alt="pic"></p><h3 id="Operations"><a href="#Operations" class="headerlink" title="Operations:"></a>Operations:</h3><p>每分钟执行一次commands，一共执行5次，条件不存在则中断commands<br><img src="/2017/05/27/zabbix-restart-agentd-services/./zabbix1.png" alt="pic"></p><h3 id="Action-logs"><a href="#Action-logs" class="headerlink" title="Action logs:"></a>Action logs:</h3><p>可以看到已经触发动作;<br><img src="/2017/05/27/zabbix-restart-agentd-services/./zabbix2.png" alt="pic"></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>grafana-zabbix</title>
      <link href="/2017/05/27/grafana-zabbix/"/>
      <url>/2017/05/27/grafana-zabbix/</url>
      
        <content type="html"><![CDATA[<h2 id="install-grafana-server"><a href="#install-grafana-server" class="headerlink" title="install grafana server"></a>install grafana server</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-4.3.1-1.x86_64.rpm</div><div class="line">sudo yum localinstall grafana-4.3.1-1.x86_64.rpm</div><div class="line"></div><div class="line"><span class="comment">#Installing on a local Grafana:</span></div><div class="line">grafana-cli plugins install alexanderzobnin-zabbix-app</div></pre></td></tr></table></figure><h2 id="Enable-it"><a href="#Enable-it" class="headerlink" title="Enable it"></a>Enable it</h2><p>Next, log into your Grafana instance. Navigate to the <img src="/2017/05/27/grafana-zabbix/./pic0.png" alt="pic0"> section, found in your Grafana main menu.</p><p>Click the Apps tabs in the Plugins section and select the newly installed app.<br>To enable the app, click the Config tab. Follow the instructions provided with the application and click Enable. The app and any new UI pages are now accessible from within the main menu, as designed by the app creator.</p><h2 id="configure-with-web-interface"><a href="#configure-with-web-interface" class="headerlink" title="configure with web interface"></a>configure with web interface</h2><p><img src="/2017/05/27/grafana-zabbix/./pic1.png" alt="pic1"></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
            <tag> grafana </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix discovery network interface IPaddr</title>
      <link href="/2017/05/27/zabbix-discovery-network-interface-IPaddr/"/>
      <url>/2017/05/27/zabbix-discovery-network-interface-IPaddr/</url>
      
        <content type="html"><![CDATA[<h2 id="zabbix-agentd-conf"><a href="#zabbix-agentd-conf" class="headerlink" title="zabbix_agentd.conf"></a>zabbix_agentd.conf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">UserParameter=discovery.ifdrive,/usr/local/etc/script/discovery_ifdrive.sh</div><div class="line">UserParameter=ipv4addr.check[*],/usr/local/etc/script/ipv4addr_check.sh $1</div><div class="line"></div><div class="line">restart zabbix_agentd.conf</div></pre></td></tr></table></figure><h2 id="bash-script"><a href="#bash-script" class="headerlink" title="bash script"></a>bash script</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">#/bin/bash</div><div class="line">#discovery_ifdrive.sh</div><div class="line">portarray=( $(ip ad |grep -v inet6 | awk &apos;/inet/ &#123;print $NF&#125;&apos;) )</div><div class="line">length=$&#123;#portarray[@]&#125;</div><div class="line">printf &quot;&#123;\n&quot;</div><div class="line">printf &apos;\t&apos;&quot;\&quot;data\&quot;:[&quot;</div><div class="line">for ((i=0;i&lt;$length;i++))</div><div class="line">  do</div><div class="line">  printf &apos;\n\t\t&#123;&apos;</div><div class="line">  printf &quot;\&quot;&#123;#IF_DRIVE&#125;\&quot;:\&quot;$&#123;portarray[$i]&#125;\&quot;&#125;&quot;</div><div class="line">  if [ $i -lt $[$length-1] ];then</div><div class="line">  printf &apos;,&apos;</div><div class="line">  fi</div><div class="line">  done</div><div class="line">printf &quot;\n\t]\n&quot;</div><div class="line">printf &quot;&#125;\n&quot;</div></pre></td></tr></table></figure><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">shell&gt; zabbix_get -s 127.0.0.1 -k discovery.ifdrive</div><div class="line">&#123;</div><div class="line">    "data":[</div><div class="line">        &#123;"&#123;#IF_DRIVE&#125;":"lo"&#125;,</div><div class="line">        &#123;"&#123;#IF_DRIVE&#125;":"em1"&#125;,</div><div class="line">        &#123;"&#123;#IF_DRIVE&#125;":"em2"&#125;</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line"></div><div class="line">shell&gt; zabbix_get -s 127.0.0.1 -k ipv4addr.check[lo]</div><div class="line">127.0.0.1</div></pre></td></tr></table></figure><h2 id="Create-discovery-rule"><a href="#Create-discovery-rule" class="headerlink" title="Create discovery rule"></a>Create discovery rule</h2><p>Discovery rules –&gt; Create discovery rule<br><img src="/2017/05/27/zabbix-discovery-network-interface-IPaddr/./pic0.png" alt="pic0"></p><p>Item prototypes –&gt; Create item prototype<br><img src="/2017/05/27/zabbix-discovery-network-interface-IPaddr/./pic1.png" alt="pic1"></p><p>Latest data<br><img src="/2017/05/27/zabbix-discovery-network-interface-IPaddr/./pic2.png" alt="pic2"></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix discovery tcp port</title>
      <link href="/2017/05/25/zabbix-discovery-tcp-port/"/>
      <url>/2017/05/25/zabbix-discovery-tcp-port/</url>
      
        <content type="html"><![CDATA[<h2 id="zabbix-agentd-conf"><a href="#zabbix-agentd-conf" class="headerlink" title="zabbix_agentd.conf"></a>zabbix_agentd.conf</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UserParameter=discovery.tcpport,<span class="formula">$zabbix_agentd_script/discovery_tcp_port.sh <span class="tag">\<span class="name">$</span></span>1</span></div></pre></td></tr></table></figure><h2 id="bash-script"><a href="#bash-script" class="headerlink" title="bash script"></a>bash script</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">chmod +s /bin/netstat</div><div class="line"><span class="comment">#OR</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'zabbix ALL=NOPASSWD:/bin/netstat'</span> &gt;&gt; /etc/sudoers</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#discovery_tcp_port.sh</span></div><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line">portarray=(`netstat -tnlp|egrep -i <span class="string">"<span class="variable">$1</span>"</span>|awk &#123;<span class="string">'print $4'</span>&#125;|awk -F<span class="string">':'</span> <span class="string">'&#123;if ($NF~/^[0-9]*$/) print $NF&#125;'</span>|sort|uniq`)</div><div class="line">length=<span class="variable">$&#123;#portarray[@]&#125;</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"&#123;\n"</span></div><div class="line"><span class="built_in">printf</span> <span class="string">'\t'</span><span class="string">"\"data\":["</span></div><div class="line"><span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$length</span>;i++))</div><div class="line">  <span class="keyword">do</span></div><div class="line">  <span class="built_in">printf</span> <span class="string">'\n\t\t&#123;'</span></div><div class="line">  <span class="built_in">printf</span> <span class="string">"\"&#123;#TCP_PORT&#125;\":\"<span class="variable">$&#123;portarray[$i]&#125;</span>\"&#125;"</span></div><div class="line">  <span class="keyword">if</span> [ <span class="variable">$i</span> <span class="_">-lt</span> $[<span class="variable">$length</span>-1] ];<span class="keyword">then</span></div><div class="line">  <span class="built_in">printf</span> <span class="string">','</span></div><div class="line">  <span class="keyword">fi</span></div><div class="line">  <span class="keyword">done</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"\n\t]\n"</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"&#125;\n"</span></div></pre></td></tr></table></figure><h2 id="Create-discovery-rule"><a href="#Create-discovery-rule" class="headerlink" title="Create discovery rule"></a>Create discovery rule</h2><p>Discovery rules –&gt;Create discovery rule<br><img src="/2017/05/25/zabbix-discovery-tcp-port/./pic0.png" alt="pic0"></p><p>Item prototypes –&gt; Create item prototype<br><img src="/2017/05/25/zabbix-discovery-tcp-port/./pic1.png" alt="pic1"></p><p>Trigger prototypes –&gt; Create trigger prototype<br><img src="/2017/05/25/zabbix-discovery-tcp-port/./pic2.png" alt="pic2"></p><p>Latest data<br><img src="/2017/05/25/zabbix-discovery-tcp-port/./pic3.png" alt="pic3"></p><p><img src="/2017/05/25/zabbix-discovery-tcp-port/./pic4.png" alt="pic3"></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix discovery process CPU MEM</title>
      <link href="/2017/05/25/zabbix-discovery-process-CPU-MEM/"/>
      <url>/2017/05/25/zabbix-discovery-process-CPU-MEM/</url>
      
        <content type="html"><![CDATA[<h2 id="zabbix-agentd-conf"><a href="#zabbix-agentd-conf" class="headerlink" title="zabbix_agentd.conf"></a>zabbix_agentd.conf</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">UserParameter=discovery.process,<span class="formula">$zabbix_agentd_script/discovery_process.sh</span></div><div class="line">UserParameter=process.check[*],$zabbix_agentd_script/process_check.sh <span class="tag">\<span class="name">$</span></span>1 <span class="tag">\<span class="name">$</span></span>2 <span class="tag">\<span class="name">$</span></span>3"</div><div class="line"></div><div class="line">/etc/init.d/zabbix-agent restart</div></pre></td></tr></table></figure><h2 id="bash-script"><a href="#bash-script" class="headerlink" title="bash script"></a>bash script</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"><span class="comment">#discovery_process.sh</span></div><div class="line">top -b -n 1 &gt; /tmp/.top.txt &amp;&amp; chown zabbix. /tmp/.top.txt</div><div class="line">proc_array=(`tail -n +8 /tmp/.top.txt | awk <span class="string">'&#123;a[$NF]+=$10&#125;END&#123;for(k in a)print a[k],k&#125;'</span>|sort -gr|head -10|cut <span class="_">-d</span><span class="string">" "</span> <span class="_">-f</span>2`)</div><div class="line">length=<span class="variable">$&#123;#proc_array[@]&#125;</span></div><div class="line"></div><div class="line"><span class="built_in">printf</span> <span class="string">"&#123;\n"</span></div><div class="line"><span class="built_in">printf</span> <span class="string">'\t'</span><span class="string">"\"data\":["</span></div><div class="line"><span class="keyword">for</span> ((i=0;i&lt;<span class="variable">$length</span>;i++))</div><div class="line"><span class="keyword">do</span></div><div class="line">  <span class="built_in">printf</span> <span class="string">"\n\t\t&#123;"</span></div><div class="line">  <span class="built_in">printf</span> <span class="string">"\"&#123;#PROCESS_NAME&#125;\":\"<span class="variable">$&#123;proc_array[$i]&#125;</span>\"&#125;"</span></div><div class="line">  <span class="keyword">if</span> [ <span class="variable">$i</span> <span class="_">-lt</span> $[<span class="variable">$length</span>-1] ];<span class="keyword">then</span></div><div class="line">  <span class="built_in">printf</span> <span class="string">","</span></div><div class="line">  <span class="keyword">fi</span></div><div class="line"><span class="keyword">done</span></div><div class="line">  <span class="built_in">printf</span> <span class="string">"\n\t]\n"</span></div><div class="line"><span class="built_in">printf</span> <span class="string">"&#125;\n"</span></div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#process_check.sh</span></div><div class="line">mode=<span class="variable">$1</span></div><div class="line">name=<span class="variable">$2</span></div><div class="line">process=<span class="variable">$3</span></div><div class="line">mem_total=$(cat /proc/meminfo | grep <span class="string">"MemTotal"</span> | awk <span class="string">'&#123;printf "%.f",$2/1024&#125;'</span>)</div><div class="line">cpu_total=$(( $(cat /proc/cpuinfo | grep <span class="string">"processor"</span> | wc <span class="_">-l</span>) * 100 ))</div><div class="line"></div><div class="line"><span class="keyword">function</span> mempre &#123;</div><div class="line">  mem_pre=`tail -n +8 /tmp/.top.txt | awk <span class="string">'&#123;a[$NF]+=$10&#125;END&#123;for(k in a)print a[k],k&#125;'</span> | grep <span class="string">"\b<span class="variable">$&#123;process&#125;</span>\b"</span> | cut <span class="_">-d</span><span class="string">" "</span> <span class="_">-f</span>1`</div><div class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$mem_pre</span>"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">function</span> memuse &#123;</div><div class="line">  mem_use=`tail -n +8 /tmp/.top.txt | awk <span class="string">'&#123;a[$NF]+=$10&#125;END&#123;for(k in a)print a[k]/100*'</span><span class="string">''</span><span class="variable">$&#123;mem_total&#125;</span><span class="string">''</span><span class="string">',k&#125;'</span> | grep <span class="string">"\b<span class="variable">$&#123;process&#125;</span>\b"</span> | cut <span class="_">-d</span><span class="string">" "</span> <span class="_">-f</span>1`</div><div class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$mem_use</span>"</span> | awk <span class="string">'&#123;printf "%.f",$1*1024*1024&#125;'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">function</span> cpuuse &#123;</div><div class="line">  cpu_use=`tail -n +8 /tmp/.top.txt | awk <span class="string">'&#123;a[$NF]+=$9&#125;END&#123;for(k in a)print a[k],k&#125;'</span> | grep <span class="string">"\b<span class="variable">$&#123;process&#125;</span>\b"</span> | cut <span class="_">-d</span><span class="string">" "</span> <span class="_">-f</span>1`</div><div class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$cpu_use</span>"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">function</span> cpupre &#123;</div><div class="line">  cpu_pre=`tail -n +8 /tmp/.top.txt | awk <span class="string">'&#123;a[$NF]+=$9&#125;END&#123;for(k in a)print a[k]/('</span><span class="string">''</span><span class="variable">$&#123;cpu_total&#125;</span><span class="string">''</span><span class="string">'),k&#125;'</span> | grep <span class="string">"\b<span class="variable">$&#123;process&#125;</span>\b"</span> | cut <span class="_">-d</span><span class="string">" "</span> <span class="_">-f</span>1`</div><div class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$cpu_pre</span>"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="variable">$name</span> <span class="keyword">in</span></div><div class="line">  mem)</div><div class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$mode</span>"</span> = <span class="string">"pre"</span> ];<span class="keyword">then</span></div><div class="line">  mempre</div><div class="line">  <span class="keyword">elif</span> [ <span class="string">"<span class="variable">$mode</span>"</span> = <span class="string">"avg"</span> ];<span class="keyword">then</span></div><div class="line">  memuse</div><div class="line">  <span class="keyword">fi</span></div><div class="line">  ;;</div><div class="line">  cpu)</div><div class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$mode</span>"</span> = <span class="string">"pre"</span> ];<span class="keyword">then</span></div><div class="line">  cpupre</div><div class="line">  <span class="keyword">elif</span> [ <span class="string">"<span class="variable">$mode</span>"</span> = <span class="string">"avg"</span> ];<span class="keyword">then</span></div><div class="line">  cpuuse</div><div class="line">  <span class="keyword">fi</span></div><div class="line">  ;;</div><div class="line">  *)</div><div class="line">  <span class="built_in">echo</span> <span class="_">-e</span> <span class="string">"Usage: <span class="variable">$0</span> [mode : pre|avg] [mem|cpu] [process]"</span></div><div class="line"><span class="keyword">esac</span></div></pre></td></tr></table></figure><h2 id="Create-discovery"><a href="#Create-discovery" class="headerlink" title="Create discovery"></a>Create discovery</h2><p>Discovery rules –&gt; Create discovery rule<br><img src="/2017/05/25/zabbix-discovery-process-CPU-MEM/./pic0.png" alt="pic0"></p><p>Item prototypes –&gt; Create item prototype<br><img src="/2017/05/25/zabbix-discovery-process-CPU-MEM/./pic1.png" alt="pic1"></p><p><img src="/2017/05/25/zabbix-discovery-process-CPU-MEM/./pic1.png" alt="pic2"></p><p>Latest data<br><img src="/2017/05/25/zabbix-discovery-process-CPU-MEM/./pic3.png" alt="pic3"></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Pi-hole</title>
      <link href="/2017/05/22/Pi-hole/"/>
      <url>/2017/05/22/Pi-hole/</url>
      
        <content type="html"><![CDATA[<h2 id="Pi-hole"><a href="#Pi-hole" class="headerlink" title="Pi-hole"></a>Pi-hole</h2><h3 id="The-multi-platform-network-wide-ad-blocker"><a href="#The-multi-platform-network-wide-ad-blocker" class="headerlink" title="The multi-platform, network-wide ad blocker"></a>The multi-platform, network-wide ad blocker</h3><p>Block ads for all your devices without the need to install client-side software. The Pi-hole™ blocks ads at the DNS-level, so all your devices are protected.</p><ul><li>Web Browsers</li><li>Cell Phones</li><li>Smart TV’s</li><li>Internet-connected home automation</li><li>Anything that communicates with the Internet</li></ul><p>git:<a href="https://github.com/pi-hole/pi-hole/" target="_blank" rel="external">https://github.com/pi-hole/pi-hole/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">wget -O basic-install.sh https://install.pi-hole.net</div><div class="line">bash basic-install.sh</div><div class="line"></div><div class="line"><span class="comment">#Web Interface</span></div><div class="line"><span class="comment">#The Web interface will be installed automatically so you can view stats and change settings. You can find it at:</span></div><div class="line"><span class="comment">#http://192.168.1.x/admin/index.php or http://pi.hole/admin</span></div><div class="line"></div><div class="line"><span class="comment">#reset password</span></div><div class="line">sudo pihole <span class="_">-a</span> -p</div></pre></td></tr></table></figure><p><img src="/2017/05/22/Pi-hole/./web_interface.png" alt="web"></p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DNS </tag>
            
            <tag> ADblock </tag>
            
            <tag> DHCP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LVS Server</title>
      <link href="/2017/05/22/LVS-Server/"/>
      <url>/2017/05/22/LVS-Server/</url>
      
        <content type="html"><![CDATA[<h2 id="Host-info"><a href="#Host-info" class="headerlink" title="Host info"></a>Host info</h2><p><img src="/2017/05/22/LVS-Server/./ip_info.png" alt="ip_info"><br><img src="/2017/05/22/LVS-Server/./map.png" alt="map"></p><h2 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">shell&gt; uname -r</div><div class="line">2.6.32-642.el6.x86_64</div><div class="line">yum install -y ipvsadm</div><div class="line"></div><div class="line">ip addr add 192.168.1.222/32 brd 192.168.1.222 dev eth0</div><div class="line">ip route add 192.168.1.222 dev eth0</div><div class="line"></div><div class="line">OR</div><div class="line">ifconfig eth0:0 192.168.1.222 netmask 255.255.255.255 broadcast 192.168.1.222 up</div><div class="line">route add -host 192.168.1.222 dev eth0:0</div><div class="line"></div><div class="line">ipvsadm -A -t 192.168.1.222:80 <span class="_">-s</span> rr</div><div class="line">ipvsadm <span class="_">-a</span> -t 192.168.1.222:80 -r 192.168.1.128:80 -g</div><div class="line">ipvsadm <span class="_">-a</span> -t 192.168.1.222:80 -r 192.168.1.184:80 -g</div><div class="line"></div><div class="line">shell&gt; ipvsadm <span class="_">-l</span> -n</div><div class="line">IP Virtual Server version 1.2.1 (size=4096)</div><div class="line">Prot LocalAddress:Port Scheduler Flags</div><div class="line">  -&gt; RemoteAddress:Port Forward Weight ActiveConn InActConn</div><div class="line">TCP  192.168.1.222:80 rr</div><div class="line">  -&gt; 192.168.1.128:80 Route 1 0 0</div><div class="line">  -&gt; 192.168.1.184:80 Local 1 0 0</div></pre></td></tr></table></figure><h2 id="RS"><a href="#RS" class="headerlink" title="RS"></a>RS</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ip addr add 192.168.1.222/32 brd 192.168.1.222 dev lo</div><div class="line"><span class="comment">#ip route add 192.168.1.222/32 dev lo</span></div><div class="line"></div><div class="line">OR</div><div class="line">ifconfig lo:0 192.168.1.222 netmask 255.255.255.255 broadcast 192.168.1.222 up</div><div class="line"><span class="comment">#route add -host 192.168.1.222 dev lo:0</span></div></pre></td></tr></table></figure><h2 id="list-current-IPVS-connections"><a href="#list-current-IPVS-connections" class="headerlink" title="list current IPVS connections"></a>list current IPVS connections</h2><p><img src="/2017/05/22/LVS-Server/./LVS_test_info.png" alt="test"></p><h2 id="test"><a href="#test" class="headerlink" title="test:"></a>test:</h2><p><img src="/2017/05/22/LVS-Server/./web_test.png" alt="web_test"></p><blockquote><p><a href="http://www.linuxvirtualserver.org/VS-DRouting.html" target="_blank" rel="external">http://www.linuxvirtualserver.org/VS-DRouting.html</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
        <tags>
            
            <tag> LVS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>iptables</title>
      <link href="/2017/05/18/iptables/"/>
      <url>/2017/05/18/iptables/</url>
      
        <content type="html"><![CDATA[<p><img src="/2017/05/18/iptables/Netfilter-packet-flow.svg" alt="pic"></p><h2 id="iptables-表与链"><a href="#iptables-表与链" class="headerlink" title="iptables 表与链"></a>iptables 表与链</h2><p>iptables具有Filter, NAT, Mangle, Raw四种内建表：</p><h3 id="1-Filter表"><a href="#1-Filter表" class="headerlink" title="1. Filter表"></a>1. Filter表</h3><p>Filter表示iptables的默认表，没有自定义表，默认使用filter表<br><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#Filter表内建链：</div><div class="line">- INPUT链 – 处理来自外部的数据。</div><div class="line">- OUTPUT链 – 处理向外发送的数据。</div><div class="line">- FORWARD链 – 将数据转发到本机的其他网卡设备上。</div></pre></td></tr></table></figure></p><h3 id="2-NAT表"><a href="#2-NAT表" class="headerlink" title="2. NAT表"></a>2. NAT表</h3><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#NAT表内建链：</div><div class="line">- PREROUTING链 – 处理刚到达本机并在路由转发前的数据包。它会转换数据包中的目标IP地址（destination ip address），通常用于DNAT(destination NAT)。</div><div class="line">- POSTROUTING链 – 处理即将离开本机的数据包。它会转换数据包中的源IP地址（source ip address），通常用于SNAT（source NAT）。</div><div class="line">- OUTPUT链 – 处理本机产生的数据包。</div></pre></td></tr></table></figure><h3 id="3-Mangle表"><a href="#3-Mangle表" class="headerlink" title="3. Mangle表"></a>3. Mangle表</h3><p>Mangle表用于指定如何处理数据包。它能改变TCP头中的QoS位。<br><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#Mangle表具有5个内建链：</div><div class="line">- PREROUTING</div><div class="line">- OUTPUT</div><div class="line">- FORWARD</div><div class="line">- INPUT</div><div class="line">- POSTROUTING</div></pre></td></tr></table></figure></p><h3 id="4-Raw表"><a href="#4-Raw表" class="headerlink" title="4. Raw表"></a>4. Raw表</h3><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#Raw表用于处理异常，它具有2个内建链：</div><div class="line"></div><div class="line">- PREROUTING chain</div><div class="line">- OUTPUT chain</div></pre></td></tr></table></figure><h2 id="开启内核转发"><a href="#开启内核转发" class="headerlink" title="开启内核转发"></a>开启内核转发</h2><p>net.ipv4.ip_forward</p><h3 id="临时"><a href="#临时" class="headerlink" title="临时"></a>临时</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/ip_forward</div><div class="line">sysctl net.ipv4.ip_forward＝１</div></pre></td></tr></table></figure><h3 id="永久"><a href="#永久" class="headerlink" title="永久"></a>永久</h3><p>echo ‘net.ipv4.ip_forward＝１’ &gt;&gt; /etc/sysctl.conf<br>sysctl -p</p><h2 id="重置规则"><a href="#重置规则" class="headerlink" title="重置规则"></a>重置规则</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#清除规则</span></div><div class="line">iptables-restore &lt; /etc/iptables/empty.rules</div><div class="line">iptables --flush</div></pre></td></tr></table></figure><p>##常用命令及参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#命令</span></div><div class="line">iptables -L -n --line-numbers <span class="comment">#显示行号</span></div><div class="line">iptables -D INPUT 1 <span class="comment">#根据行号删除</span></div><div class="line"></div><div class="line">iptables-save &gt; iptables.save <span class="comment">#导出规则到文件</span></div><div class="line">iptables-restore -c iptables.save <span class="comment">#从文件恢复规则</span></div><div class="line"></div><div class="line"><span class="comment">#参数</span></div><div class="line">-t&lt;表&gt;：指定要操纵的表；</div><div class="line">-A：向规则链中添加条目；</div><div class="line">-D：从规则链中删除条目；</div><div class="line">-i：向规则链中插入条目；</div><div class="line">-R：替换规则链中的条目；</div><div class="line">-L：显示规则链中已有的条目；</div><div class="line">-F：清楚规则链中已有的条目；</div><div class="line">-Z：清空规则链中的数据包计算器和字节计数器；</div><div class="line">-N：创建新的用户自定义规则链；</div><div class="line">-P：定义规则链中的默认目标；</div><div class="line">-h：显示帮助信息；</div><div class="line">-p：指定要匹配的数据包协议类型；</div><div class="line"><span class="_">-s</span>：指定要匹配的数据包源ip地址；</div><div class="line">-j&lt;目标&gt;：指定要跳转的目标；</div><div class="line">-i&lt;网络接口&gt;：指定数据包进入本机的网络接口；</div><div class="line">-o&lt;网络接口&gt;：指定数据包要离开本机所使用的网络接口。</div></pre></td></tr></table></figure></p><h2 id="ubuntu-开机自动加载规则"><a href="#ubuntu-开机自动加载规则" class="headerlink" title="ubuntu 开机自动加载规则"></a>ubuntu 开机自动加载规则</h2><p>sudo nano /etc/network/interfaces<br>在末尾加入：<br>pre-up iptables-restore &lt;/etc/iptables-rules</p><p>或者加入<br>rc.local</p><h2 id="NAT"><a href="#NAT" class="headerlink" title="NAT"></a>NAT</h2><p>参考：<br><a href="http://www.netfilter.org/documentation/HOWTO//NAT-HOWTO-6.html#ss6.1" target="_blank" rel="external">http://www.netfilter.org/documentation/HOWTO//NAT-HOWTO-6.html#ss6.1</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#多端口转发：</span></div><div class="line"><span class="comment">#(将访问本地tcp端口50000~65535转发至目标1.1.1.1:50000~65535)</span></div><div class="line">-A PREROUTING -p tcp -m tcp --dport 50000:65535 -j DNAT --to-destination 1.1.1.1</div><div class="line">-A POSTROUTING <span class="_">-d</span> 1.1.1.1/32 -p tcp -m tcp --dport 50000:65535 -j SNAT --to-source [本地服务器IP]</div><div class="line"></div><div class="line"><span class="comment">#转发1.1.1.1的数据包</span></div><div class="line">-A FORWARD <span class="_">-s</span> 1.1.1.1 -j ACCEPT</div><div class="line">-A FORWARD <span class="_">-d</span> 1.1.1.1 -j ACCEPT</div><div class="line"></div><div class="line"><span class="comment">#不同端口转发：</span></div><div class="line"><span class="comment">#（将访问本地tcp端口60000转发至目标1.1.1.1：50000）</span></div><div class="line">-A PREROUTING -p tcp -m tcp --dport 60000 -j DNAT --to-destination 1.1.1.1:50000</div><div class="line">-A POSTROUTING <span class="_">-d</span> 1.1.1.1/32 -p tcp -m tcp --dport 50000 -j SNAT --to-source [本地服务器IP]</div><div class="line"></div><div class="line"><span class="comment">#转发1.1.1.1的数据包</span></div><div class="line">-A FORWARD <span class="_">-s</span> 1.1.1.1 -j ACCEPT</div><div class="line">-A FORWARD <span class="_">-d</span> 1.1.1.1 -j ACCEPT</div><div class="line"></div><div class="line"><span class="comment">## Masquerade everything out ppp0</span></div><div class="line"><span class="comment">#伪装所有从ppp0出去的ip</span></div><div class="line">iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE</div><div class="line"></div><div class="line"><span class="comment">#将外网访问80端口的数据转发到8080端口</span></div><div class="line">iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-ports 8080</div><div class="line"></div><div class="line"><span class="comment">#local to local</span></div><div class="line"><span class="comment">#将访问本机80端口的转发到本机8080</span></div><div class="line">iptables -t nat -A OUTPUT -p tcp <span class="_">-d</span> 127.0.0.1 --dport 80 -j DNAT --to 127.0.0.1:8080</div><div class="line">iptables -t nat -A OUTPUT -p tcp <span class="_">-d</span> 192.168.1.128 --dport 80 -j DNAT --to 127.0.0.1:8080</div><div class="line"></div><div class="line"><span class="comment">#本地连接指的是在本机上，用 127.0.0.1 或者本机 IP 来访问本机的端口。本地连接的数据包不会通过网卡，而是由内核处理后直接发给本地进程。这种数据包在 iptables 中只经过 OUTPUT 链，而不会经过 PREROUTING 链。所以需要在 OUTPUT 链中进行 DNAT。除了对 127.0.0.1 之外，对本机 IP (即 192.168.1.128) 的访问也属于本地连接。</span></div></pre></td></tr></table></figure></p><h2 id="limit-限速"><a href="#limit-限速" class="headerlink" title="limit 限速"></a>limit 限速</h2><p>参考:<br><a href="http://www.netfilter.org/documentation/HOWTO/de/packet-filtering-HOWTO-7.html" target="_blank" rel="external">http://www.netfilter.org/documentation/HOWTO/de/packet-filtering-HOWTO-7.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">-A FORWARD <span class="_">-s</span> 192.168.100.121/32 -m <span class="built_in">limit</span> --limit 100/s -j ACCEPT</div><div class="line">-A FORWARD <span class="_">-d</span> 192.168.100.121/32 -m <span class="built_in">limit</span> --limit 100/s -j ACCEPT</div><div class="line"><span class="comment">#限制每秒到达/发送192.168.100.121的数据包为100个</span></div><div class="line">-A FORWARD <span class="_">-d</span> 192.168.100.121/32 -m connlimit --connlimit-above 100 -j DROP</div><div class="line"><span class="comment">#限制100连接数</span></div><div class="line">-A FORWARD <span class="_">-s</span> 192.168.100.121/32 -j DROP</div><div class="line">-A FORWARD <span class="_">-d</span> 192.168.100.121/32 -j DROP</div><div class="line"><span class="comment">#丢弃所有超过限制的数据包</span></div></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> security </category>
          
      </categories>
      
      
        <tags>
            
            <tag> iptables </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zabbix mysql</title>
      <link href="/2017/05/18/zabbix-mysql/"/>
      <url>/2017/05/18/zabbix-mysql/</url>
      
        <content type="html"><![CDATA[<h2 id="create-account"><a href="#create-account" class="headerlink" title="create account"></a>create account</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">GRANT</span> <span class="keyword">USAGE</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'zabbix'</span>@<span class="string">'127.0.0.1'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'zabbx_admin'</span>;</div><div class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</div></pre></td></tr></table></figure><h2 id="userparameter-mysql-conf"><a href="#userparameter-mysql-conf" class="headerlink" title="userparameter_mysql.conf"></a>userparameter_mysql.conf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#复制userparameter_mysql.conf模板到zabbix配置文件所在目录</div><div class="line">cp ./zabbix-3.2.5/conf/zabbix_agentd/userparameter_mysql.conf /usr/local/etc/zabbix_agentd.conf.d/</div><div class="line"></div><div class="line">#HOME目录修改为zabbix配置文件所在目录</div><div class="line">sed -i &apos;s@/var/lib/zabbix@/usr/local/etc@g&apos; /usr/local/etc/zabbix_agentd.conf.d/userparameter_mysql.conf</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#userparameter_mysql.conf</div><div class="line">UserParameter=mysql.status[*],echo &quot;show global status where Variable_name=&apos;$1&apos;;&quot; | HOME=/usr/local/etc mysql -N | awk &apos;&#123;print $$2&#125;&apos;</div><div class="line">UserParameter=mysql.size[*],bash -c &apos;echo &quot;select sum($(case &quot;$3&quot; in both|&quot;&quot;) echo &quot;data_length+index_length&quot;;; data|index) echo &quot;$3_length&quot;;; free) echo &quot;data_free&quot;;; esac)) from information_schema.tables$([[ &quot;$1&quot; = &quot;all&quot; || ! &quot;$1&quot; ]] || echo &quot; where table_schema=\&quot;$1\&quot;&quot;)$([[ &quot;$2&quot; = &quot;all&quot; || ! &quot;$2&quot; ]] || echo &quot;and table_name=\&quot;$2\&quot;&quot;);&quot; | HOME=/usr/local/etc mysql -N&apos;</div><div class="line">UserParameter=mysql.ping,HOME=/usr/local/etc mysqladmin ping | grep -c alive</div><div class="line">UserParameter=mysql.version,mysql -V</div></pre></td></tr></table></figure><h2 id="my-cnf"><a href="#my-cnf" class="headerlink" title=".my.cnf"></a>.my.cnf</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">echo '[mysql]</div><div class="line">host=127.0.0.1</div><div class="line">port=3333</div><div class="line">user=zabbix</div><div class="line">password=zabbix_admin</div><div class="line">socket = /opt/mysql_cacti/mysql.sock</div><div class="line"></div><div class="line">[mysqladmin]</div><div class="line">host=127.0.0.1</div><div class="line">port=3333</div><div class="line">user=zabbix</div><div class="line">password=zabbix_admin</div><div class="line">socket = /opt/mysql_cacti/mysql.sock' &gt; /usr/local/etc/.my.cnf</div></pre></td></tr></table></figure><h2 id="zabbix-agentd-conf"><a href="#zabbix-agentd-conf" class="headerlink" title="zabbix_agentd.conf"></a>zabbix_agentd.conf</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#追加配置到zabbix_agentd.conf</div><div class="line">echo &apos;Include=/usr/local/etc/zabbix_agentd.conf.d/&apos; &gt;&gt; zabbix_agentd.conf</div><div class="line"></div><div class="line">#重启zabbix_agentd</div><div class="line">/etc/init.d/zabbix_agentd restart</div></pre></td></tr></table></figure><h2 id="test-on-zabbix-server"><a href="#test-on-zabbix-server" class="headerlink" title="test on zabbix server"></a>test on zabbix server</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">shell&gt; zabbix_get <span class="_">-s</span> 127.0.0.1 -p 10050 -k <span class="string">'mysql.ping'</span></div><div class="line">1</div><div class="line"></div><div class="line">shell&gt; zabbix_get <span class="_">-s</span> 127.0.0.1 -p 10050 -k mysql.version</div><div class="line">/opt/mysql_cacti/bin/mysql Ver 14.14 Distrib 5.6.35, <span class="keyword">for</span> linux-glibc2.5 (x86_64) using EditLine wrapper</div><div class="line"></div><div class="line"><span class="comment">##注：</span></div><div class="line"><span class="comment">#如报错：sh: mysql: command not found</span></div><div class="line"><span class="comment"># sh: mysqladmin: command not found</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#修改userparameter_mysql.conf:</span></div><div class="line"><span class="comment"># mysql mysqladmin命令的路径为绝对路径</span></div></pre></td></tr></table></figure><p>最终效果<br><img src="/2017/05/18/zabbix-mysql/20170517170310.png" alt="logo"></p>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> zabbix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openvpn</title>
      <link href="/2017/05/18/openvpn/"/>
      <url>/2017/05/18/openvpn/</url>
      
        <content type="html"><![CDATA[<p><a href="http://dl.fedoraproject.org/pub/epel/6/x86_64/pkcs11-helper-1.11-3.el6.x86_64.rpm" target="_blank" rel="external">http://dl.fedoraproject.org/pub/epel/6/x86_64/pkcs11-helper-1.11-3.el6.x86_64.rpm</a></p><h2 id="install-OpenVPN"><a href="#install-OpenVPN" class="headerlink" title="install OpenVPN"></a>install OpenVPN</h2><h4 id="yum"><a href="#yum" class="headerlink" title="yum"></a>yum</h4><p>CentOS 5<br>rpm -ivh <a href="http://apt.sw.be/redhat/el5/en/x86_64/rpmforge/RPMS/rpmforge-release-0.5.2-2.el5.rf.x86_64.rpm" target="_blank" rel="external">http://apt.sw.be/redhat/el5/en/x86_64/rpmforge/RPMS/rpmforge-release-0.5.2-2.el5.rf.x86_64.rpm</a></p><p>CentOS 6<br>rpm -ivh <a href="http://apt.sw.be/redhat/el6/en/x86_64/rpmforge/RPMS/rpmforge-release-0.5.2-2.el6.rf.x86_64.rpm" target="_blank" rel="external">http://apt.sw.be/redhat/el6/en/x86_64/rpmforge/RPMS/rpmforge-release-0.5.2-2.el6.rf.x86_64.rpm</a></p><p>yum install -y openvpn</p><h3 id="make-source"><a href="#make-source" class="headerlink" title="make source"></a>make source</h3><p>wget -c <a href="https://swupdate.openvpn.org/community/releases/openvpn-2.4.1.tar.gz" target="_blank" rel="external">https://swupdate.openvpn.org/community/releases/openvpn-2.4.1.tar.gz</a><br>tar xf openvpn-2.4.1.tar.gz<br>./configure<br>make &amp;&amp; make install</p><h3 id="easy-rsa"><a href="#easy-rsa" class="headerlink" title="easy-rsa"></a>easy-rsa</h3><p>wget -O easy-rsa.zip <a href="https://github.com/OpenVPN/easy-rsa-old/archive/master.zip" target="_blank" rel="external">https://github.com/OpenVPN/easy-rsa-old/archive/master.zip</a></p><h2 id="vi-var"><a href="#vi-var" class="headerlink" title="vi var"></a>vi var</h2><p>KEY_COUNTRY：所在国家<br>KEY_PROVINCE：所在省<br>KEY_CITY：所在城市<br>KEY_ORG：所在组织<br>KEY_EMAIL：邮箱地址<br>KEY_OU：机构单位或部门名称</p><h2 id="create-CA"><a href="#create-CA" class="headerlink" title="create CA"></a>create CA</h2><p>cp -R /usr/share/doc/openvpn-<em>/easy-rsa /etc/openvpn<br>cd /etc/openvpn/easy-rsa/2.0<br>chmod +x </em></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">. vars</div><div class="line">./clean-all</div><div class="line">./build-ca</div><div class="line">./build-key-server server</div><div class="line">./build-key client</div><div class="line">./build-dh</div><div class="line"></div><div class="line">openvpn --genkey --secret keys/ta.key</div></pre></td></tr></table></figure><p>ln -s $(readlink -f keys/) /etc/openvpn/config<br>cp /opt/openvpn-2.4.1/sample/sample-config-files/client.conf ./</p><p>ls /etc/openvpn/easy-rsa/2.*/keys/</p><h2 id="server-conf"><a href="#server-conf" class="headerlink" title="server.conf"></a>server.conf</h2><p>cp -a /usr/share/doc/openvpn-2.2.2/sample-config-files/server.conf /etc/openvpn/</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">port 1194</div><div class="line">proto udp</div><div class="line">dev tun</div><div class="line">ca ca.crt</div><div class="line">cert server.crt</div><div class="line">key server.key</div><div class="line">dh dh2048.pem</div><div class="line">server 10.8.0.0 255.255.255.0</div><div class="line"># 推送路由信息到客户端，以允许客户端能够连接到服务器背后的其他私有子网。</div><div class="line"># (简而言之，就是允许客户端访问VPN服务器自身所在的其他局域网)</div><div class="line"># 记住，这些私有子网也要将OpenVPN客户端的地址池(10.8.0.0/255.255.255.0)反馈回OpenVPN服务器。</div><div class="line">;push "route 192.168.10.0 255.255.255.0"</div><div class="line">;push "route 192.168.20.0 255.255.255.0"</div><div class="line"></div><div class="line"># 如果多个客户端可能使用相同的证书/私钥文件或Common Name进行连接，那么你可以取消该指令的注释。</div><div class="line"># 建议该指令仅用于测试目的。对于生产使用环境而言，每个客户端都应该拥有自己的证书和私钥。</div><div class="line"># 如果你没有为每个客户端分别生成Common Name唯一的证书/私钥，你可以取消该行的注释(但不推荐这样做)。</div><div class="line">duplicate-cn</div><div class="line"></div><div class="line">ifconfig-pool-persist ipp.txt</div><div class="line">keepalive 10 120</div><div class="line">tls-auth ta.key 0</div><div class="line">##</div><div class="line">cipher AES-256-CBC</div><div class="line">persist-key</div><div class="line">persist-tun</div><div class="line">status openvpn-status.log</div><div class="line">verb 3</div><div class="line">explicit-exit-notify 1</div></pre></td></tr></table></figure><h2 id="client-conf"><a href="#client-conf" class="headerlink" title="client.conf"></a>client.conf</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">client</div><div class="line">dev tun</div><div class="line">proto udp</div><div class="line">remote 172.16.90.136 1194</div><div class="line">resolv-retry infinite</div><div class="line">nobind</div><div class="line">persist-key</div><div class="line">persist-tun</div><div class="line">ca ca.crt</div><div class="line">cert xy.crt</div><div class="line">key xy.key</div><div class="line">remote-cert-tls server</div><div class="line">tls-auth ta.key 1</div><div class="line">cipher AES-256-CBC</div><div class="line">verb 3</div></pre></td></tr></table></figure><h2 id="detail"><a href="#detail" class="headerlink" title="detail"></a>detail</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div></pre></td><td class="code"><pre><div class="line">server.ovpn</div><div class="line">#################################################</div><div class="line"># 针对多客户端的OpenVPN 2.0 的服务器端配置文件示例</div><div class="line">#</div><div class="line"># 本文件用于多客户端&lt;-&gt;单服务器端的OpenVPN服务器端配置</div><div class="line">#</div><div class="line"># OpenVPN也支持单机&lt;-&gt;单机的配置(更多信息请查看网站上的示例页面)</div><div class="line">#</div><div class="line"># 该配置支持Windows或者Linux/BSD系统。此外，在Windows上，记得将路径加上双引号，</div><div class="line"># 并且使用两个反斜杠，例如："C:<span class="tag">\<span class="name">\</span></span>Program Files<span class="tag">\<span class="name">\</span></span>OpenVPN<span class="tag">\<span class="name">\</span></span>config<span class="tag">\<span class="name">\</span></span>foo.key"</div><div class="line">#</div><div class="line"># '#' or ';'开头的均为注释内容</div><div class="line">#################################################</div><div class="line"></div><div class="line">#OpenVPN应该监听本机的哪些IP地址？</div><div class="line">#该命令是可选的，如果不设置，则默认监听本机的所有IP地址。</div><div class="line">;local a.b.c.d</div><div class="line"></div><div class="line"># OpenVPN应该监听哪个TCP/UDP端口？</div><div class="line"># 如果你想在同一台计算机上运行多个OpenVPN实例，你可以使用不同的端口号来区分它们。</div><div class="line"># 此外，你需要在防火墙上开放这些端口。</div><div class="line">port 1194</div><div class="line"></div><div class="line">#OpenVPN使用TCP还是UDP协议?</div><div class="line">;proto tcp</div><div class="line">proto udp</div><div class="line"></div><div class="line"># 指定OpenVPN创建的通信隧道类型。</div><div class="line"># "dev tun"将会创建一个路由IP隧道，</div><div class="line"># "dev tap"将会创建一个以太网隧道。</div><div class="line">#</div><div class="line"># 如果你是以太网桥接模式，并且提前创建了一个名为"tap0"的与以太网接口进行桥接的虚拟接口，则你可以使用"dev tap0"</div><div class="line">#</div><div class="line"># 如果你想控制VPN的访问策略，你必须为TUN/TAP接口创建防火墙规则。</div><div class="line">#</div><div class="line"># 在非Windows系统中，你可以给出明确的单位编号(unit number)，例如"tun0"。</div><div class="line"># 在Windows中，你也可以使用"dev-node"。</div><div class="line"># 在多数系统中，除非你部分禁用或者完全禁用了TUN/TAP接口的防火墙，否则VPN将不起作用。</div><div class="line">;dev tap</div><div class="line">dev tun</div><div class="line"></div><div class="line"># 如果你想配置多个隧道，你需要用到网络连接面板中TAP-Win32适配器的名称(例如"MyTap")。</div><div class="line"># 在XP SP2或更高版本的系统中，你可能需要有选择地禁用掉针对TAP适配器的防火墙</div><div class="line"># 通常情况下，非Windows系统则不需要该指令。</div><div class="line">;dev-node MyTap</div><div class="line"></div><div class="line"># 设置SSL/TLS根证书(ca)、证书(cert)和私钥(key)。</div><div class="line"># 每个客户端和服务器端都需要它们各自的证书和私钥文件。</div><div class="line"># 服务器端和所有的客户端都将使用相同的CA证书文件。</div><div class="line">#</div><div class="line"># 通过easy-rsa目录下的一系列脚本可以生成所需的证书和私钥。</div><div class="line"># 记住，服务器端和每个客户端的证书必须使用唯一的Common Name。</div><div class="line">#</div><div class="line"># 你也可以使用遵循X509标准的任何密钥管理系统来生成证书和私钥。</div><div class="line"># OpenVPN 也支持使用一个PKCS #12格式的密钥文件(详情查看站点手册页面的"pkcs12"指令)</div><div class="line">ca ca.crt</div><div class="line">cert server.crt</div><div class="line">key server.key # 该文件应该保密</div><div class="line"></div><div class="line"># 指定迪菲·赫尔曼参数。</div><div class="line"># 你可以使用如下名称命令生成你的参数：</div><div class="line"># openssl dhparam -out dh1024.pem 1024</div><div class="line"># 如果你使用的是2048位密钥，使用2048替换其中的1024。</div><div class="line">dh dh1024.pem</div><div class="line"></div><div class="line"># 设置服务器端模式，并提供一个VPN子网，以便于从中为客户端分配IP地址。</div><div class="line"># 在此处的示例中，服务器端自身将占用10.8.0.1，其他的将提供客户端使用。</div><div class="line"># 如果你使用的是以太网桥接模式，请注释掉该行。更多信息请查看官方手册页面。</div><div class="line">server 10.8.0.0 255.255.255.0</div><div class="line"></div><div class="line"># 指定用于记录客户端和虚拟IP地址的关联关系的文件。</div><div class="line"># 当重启OpenVPN时，再次连接的客户端将分配到与上一次分配相同的虚拟IP地址</div><div class="line">ifconfig-pool-persist ipp.txt</div><div class="line"></div><div class="line"># 该指令仅针对以太网桥接模式。</div><div class="line"># 首先，你必须使用操作系统的桥接能力将以太网网卡接口和TAP接口进行桥接。</div><div class="line"># 然后，你需要手动设置桥接接口的IP地址、子网掩码；</div><div class="line"># 在这里，我们假设为10.8.0.4和255.255.255.0。</div><div class="line"># 最后，我们必须指定子网的一个IP范围(例如从10.8.0.50开始，到10.8.0.100结束)，以便于分配给连接的客户端。</div><div class="line"># 如果你不是以太网桥接模式，直接注释掉这行指令即可。</div><div class="line">;server-bridge 10.8.0.4 255.255.255.0 10.8.0.50 10.8.0.100</div><div class="line"></div><div class="line"># 该指令仅针对使用DHCP代理的以太网桥接模式，</div><div class="line"># 此时客户端将请求服务器端的DHCP服务器，从而获得分配给它的IP地址和DNS服务器地址。</div><div class="line">#</div><div class="line"># 在此之前，你也需要先将以太网网卡接口和TAP接口进行桥接。</div><div class="line"># 注意：该指令仅用于OpenVPN客户端，并且该客户端的TAP适配器需要绑定到一个DHCP客户端上。</div><div class="line">;server-bridge</div><div class="line"></div><div class="line"># 推送路由信息到客户端，以允许客户端能够连接到服务器背后的其他私有子网。</div><div class="line"># (简而言之，就是允许客户端访问VPN服务器自身所在的其他局域网)</div><div class="line"># 记住，这些私有子网也要将OpenVPN客户端的地址池(10.8.0.0/255.255.255.0)反馈回OpenVPN服务器。</div><div class="line">;push "route 192.168.10.0 255.255.255.0"</div><div class="line">;push "route 192.168.20.0 255.255.255.0"</div><div class="line"></div><div class="line"># 为指定的客户端分配指定的IP地址，或者客户端背后也有一个私有子网想要访问VPN，</div><div class="line"># 那么你可以针对该客户端的配置文件使用ccd子目录。</div><div class="line"># (简而言之，就是允许客户端所在的局域网成员也能够访问VPN)</div><div class="line"></div><div class="line"># 举个例子：假设有个Common Name为"Thelonious"的客户端背后也有一个小型子网想要连接到VPN，该子网为192.168.40.128/255.255.255.248。</div><div class="line"># 首先，你需要去掉下面两行指令的注释：</div><div class="line">;client-config-dir ccd</div><div class="line">;route 192.168.40.128 255.255.255.248</div><div class="line"># 然后创建一个文件ccd/Thelonious，该文件的内容为：</div><div class="line"># iroute 192.168.40.128 255.255.255.248</div><div class="line">#这样客户端所在的局域网就可以访问VPN了。</div><div class="line"># 注意，这个指令只能在你是基于路由、而不是基于桥接的模式下才能生效。</div><div class="line"># 比如，你使用了"dev tun"和"server"指令。</div><div class="line"></div><div class="line"># 再举个例子：假设你想给Thelonious分配一个固定的IP地址10.9.0.1。</div><div class="line"># 首先，你需要去掉下面两行指令的注释：</div><div class="line">;client-config-dir ccd</div><div class="line">;route 10.9.0.0 255.255.255.252</div><div class="line"># 然后在文件ccd/Thelonious中添加如下指令：</div><div class="line"># ifconfig-push 10.9.0.1 10.9.0.2</div><div class="line"></div><div class="line"># 如果你想要为不同群组的客户端启用不同的防火墙访问策略，你可以使用如下两种方法：</div><div class="line"># (1)运行多个OpenVPN守护进程，每个进程对应一个群组，并为每个进程(群组)启用适当的防火墙规则。</div><div class="line"># (2) (进阶)创建一个脚本来动态地修改响应于来自不同客户的防火墙规则。</div><div class="line"># 关于learn-address脚本的更多信息请参考官方手册页面。</div><div class="line">;learn-address ./script</div><div class="line"></div><div class="line"># 如果启用该指令，所有客户端的默认网关都将重定向到VPN，这将导致诸如web浏览器、DNS查询等所有客户端流量都经过VPN。</div><div class="line"># (为确保能正常工作，OpenVPN服务器所在计算机可能需要在TUN/TAP接口与以太网之间使用NAT或桥接技术进行连接)</div><div class="line">;push "redirect-gateway def1 bypass-dhcp"</div><div class="line"></div><div class="line"># 某些具体的Windows网络设置可以被推送到客户端，例如DNS或WINS服务器地址。</div><div class="line"># 下列地址来自opendns.com提供的Public DNS 服务器。</div><div class="line">;push "dhcp-option DNS 208.67.222.222"</div><div class="line">;push "dhcp-option DNS 208.67.220.220"</div><div class="line"></div><div class="line"># 去掉该指令的注释将允许不同的客户端之间相互"可见"(允许客户端之间互相访问)。</div><div class="line"># 默认情况下，客户端只能"看见"服务器。为了确保客户端只能看见服务器，你还可以在服务器端的TUN/TAP接口上设置适当的防火墙规则。</div><div class="line">;client-to-client</div><div class="line"></div><div class="line"># 如果多个客户端可能使用相同的证书/私钥文件或Common Name进行连接，那么你可以取消该指令的注释。</div><div class="line"># 建议该指令仅用于测试目的。对于生产使用环境而言，每个客户端都应该拥有自己的证书和私钥。</div><div class="line"># 如果你没有为每个客户端分别生成Common Name唯一的证书/私钥，你可以取消该行的注释(但不推荐这样做)。</div><div class="line">;duplicate-cn</div><div class="line"></div><div class="line"># keepalive指令将导致类似于ping命令的消息被来回发送，以便于服务器端和客户端知道对方何时被关闭。</div><div class="line"># 每10秒钟ping一次，如果120秒内都没有收到对方的回复，则表示远程连接已经关闭。</div><div class="line">keepalive 10 120</div><div class="line"></div><div class="line"># 出于SSL/TLS之外更多的安全考虑，创建一个"HMAC 防火墙"可以帮助抵御DoS攻击和UDP端口淹没攻击。</div><div class="line"># 你可以使用以下命令来生成：</div><div class="line"># openvpn --genkey --secret ta.key</div><div class="line">#</div><div class="line"># 服务器和每个客户端都需要拥有该密钥的一个拷贝。</div><div class="line"># 第二个参数在服务器端应该为'0'，在客户端应该为'1'。</div><div class="line">;tls-auth ta.key 0 # 该文件应该保密</div><div class="line"></div><div class="line"># 选择一个密码加密算法。</div><div class="line"># 该配置项也必须复制到每个客户端配置文件中。</div><div class="line">;cipher BF-CBC # Blowfish (默认)</div><div class="line">;cipher AES-128-CBC # AES</div><div class="line">;cipher DES-EDE3-CBC # Triple-DES</div><div class="line"></div><div class="line"># 在VPN连接上启用压缩。</div><div class="line"># 如果你在此处启用了该指令，那么也应该在每个客户端配置文件中启用它。</div><div class="line">comp-lzo</div><div class="line"></div><div class="line"># 允许并发连接的客户端的最大数量</div><div class="line">;max-clients 100</div><div class="line"></div><div class="line"># 在完成初始化工作之后，降低OpenVPN守护进程的权限是个不错的主意。</div><div class="line"># 该指令仅限于非Windows系统中使用。</div><div class="line">;user nobody</div><div class="line">;group nobody</div><div class="line"></div><div class="line"># 持久化选项可以尽量避免访问那些在重启之后由于用户权限降低而无法访问的某些资源。</div><div class="line">persist-key</div><div class="line">persist-tun</div><div class="line"></div><div class="line"># 输出一个简短的状态文件，用于显示当前的连接状态，该文件每分钟都会清空并重写一次。</div><div class="line">status openvpn-status.log</div><div class="line"></div><div class="line"># 默认情况下，日志消息将写入syslog(在Windows系统中，如果以服务方式运行，日志消息将写入OpenVPN安装目录的log文件夹中)。</div><div class="line"># 你可以使用log或者log-append来改变这种默认情况。</div><div class="line"># "log"方式在每次启动时都会清空之前的日志文件。</div><div class="line"># "log-append"这是在之前的日志内容后进行追加。</div><div class="line"># 你可以使用两种方式之一(但不要同时使用)。</div><div class="line">;log openvpn.log</div><div class="line">;log-append openvpn.log</div><div class="line"></div><div class="line"># 为日志文件设置适当的冗余级别(0~9)。冗余级别越高，输出的信息越详细。</div><div class="line">#</div><div class="line"># 0 表示静默运行，只记录致命错误。</div><div class="line"># 4 表示合理的常规用法。</div><div class="line"># 5 和 6 可以帮助调试连接错误。</div><div class="line"># 9 表示极度冗余，输出非常详细的日志信息。</div><div class="line">verb 3</div><div class="line"></div><div class="line"># 重复信息的沉默度。</div><div class="line"># 相同类别的信息只有前20条会输出到日志文件中。</div><div class="line">;mute 20</div></pre></td></tr></table></figure><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line">##############################################</div><div class="line"># 针对多个客户端的OpenVPN 2.0 的客户端配置文件示例</div><div class="line">#</div><div class="line"># 该配置文件可以被多个客户端使用，当然每个客户端都应该有自己的证书和密钥文件</div><div class="line">#</div><div class="line"># 在Windows上此配置文件的后缀应该是".ovpn"，在Linux/BSD系统中则是".conf"</div><div class="line">##############################################</div><div class="line"></div><div class="line"># 指定这是一个客户端，我们将从服务器获取某些配置文件指令</div><div class="line">client</div><div class="line"></div><div class="line"># 在大多数系统中，除非你部分禁用或者完全禁用了TUN/TAP接口的防火墙，否则VPN将不起作用。</div><div class="line">;dev tap</div><div class="line">dev tun</div><div class="line"></div><div class="line"># 在Windows系统中，如果你想配置多个隧道，则需要该指令。</div><div class="line"># 你需要用到网络连接面板中TAP-Win32适配器的名称(例如"MyTap")。</div><div class="line"># 在XP SP2或更高版本的系统中，你可能需要禁用掉针对TAP适配器的防火墙。</div><div class="line">;dev-node MyTap</div><div class="line"></div><div class="line"># 指定连接的服务器是采用TCP还是UDP协议。</div><div class="line"># 这里需要使用与服务器端相同的设置。</div><div class="line">;proto tcp</div><div class="line">proto udp</div><div class="line"></div><div class="line"># 指定服务器的主机名(或IP)以及端口号。</div><div class="line"># 如果有多个VPN服务器，为了实现负载均衡，你可以设置多个remote指令。</div><div class="line">remote my-server-1 1194</div><div class="line">;remote my-server-2 1194</div><div class="line"></div><div class="line"># 如果指定了多个remote指令，启用该指令将随机连接其中的一台服务器，</div><div class="line"># 否则，客户端将按照指定的先后顺序依次尝试连接服务器。</div><div class="line">;remote-random</div><div class="line"></div><div class="line"># 启用该指令，与服务器连接中断后将自动重新连接，这在网络不稳定的情况下(例如：笔记本电脑无线网络)非常有用。</div><div class="line">resolv-retry infinite</div><div class="line"></div><div class="line"># 大多数客户端不需要绑定本机特定的端口号</div><div class="line">nobind</div><div class="line"></div><div class="line"># 在初始化完毕后，降低OpenVPN的权限(该指令仅限于非Windows系统中使用)</div><div class="line">;user nobody</div><div class="line">;group nobody</div><div class="line"></div><div class="line"># 持久化选项可以尽量避免访问在重启时由于用户权限降低而无法访问的某些资源。</div><div class="line">persist-key</div><div class="line">persist-tun</div><div class="line"></div><div class="line"># 如果你是通过HTTP代理方式来连接到实际的VPN服务器，请在此处指定代理服务器的主机名(或IP)和端口号。</div><div class="line"># 如果你的代理服务器需要身份认证，请参考官方手册页面。</div><div class="line">;http-proxy-retry # 连接失败时自动重试</div><div class="line">;http-proxy [proxy server] [proxy port #]</div><div class="line"></div><div class="line"># 无线网络通常会产生大量的重复数据包。设置此标识将忽略掉重复数据包的警告信息。</div><div class="line">;mute-replay-warnings</div><div class="line"></div><div class="line"># SSL/TLS 参数配置。</div><div class="line"># 更多描述信息请参考服务器端配置文件。</div><div class="line"># 最好为每个客户端单独分配.crt/.key文件对。</div><div class="line"># 单个CA证书可以供所有客户端使用。</div><div class="line">ca ca.crt</div><div class="line">cert client.crt</div><div class="line">key client.key</div><div class="line"></div><div class="line"># 指定通过检查证书的nsCertType字段是否为"server"来验证服务器端证书。</div><div class="line"># 这是预防潜在攻击的一种重要措施。</div><div class="line">#</div><div class="line"># 为了使用该功能，你需要在生成服务器端证书时，将其中的nsCertType字段设为"server"</div><div class="line"># easy-rsa文件夹中的build-key-server脚本文件可以达到该目的。</div><div class="line">ns-cert-type server</div><div class="line"></div><div class="line"># 如果服务器端使用了tls-auth密钥，那么每个客户端也都应该有该密钥。</div><div class="line">;tls-auth ta.key 1</div><div class="line"></div><div class="line"># 指定密码的加密算法。</div><div class="line"># 如果服务器端启用了cipher指令选项，那么你必须也在这里指定它。</div><div class="line">;cipher x</div><div class="line"></div><div class="line"># 在VPN连接中启用压缩。</div><div class="line"># 该指令的启用/禁用应该与服务器端保持一致。</div><div class="line">comp-lzo</div><div class="line"></div><div class="line"># 设置日志文件冗余级别(0~9)。</div><div class="line"># 0 表示静默运行，只记录致命错误。</div><div class="line"># 4 表示合理的常规用法。</div><div class="line"># 5 和 6 可以帮助调试连接错误。</div><div class="line"># 9 表示极度冗余，输出非常详细的日志信息。</div><div class="line">verb 3</div><div class="line"></div><div class="line"># 忽略过多的重复信息。</div><div class="line"># 相同类别的信息只有前20条会输出到日志文件中。</div><div class="line">;mute 20</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> proxy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xtrabackup</title>
      <link href="/2017/05/11/xtrabackup/"/>
      <url>/2017/05/11/xtrabackup/</url>
      
        <content type="html"><![CDATA[<h1 id="XtraBackup"><a href="#XtraBackup" class="headerlink" title="XtraBackup"></a>XtraBackup</h1><p>xtrabackup包含两个主要的工具，即xtrabackup和innobackupex，二者区别如下：<br>（1）xtrabackup只能备份innodb和xtradb两种引擎的表，而不能备份myisam引擎的表；</p><p>（2）innobackupex是一个封装了xtrabackup的Perl脚本，支持同时备份innodb和myisam，但在对myisam备份时需要加一个全局的读锁。还有就是myisam不支持增量备份。</p><p>备份方式<br>  热备份：读写不受影响（mysqldump–&gt;innodb）<br>  温备份：仅可以执行读操作（mysqldump–&gt;myisam）<br>  冷备份：离线备份，读写都不可用<br>  逻辑备份：将数据导出文本文件中（mysqldump）<br>  物理备份：将数据文件拷贝（xtrabackup、mysqlhotcopy）</p><p>  完整备份：备份所有数据<br>  增量备份：仅备份上次完整备份或增量备份以来变化的数据<br>  差异备份：仅备份上次完整备份以来变化的数据</p><h2 id="configure"><a href="#configure" class="headerlink" title="configure"></a>configure</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">  mysql&gt; grant reload,lock tables,replication client on *.* to <span class="string">'bak'</span>@<span class="string">'localhost'</span> identified by <span class="string">'123456'</span>;</div><div class="line">  mysql&gt; flush privileges;</div><div class="line"></div><div class="line">mysql --version</div><div class="line"><span class="comment">#Error: Built-in InnoDB in MySQL 5.1 is not supported in this release. You can either use Percona XtraBackup 2.0, or upgrade to InnoDB plugin.</span></div><div class="line"></div><div class="line">cat /etc/my.cnf |grep datadir</div><div class="line"><span class="comment">##my.cnf中必须有datadir=/var/lib/mysql</span></div><div class="line"></div><div class="line"><span class="comment">#XtraBackup 2.0.6</span></div><div class="line">https://www.percona.com/downloads/XtraBackup/XtraBackup-2.0.6/RPM/rhel6/x86_64/percona-xtrabackup-2.0.6-521.rhel6.x86_64.rpm</div><div class="line"></div><div class="line"><span class="comment">#XtraBackup 2.0.8</span></div><div class="line">https://www.percona.com/downloads/XtraBackup/XtraBackup-2.0.8/RPM/rhel6/x86_64/percona-xtrabackup-20-2.0.8-587.rhel6.x86_64.rpm</div><div class="line"></div><div class="line"><span class="comment">##Xtrabackup 2.0.7 or 2.1.2 failed: expected log block no. 5458041, but got no. 1070811265 from the log file</span></div><div class="line"></div><div class="line">https://www.percona.com/downloads/XtraBackup/Percona-XtraBackup-2.4.6/binary/redhat/6/x86_64/percona-xtrabackup-24-2.4.6-2.el6.x86_64.rpm</div></pre></td></tr></table></figure><h2 id="options"><a href="#options" class="headerlink" title="options"></a>options</h2><p>参数<br>  –user= #指定数据库备份用户<br>  –password= #指定数据库备份用户密码<br>  –port= #指定数据库端口<br>  –host= #指定备份主机<br>  –socket= #指定socket文件路径<br>  –databases= #备份指定数据库,多个空格隔开，如–databases=”dbname1 dbname2”,不加备份所有库<br>  –defaults-file= #指定my.cnf配置文件<br>  –apply-log #日志回滚<br>  –incremental= #增量备份，后跟增量备份路径<br>  –incremental-basedir= #增量备份，指上次增量备份路径<br>  –redo-only #合并全备和增量备份数据文件<br>  –copy-back #将备份数据复制到数据库，数据库目录要为空<br>  –no-timestamp #生成备份文件不以时间戳为目录名<br>  –stream= #指定流的格式做备份,–stream=tar,将备份文件归档<br>  –remote-host=user@ip DST_DIR #备份到远程主机</p><h2 id="backup"><a href="#backup" class="headerlink" title="backup"></a>backup</h2><h3 id="全备"><a href="#全备" class="headerlink" title="全备"></a>全备</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">  innobackupex --stream=tar  --user=root --password=123456 \</div><div class="line">  /root/mysql_backup/full/ \</div><div class="line">  2&gt;&gt;/root/mysql_backup/xtrabackup.log \</div><div class="line">  | gzip &gt; /root/mysql_backup/full-backup.tar.gz</div><div class="line"></div><div class="line">#注：</div><div class="line">#/data/back_data/ ##指定备份目录</div><div class="line">#  2&gt;/data/back_data/zztx.log 输出信息写入日志中</div><div class="line">#  1&gt;/data/back_data/zztx.tar.gz 打包压缩存储到该文件中</div></pre></td></tr></table></figure><h3 id="增备"><a href="#增备" class="headerlink" title="增备"></a>增备</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">innobackupex --user=root --password=123456 \</div><div class="line">--incremental --incremental-basedir=/root/mysql_backup/full/2017-04-06_21-41-07/ \</div><div class="line">/root/mysql_backup/incremental/</div><div class="line"></div><div class="line">#incremental-basedir=指定增备基准目录</div></pre></td></tr></table></figure><h2 id="resotre"><a href="#resotre" class="headerlink" title="resotre"></a>resotre</h2><h3 id="全备恢复"><a href="#全备恢复" class="headerlink" title="全备恢复"></a>全备恢复</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">tar -izxvf full-backup.tar.gz -C /root/mysql_backup/</div><div class="line"></div><div class="line">innobackupex --apply-log  /root/mysql_backup/2017-04-06_21-41-07 </div><div class="line"></div><div class="line">innobackupex --copy-back  /root/mysql_backup/2017-04-06_21-41-07 </div><div class="line"></div><div class="line">chown -R mysql:mysql /var/lib/mysql</div><div class="line">service mysqld restart</div></pre></td></tr></table></figure><h3 id="增备恢复"><a href="#增备恢复" class="headerlink" title="增备恢复"></a>增备恢复</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">恢复完全备份</div><div class="line">恢复增量备份到完全备份（开始恢复的增量备份要添加--redo-only参数，到最后一次增量备份去掉--redo-only参数）</div><div class="line">对整体的完全备份进行恢复，回滚那些未提交的数据</div><div class="line">恢复完全备份（注意这里一定要加--redo-only参数，该参数的意思是只应用xtrabackup日志中已提交的事务数据，不回滚还未提交的数据）</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">innobackupex --apply-log --redo-only \</div><div class="line">/full/2017-04-07_23-35-54/</div><div class="line"></div><div class="line">innobackupex --apply-log --redo-only \</div><div class="line">/full/2017-04-07_23-35-54/ \</div><div class="line">--incremental-dir=/incremental/2014-04-07_23-42-46/</div><div class="line"></div><div class="line">innobackupex --apply-log \</div><div class="line">/full/2017-04-07_23-35-54/ \</div><div class="line">--incremental-dir=/incremental/2017-04-07_23-41-31/</div><div class="line"></div><div class="line">chown -R mysql:mysql /var/lib/mysql</div><div class="line">service mysqld restart</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> db </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssh proxy</title>
      <link href="/2017/05/11/ssh-proxy/"/>
      <url>/2017/05/11/ssh-proxy/</url>
      
        <content type="html"><![CDATA[<h2 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h2><h2 id="options"><a href="#options" class="headerlink" title="options"></a>options</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">-1：强制使用ssh协议版本1；</div><div class="line">-2：强制使用ssh协议版本2；</div><div class="line">-4：强制使用IPv4地址；</div><div class="line">-6：强制使用IPv6地址；</div><div class="line">-A：开启认证代理连接转发功能；</div><div class="line">-a：关闭认证代理连接转发功能；</div><div class="line">-b：使用本机指定地址作为对应连接的源ip地址；</div><div class="line">-C：请求压缩所有数据；</div><div class="line">-F：指定ssh指令的配置文件；</div><div class="line">-f：后台执行ssh指令；</div><div class="line">-g：允许远程主机连接主机的转发端口；</div><div class="line">-i：指定身份文件；</div><div class="line">-l：指定连接远程服务器登录用户名；</div><div class="line">-N：不执行远程指令；</div><div class="line">-o：指定配置选项；</div><div class="line">-p：指定远程服务器上的端口；</div><div class="line">-q：静默模式；</div><div class="line">-X：开启X11转发功能；</div><div class="line">-x：关闭X11转发功能；</div><div class="line">-y：开启信任X11转发功能</div><div class="line">-D：SOCK port</div></pre></td></tr></table></figure><h2 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh -L 6666:c_ip:80 b_user@b_ip</div><div class="line"><span class="comment">#监听本地6666端口，通过主机b访问主机C的80端口</span></div></pre></td></tr></table></figure><h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh -Rg b_port:127.0.0.1:80 b_user@b_ip</div><div class="line"><span class="comment">#监听Host b_port，访问b_ip:b_port转到本地80端口</span></div></pre></td></tr></table></figure><h2 id="SOCK-proxy"><a href="#SOCK-proxy" class="headerlink" title="SOCK proxy"></a>SOCK proxy</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssh -CN<span class="built_in">fg</span>D 6666 user@host_ip</div><div class="line"><span class="comment">#监听本地6666端口，转发数据到host_ip主机</span></div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> proxy </tag>
            
            <tag> ssh </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>crontab error</title>
      <link href="/2017/05/11/crontab-error/"/>
      <url>/2017/05/11/crontab-error/</url>
      
        <content type="html"><![CDATA[<h2 id="problem"><a href="#problem" class="headerlink" title="problem"></a>problem</h2><p>crontab 脚本日志输出的时间与crontab设置脚本执行时间不一致<br>相差约8小时，脚本以往正常执行不会这么长时间</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">shell&gt; cat /etc/crontab</div><div class="line">SHELL=/bin/bash</div><div class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</div><div class="line">MAILTO=root</div><div class="line">HOME=/</div><div class="line"></div><div class="line"># For details see man 4 crontabs</div><div class="line"></div><div class="line"># Example of job definition:</div><div class="line"># .---------------- minute (0 - 59)</div><div class="line"># | .------------- hour (0 - 23)</div><div class="line"># | | .---------- day of month (1 - 31)</div><div class="line"># | | | .------- month (1 - 12) OR jan,feb,mar,apr ...</div><div class="line"># | | | | .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</div><div class="line"># | | | | |</div><div class="line"># * * * * * user-name command to be executed</div><div class="line">10 23 * * * root /bin/bash /root/data_sync.sh 140 &amp;&gt;/dev/null &amp;</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">shell&gt; cat /var/log/cron</div><div class="line">May 9 23:10:01 jwc CROND[15600]: (root) CMD (/bin/bash /root/data_sync.sh 140 &amp;&gt;/dev/null &amp;)</div></pre></td></tr></table></figure><p>通过cron日志可以看出任务执行时间是正确的</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#查看脚本输出日志</div><div class="line">[ 10.0.0.140 ] Start sync 2017-05-09-07:10:01****</div><div class="line"></div><div class="line">x@10.0.0.140:/x/x/ Start sync 2017-05-09-07:10:06****</div><div class="line">receiving incremental file list</div><div class="line"></div><div class="line">sent 11 bytes received 59 bytes 140.00 bytes/sec</div><div class="line">total size is 1.68K speedup is 23.94 (DRY RUN)</div><div class="line"></div><div class="line">x@10.0.0.140:/x/x/target Start sync 2017-05-09-07:10:07****</div><div class="line">receiving incremental file list</div><div class="line">target/2017/05/</div><div class="line">target/2017/05/08/</div></pre></td></tr></table></figure><p>执行时间与脚本日志输出的时间不一致</p><h2 id="排查："><a href="#排查：" class="headerlink" title="排查："></a>排查：</h2><p>1、/etc/crontab和脚本，近期未变更过，可以排除</p><p>2、查看系统时区：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">shell&gt; date -R</div><div class="line">Thu, 09 May 2017 09:30:46 +0800</div><div class="line"><span class="comment">#系统时间正常</span></div><div class="line"></div><div class="line">shell&gt; hwclock</div><div class="line">Thu May 09 09:30:51 2017 -0.828539 seconds</div><div class="line"><span class="comment">#硬件时间正常</span></div><div class="line"></div><div class="line"><span class="comment">#进一步查看配置文件</span></div><div class="line">shell&gt; cat /etc/sysconfig/clock</div><div class="line">ZONE=<span class="string">"Asia/Shanghai"</span></div></pre></td></tr></table></figure></p><p>也没有问题</p><p>3、联想到之前遇到过动态库导致时间错乱的问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">shell&gt; lsof -c crond</div><div class="line">COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME</div><div class="line">crond 10558 root cwd DIR 253,0 4096 1048577 /root</div><div class="line">crond 10558 root rtd DIR 253,0 4096 2 /</div><div class="line">crond 10558 root txt REG 253,0 64096 788930 /usr/sbin/crond</div><div class="line">crond 10558 root mem REG 253,0 62080 3277211 /lib64/libnss_files-2.12.so</div><div class="line">crond 10558 root mem REG 253,0 10312 3276806 /lib64/libfreebl3.so</div><div class="line">crond 10558 root mem REG 253,0 40552 3276818 /lib64/libcrypt-2.12.so</div><div class="line">crond 10558 root mem REG 253,0 2095336 3276814 /lib64/libc-2.14.so</div><div class="line">crond 10558 root mem REG 253,0 145864 3276870 /lib64/libaudit.so.1.0.0</div><div class="line">crond 10558 root mem REG 253,0 19536 3276956 /lib64/libdl-2.12.so</div><div class="line">crond 10558 root mem REG 253,0 55848 3276844 /lib64/libpam.so.0.82.2</div><div class="line">crond 10558 root mem REG 253,0 122056 3276882 /lib64/libselinux.so.1</div><div class="line">crond 10558 root mem REG 253,0 164400 3276931 /lib64/ld-2.12.so</div><div class="line">crond 10558 root 0u CHR 1,3 0t0 4025 /dev/null</div><div class="line">crond 10558 root 1u CHR 1,3 0t0 4025 /dev/null</div><div class="line">crond 10558 root 2u CHR 1,3 0t0 4025 /dev/null</div><div class="line">crond 10558 root 3u REG 253,0 6 3539247 /var/run/crond.pid</div><div class="line">crond 10558 root 4u unix 0xffff88081f5c07c0 0t0 15330036 socket</div><div class="line">crond 10558 root 5r DIR 0,10 0 1 inotify</div><div class="line">#很奇怪 libc-2.14.so 是2.14版本的</div><div class="line">#但是 libnss_files-2.12.so libcrypt-2.12.so libdl-2.12.so ld-2.12.so 版本却是2.12</div><div class="line"></div><div class="line">shell&gt; ldd --version</div><div class="line">ldd (GNU libc) 2.12</div><div class="line">Copyright (C) 2010 Free Software Foundation, Inc.</div><div class="line">This is free software; see the source for copying conditions. There is NO</div><div class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</div><div class="line">Written by Roland McGrath and Ulrich Drepper.</div><div class="line">#查看glibc版本是2.12</div><div class="line">#到此，问题可能是glibc没有正确安装</div></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">#重新编译glibc</div><div class="line">shell&gt; wget http://ftp.gnu.org/gnu/glibc/glibc-2.14.tar.xz</div><div class="line">shell&gt; tar xf glibc-2.14.tar.xz　-C /opt/</div><div class="line">shell&gt; mkdir /tmp/glibc-build</div><div class="line">shell&gt; cd /tmp/glibc-build</div><div class="line"></div><div class="line">shell&gt; /opt/glibc-2.14/configure --prefix=/usr</div><div class="line">shell&gt; make -j4</div><div class="line">shell&gt; make -j4 install</div><div class="line"></div><div class="line">shell&gt; ldd --version</div><div class="line">ldd (GNU libc) 2.14</div><div class="line">Copyright (C) 2011 Free Software Foundation, Inc.</div><div class="line">This is free software; see the source for copying conditions. There is NO</div><div class="line">warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</div><div class="line">Written by Roland McGrath and Ulrich Drepper.</div><div class="line">#可见glibc已经安装成功</div></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">shell&gt; /etc/init.d/crond restart</div><div class="line">#重启crond 再次查看</div><div class="line">shell&gt; lsof -c crond</div><div class="line">COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME</div><div class="line">crond 10558 root cwd DIR 253,0 4096 1048577 /root</div><div class="line">crond 10558 root rtd DIR 253,0 4096 2 /</div><div class="line">crond 10558 root txt REG 253,0 64096 788930 /usr/sbin/crond</div><div class="line">crond 10558 root mem REG 253,0 62080 3277211 /lib64/libnss_files-2.14.so</div><div class="line">crond 10558 root mem REG 253,0 10312 3276806 /lib64/libfreebl3.so</div><div class="line">crond 10558 root mem REG 253,0 40552 3276818 /lib64/libcrypt-2.14.so</div><div class="line">crond 10558 root mem REG 253,0 2095336 3276814 /lib64/libc-2.14.so</div><div class="line">crond 10558 root mem REG 253,0 145864 3276870 /lib64/libaudit.so.1.0.0</div><div class="line">crond 10558 root mem REG 253,0 19536 3276956 /lib64/libdl-2.14.so</div><div class="line">crond 10558 root mem REG 253,0 55848 3276844 /lib64/libpam.so.0.82.2</div><div class="line">crond 10558 root mem REG 253,0 122056 3276882 /lib64/libselinux.so.1</div><div class="line">crond 10558 root mem REG 253,0 164400 3276931 /lib64/ld-2.14.so</div><div class="line">crond 10558 root 0u CHR 1,3 0t0 4025 /dev/null</div><div class="line">crond 10558 root 1u CHR 1,3 0t0 4025 /dev/null</div><div class="line">crond 10558 root 2u CHR 1,3 0t0 4025 /dev/null</div><div class="line">crond 10558 root 3u REG 253,0 6 3539247 /var/run/crond.pid</div><div class="line">crond 10558 root 4u unix 0xffff88081f5c07c0 0t0 15330036 socket</div><div class="line">crond 10558 root 5r DIR 0,10 0 1 inotify</div><div class="line">#可以看到已经加载了正确的库</div></pre></td></tr></table></figure><p>##进一步验证crontab是否正常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">shell&gt; w</div><div class="line">USER TTY FROM LOGIN@ IDLE JCPU PCPU WHAT</div><div class="line">root tty1 - 17:53 35:36 0.02s 0.02s -bash</div><div class="line">root pts/0 x.x.x.x 17:54 0.00s 0.19s 0.00s w</div><div class="line"></div><div class="line">echo &apos;*/1 * * * * root echo `date` &gt; /dev/pts/0&apos; &gt;&gt; /etc/crontab</div><div class="line">#每分钟输出当前时间到终端</div><div class="line"></div><div class="line">Thu May 11 10:27:01 CST 2017</div><div class="line">Thu May 11 10:28:01 CST 2017</div><div class="line">#终端正常输出，可知问题已经解决</div></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> know error </category>
          
      </categories>
      
      
        <tags>
            
            <tag> crontab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>auth.log No such file or directory</title>
      <link href="/2017/05/09/auth-log/"/>
      <url>/2017/05/09/auth-log/</url>
      
        <content type="html"><![CDATA[<h2 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h2><p>/var/log/auth.log<br>阿X云部分主机没有这个文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ls /var/log/</span></div><div class="line">alternatives.log apt dmesg.0 gshell.log mysql.log mysql.log.3.gz mysql.log.6.gz repair.log</div><div class="line">alternatives.log.1 boot.log dpkg.log mysql mysql.log.1.gz mysql.log.4.gz mysql.log.7.gz udev</div><div class="line">apache2 dmesg dpkg.log.1 mysql.err mysql.log.2.gz mysql.log.5.gz ntp.log upstart</div></pre></td></tr></table></figure><h2 id="问题排查"><a href="#问题排查" class="headerlink" title="问题排查"></a>问题排查</h2><h3 id="首先确认rsyslog进程是否正常运行："><a href="#首先确认rsyslog进程是否正常运行：" class="headerlink" title="首先确认rsyslog进程是否正常运行："></a>首先确认rsyslog进程是否正常运行：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># ps aux | grep syslog</span></div><div class="line">changmi 17590 0.0 0.0 11740 932 pts/0 S+ 17:42 0:00 \_ grep --color=auto syslog</div><div class="line">syslog 17389 0.0 0.0 190304 1148 ? Ssl 17:31 0:00 rsyslogd</div></pre></td></tr></table></figure><h3 id="排查rsyslog配置："><a href="#排查rsyslog配置：" class="headerlink" title="排查rsyslog配置："></a>排查rsyslog配置：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">grep authpriv /etc/rsyslog.d/50-default.conf </div><div class="line">auth,authpriv.*         /var/<span class="built_in">log</span>/auth.log</div><div class="line">*.*;auth,authpriv.none      -/var/<span class="built_in">log</span>/syslog</div></pre></td></tr></table></figure><p>可以看到也是默认的配置，并没有做任何改动。</p><p>md5sum对比两个服务器(正常，异常)的rsyslog.conf，md5值一致<br>有资料提到ssh配置文件的问题，比较后两个服务器配置文件也是一致的</p><p>在保证配置文件是一致的情况下，重启了rsyslog、ssh，但是/var/log/auth.log 依然没有</p><h3 id="尝试手动创建文件"><a href="#尝试手动创建文件" class="headerlink" title="尝试手动创建文件"></a>尝试手动创建文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#按照正常服务器上的auth.log</span></div><div class="line">ll /var/<span class="built_in">log</span>/auth.log</div><div class="line">-rw-r----- 1 syslog adm 68691 May 9 17:21 /var/<span class="built_in">log</span>/auth.log</div><div class="line"><span class="comment">#按照以上信息，手动创建文件</span></div><div class="line"> touch /var/<span class="built_in">log</span>/auth.log</div><div class="line"> chmod 640 /var/<span class="built_in">log</span>/auth.log</div><div class="line"> chown syslog.adm /var/<span class="built_in">log</span>/auth.log</div><div class="line"> ls -la /var/<span class="built_in">log</span>/auth.log</div><div class="line">-rw-r----- 1 syslog adm 4217 May 9 17:45 /var/<span class="built_in">log</span>/auth.log</div></pre></td></tr></table></figure><p>断开ssh重新登录<br>cat /var/log/auth.log<br>已经开始记录信息<br>大致可以断定问题在权限上</p><p>继续排查目录权限<br>最终定位：/var/log<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># server not ok</span></div><div class="line">ls <span class="_">-l</span> /var/ | grep <span class="built_in">log</span></div><div class="line">drwxr-xr-x 5 root root 4096 May 9 17:36 <span class="built_in">log</span></div><div class="line"></div><div class="line"><span class="comment"># server ok</span></div><div class="line">ls <span class="_">-l</span> /var/ | grep <span class="built_in">log</span></div><div class="line">drwxrwxr-x 18 root syslog 4096 May 9 10:52 <span class="built_in">log</span></div></pre></td></tr></table></figure></p><p>可以看出，的确是权限导致的</p><p>The end:<br><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">问题：/var/log/auth.log文件不存在</div><div class="line">排查路径：</div><div class="line">  进程：rsyslog</div><div class="line">  配置：rsyslog.conf</div><div class="line">  权限：/var/log</div></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> know error </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>MySQL master-slave</title>
      <link href="/2017/05/08/mysql_MS/"/>
      <url>/2017/05/08/mysql_MS/</url>
      
        <content type="html"><![CDATA[<h1 id="master-slave-OS-CentOS"><a href="#master-slave-OS-CentOS" class="headerlink" title="master slave OS : CentOS"></a>master slave OS : CentOS</h1><h2 id="master"><a href="#master" class="headerlink" title="master"></a>master</h2><p>172.16.90.129<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#创建同步用户并赋予权限</div><div class="line">mysql&gt; GRANT REPLICATION SLAVE,REPLICATION CLIENT,SUPER, RELOAD ON *.* TO 'slave'@'192.168.0.1' IDENTIFIED BY 'slave';</div><div class="line">mysql&gt; flush privileges;</div><div class="line">mysql&gt; select * from mysql.user WHERE user='slave'\G;</div><div class="line"></div><div class="line">mysql&gt; flush tables with read lock;flush table with read lock;</div><div class="line">mysql&gt; show master status;</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| File | Position | Binlog_Do_DB | Binlog_Ignore_DB |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">| mysql-bin.000001 | 711 | | |</div><div class="line">+------------------+----------+--------------+------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure></p><h3 id="my-cnf"><a href="#my-cnf" class="headerlink" title="my.cnf"></a>my.cnf</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[mysqld]</div><div class="line">datadir=/var/lib/mysql</div><div class="line">socket=/var/lib/mysql/mysql.sock</div><div class="line">user=mysql</div><div class="line"># Disabling symbolic-links is recommended to prevent assorted security risks</div><div class="line">symbolic-links=0</div><div class="line">server-id=1</div><div class="line">log-bin=mysql-bin</div><div class="line">max_binlog_size=200M</div><div class="line"></div><div class="line">log_bin_trust_function_creators=1 ##</div><div class="line">sync_binlog=1                                                    #进行n次事务提交之后,二进制日志（binary log）同步到磁盘的频率</div><div class="line">innodb_flush_logs_at_trx_commit=1            #立刻刷新innodb日志</div><div class="line"></div><div class="line">[mysqld_safe]</div><div class="line">log-error=/var/log/mysqld.log</div><div class="line">pid-file=/var/run/mysqld/mysqld.pid</div><div class="line"></div><div class="line">/etc/init.d/mysqld restart</div></pre></td></tr></table></figure><p>mysql -uroot -e ‘show master status’</p><p>#记录binlog文件,以及pos值</p><h3 id="backup-master-data"><a href="#backup-master-data" class="headerlink" title="backup master data"></a>backup master data</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#可以使用innobackupex mysqldump 直接复制文件等方式</span></div><div class="line">innobackupex --user=DBUSER --password=DBUSERPASS /path/to/BACKUP-DIR</div><div class="line">innobackupex --apply-log /path/to/BACKUP-DIR</div></pre></td></tr></table></figure><h3 id="copy-data-to-slave"><a href="#copy-data-to-slave" class="headerlink" title="copy data to slave"></a>copy data to slave</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#将文件传送到slave mysql data目录</span></div><div class="line">rsync -avHP /path/to/BACKUP-DIR root@slave_host:/data/</div></pre></td></tr></table></figure><p><code>/etc/init.d/mysqld restart</code></p><h2 id="slave"><a href="#slave" class="headerlink" title="slave"></a>slave</h2><p>172.16.90.130</p><h3 id="my-cnf-1"><a href="#my-cnf-1" class="headerlink" title="my.cnf"></a>my.cnf</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[mysqld]</div><div class="line">datadir=/var/lib/mysql</div><div class="line">socket=/var/lib/mysql/mysql.sock</div><div class="line">user=mysql</div><div class="line"># Disabling symbolic-links is recommended to prevent assorted security risks</div><div class="line">symbolic-links=0</div><div class="line">server-id=2     #如果有多个slave 该值必须唯一</div><div class="line">#log-bin = mysql-bin</div><div class="line">read_only=1 #设置为只读</div><div class="line"></div><div class="line">[mysqld_safe]</div><div class="line">log-error=/var/log/mysqld.log</div><div class="line">pid-file=/var/run/mysqld/mysqld.pid</div></pre></td></tr></table></figure><h3 id="copy-back"><a href="#copy-back" class="headerlink" title="copy back"></a>copy back</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#将master数据导入slave</span></div><div class="line">innobackupex --copy-back /path/to/BACKUP-DIR</div><div class="line">chown -R mysql:mysql /mydata/data/</div><div class="line">/etc/init.d/mysqld start</div><div class="line"></div><div class="line">mysql&gt; change master to master_host=<span class="string">'172.16.90.129'</span>,</div><div class="line">       master_user=<span class="string">'slave'</span>,</div><div class="line">       master_password=<span class="string">'slave'</span>,</div><div class="line">       master_log_file=<span class="string">'mysql-bin.000001'</span>,</div><div class="line">       master_log_pos=711;</div><div class="line">       start slave;</div><div class="line">mysql&gt; show slave status\G;  </div><div class="line"><span class="comment">#查看slave 状态</span></div><div class="line">主要关注 Slave_IO_Running | Slave_SQL_Running 两个值，必须都是YES才可以</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> db </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cacti 1.X</title>
      <link href="/2017/05/06/cacti/"/>
      <url>/2017/05/06/cacti/</url>
      
        <content type="html"><![CDATA[<h2 id="cacti-dependence"><a href="#cacti-dependence" class="headerlink" title="cacti dependence"></a>cacti dependence</h2><h2 id="php"><a href="#php" class="headerlink" title="php"></a>php</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#/etc/php.ini</div><div class="line">safe_mode = Off</div><div class="line">date.timezone = "Asia/Shanghai"</div></pre></td></tr></table></figure><h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#my.cnf</div><div class="line">[mysqld]</div><div class="line">basedir = /opt/mysql_cacti/</div><div class="line">datadir = /opt/mysql_cacti/data</div><div class="line">bind-address= 0.0.0.0</div><div class="line">port = 3333</div><div class="line">user=mysql</div><div class="line"># server_id = .....</div><div class="line">socket = /opt/mysql_cacti/mysql.sock</div><div class="line">max_heap_table_size=1567M</div><div class="line">max_allowed_packet=16777216</div><div class="line">join_buffer_size=64M</div><div class="line">tmp_table_size=64M</div><div class="line">innodb_buffer_pool_size=7835M</div><div class="line">innodb_doublewrite=0</div><div class="line">innodb_additional_mem_pool_size=80M</div><div class="line">innodb_flush_log_at_timeout=3</div><div class="line">innodb_read_io_threads=32</div><div class="line">innodb_write_io_threads=16</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">shell&gt; yum install net-snmp net-snmp-libs net-snmp-utils rrdtool perl-devel perl-CPAN perl-YAML</div><div class="line"><span class="comment">#安装依赖</span></div><div class="line"></div><div class="line">shell&gt; wget http://www.cacti.net/downloads/cacti-1.1.3.tar.gz</div><div class="line">shell&gt; tar xzf cacti-1.1.3.tar.gz -C /www/</div><div class="line">shell&gt; ln <span class="_">-s</span> /www/cacti-1.1.3/ /www/cacti</div><div class="line">shell&gt; <span class="built_in">cd</span> /www/cacti/</div><div class="line"></div><div class="line">shell&gt; mysql -root -p</div><div class="line">mysql&gt; create database cacti;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; show databases;</div><div class="line">+--------------------+</div><div class="line">| Database           |</div><div class="line">+--------------------+</div><div class="line">| information_schema |</div><div class="line">| cacti              |</div><div class="line">| mysql              |</div><div class="line">| performance_schema |</div><div class="line">+--------------------+</div><div class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</div><div class="line"><span class="comment">#创建数据库</span></div><div class="line"></div><div class="line">mysql&gt; <span class="built_in">source</span> cacti.sql</div><div class="line"><span class="comment">#导入数据</span></div><div class="line"></div><div class="line">mysql&gt; GRANT ALL ON cacti.* TO cactiuser@localhost IDENTIFIED BY <span class="string">'somepassword'</span>;</div><div class="line">mysql&gt; flush privileges;</div><div class="line">mysql&gt; <span class="built_in">exit</span></div><div class="line"><span class="comment">#创建cacti帐号，赋予权限</span></div><div class="line"></div><div class="line">shell&gt; chown -R cactiuser rra/ <span class="built_in">log</span>/</div><div class="line"><span class="comment">#/etc/crontab</span></div><div class="line">*/5 * * * * cactiuser php /var/www/html/cacti/poller.php &gt; /dev/null 2&gt;&amp;1</div><div class="line"><span class="comment">#将每5分钟执行一次的数据获取脚本加入crontab</span></div></pre></td></tr></table></figure><h2 id="cacti-configure"><a href="#cacti-configure" class="headerlink" title="cacti configure"></a>cacti configure</h2><blockquote><p>Edit “include/config.php” and specify the database type, name, host,user and password for your Cacti configuration.<br><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="formula">$database_type = "mysql";</span></div><div class="line">$database_default = "cacti";</div><div class="line"><span class="formula">$database_hostname = "127.0.0.1";</span></div><div class="line">$database_username = "cactiuser";</div><div class="line"><span class="formula">$database_password = "cacti";</span></div><div class="line">$database_port     = '3333';</div><div class="line">#修改数据库连接配置</div><div class="line"></div><div class="line">/* load up old style plugins here */</div><div class="line"><span class="formula">$plugins = array();</span></div><div class="line">//$plugins[] = 'thold';</div><div class="line"></div><div class="line">/*</div><div class="line">   Edit this to point to the default URL of your Cacti install</div><div class="line">   ex: if your cacti install as at http://serverip/cacti/ this</div><div class="line">   would be set to /cacti/</div><div class="line">*/</div><div class="line"><span class="formula">$url_path = "/cacti/";</span></div><div class="line"></div><div class="line">/* Default session name - Session name must contain alpha characters */</div><div class="line">#$cacti_session_name = "Cacti";</div></pre></td></tr></table></figure></p></blockquote><p>重启nginx php mysql<br>访问 <a href="http://localhost/cacti" target="_blank" rel="external">http://localhost/cacti</a> </p><p>无错误即可，到此安装完毕<br><img src="/2017/05/06/cacti/img/20170504201308075.png" alt="logo"></p><p>#更多内容详见官方手册<br><a href="http://docs.cacti.net/manual" target="_blank" rel="external">http://docs.cacti.net/manual</a></p><h2 id="know-errors"><a href="#know-errors" class="headerlink" title="know errors"></a>know errors</h2><p>1.</p><blockquote><p>ERROR:Your Cacti database login account does not have access to the<br>MySQL TimeZone database. Please provide the Cacti database account<br>“select” access to the “time_zone_name” table in the “mysql” database,<br>and populate MySQL’s TimeZone information before proceeding. mysql&gt;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GRANT SELECT ON mysql.time_zone_name TO cactiuser@localhost IDENTIFIED BY &apos;cacti&apos;</div></pre></td></tr></table></figure></p></blockquote><p>2.</p><blockquote><p>ERROR: Your MySQL TimeZone database is not populated. Please populate<br>this database before proceeding.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql_tzinfo_to_sql /usr/share/zoneinfo/ | mysql -u root -p mysql</div></pre></td></tr></table></figure></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> monitor </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Fork boom</title>
      <link href="/2017/05/05/fork_boom/"/>
      <url>/2017/05/05/fork_boom/</url>
      
        <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">:() &#123; :|:&amp; &#125;;:</div></pre></td></tr></table></figure><ul><li>注解如下：<br>:() # 定义函数,函数名为”:”,即每当输入”:”时就会自动调用{}内代码 { # “:”函數起始字元<br>: # 用递归方式调用”:”函数本身<br>| # 並用管線(pipe)將其輸出引至…（因为有一个管線操作字元，因此會生成一個新的進程）<br>: # 另一次递归调用的”:”函数<br>#综上,”:|:”表示的即是每次調用函数”:”的時候就會產生兩份拷貝<br>&amp; # 調用間脱鉤,以使最初的”:”函数被關閉後為其所調用的兩個”:”函數還能繼續執行 } # “:”函數終止字元 ; # “:”函数定义结束后将要进行的操作… : #<br>调用”:”函数,”引爆”fork炸弹</li></ul><p>Windows下則可以批次處理命令如下實作：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">%0|%0</div></pre></td></tr></table></figure></p><ul><li>默认情况下，bash处于非POSIX模式，此时对命令的解释顺序如下：<br>关键字，例如 if、for 等。<br>别名。别名不能与关键字相同，但是可以为关键字定义别名，例如 end=fi。<br>特殊内嵌命令，例如 break、continue 等。POSIX 定义的特殊内嵌命令包括：.（小数点）、:（冒号）、break、continue、eval、exec、exit、export、readonly、 return、set、shift、times、trap 和 unset。<br>bash 又增加了一个特殊的内嵌命令 source函数。如果处于非 POSIX 模式，bash 会优先匹配函数，然后再匹配内嵌命令。<br>非特殊内嵌命令，例如 cd、test 等。<br>脚本和可执行程序。在 PATH 环境变量指定的目录中进行搜索，返回第一个匹配项。 由 于默认情况下，bash 处于非 POSIX 模式，因此fork炸弹中的小数点会优先当成一个函数进行匹配。(注：使用小数点代替其中的冒号，也能起到完全相同的效果。)</li></ul><p>要使用POSIX模式来运行bash脚本，可以使用以下三种方法：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">使用 -posix 选项启动 bash</div><div class="line">在运行bash之后，执行 <span class="built_in">set</span> -o posix 命令</div><div class="line">使用 /bin/sh</div></pre></td></tr></table></figure><ul><li>由于ForkBomb通过不断的开新进程来瘫痪系统，一个防止其严重影响系统的方法就是限定一个用户能够创建的进程数的上限，在Linux系统上，可以通过ulimit这个指令达到相应的效果，例如：ulimit -Hu 30  这个指令可以限制每一个用户最多只能创建30个进程还可以通过修改配置文件/etc/security/limits.conf来限制可生成的最大进程数来避开这枚炸弹而FreeBSD系统的话系统管理者可以在/etc/login.conf底下的配置文件进行相关的设置</li></ul><p><a href="http://en.wikipedia.org/wiki/Fork_bomb" target="_blank" rel="external">http://en.wikipedia.org/wiki/Fork_bomb</a><br><a href="https://zh.wikipedia.org/wiki/Fork%E7%82%B8%E5%BC%B9" target="_blank" rel="external">https://zh.wikipedia.org/wiki/Fork%E7%82%B8%E5%BC%B9</a></p>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>make rpm</title>
      <link href="/2017/05/05/fpm/"/>
      <url>/2017/05/05/fpm/</url>
      
        <content type="html"><![CDATA[<h2 id="FPM的安装"><a href="#FPM的安装" class="headerlink" title="FPM的安装"></a>FPM的安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">yum install -y rubygems ruby-devel rubygems-devel rpm-build</div><div class="line">gem list</div><div class="line">gem <span class="built_in">source</span> --list</div><div class="line">gem <span class="built_in">source</span> --addd https://ruby.taobao.org</div><div class="line">gem <span class="built_in">source</span> --remove http://rubygems.org</div><div class="line">gem install json -v 1.8.3 -V</div><div class="line">gem install fpm -v 1.4.0 -V</div></pre></td></tr></table></figure><h2 id="FPM常用参数"><a href="#FPM常用参数" class="headerlink" title="FPM常用参数"></a>FPM常用参数</h2><p>  -s:指定源类型<br>  -t:指定目标类型，即想要制作为什么包<br>  -n:指定包的名字<br>  -v:指定包的版本号<br>  -C:指定打包的相对路径<br>  -d:指定依赖于哪些包<br>  -f:第二次包时目录下如果有同名安装包存在，则覆盖它<br>  -p:输出的安装包的目录，不想放在当前目录下就需要指定  –post-install:软件包安装完成之后所要运行的脚本；同–offer-install<br>  –pre-install:软件包安装完成之前所要运行的脚本；同–before-install<br>  –post-uninstall:软件包卸载完成之后所要运行的脚本；同–offer-remove<br>  –pre-uninstall:软件包卸载完成之前所要运行的脚本；同—before-remove</p><h2 id="know-errors"><a href="#know-errors" class="headerlink" title="know errors"></a>know errors</h2><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1.Need executable ‘rpmbuild’ to convert dir to rpm &#123;:level=&gt;:error&#125;</div><div class="line"></div><div class="line">solution： </div><div class="line">[root@localhost]# yum install -y rpm-build</div></pre></td></tr></table></figure><h2 id="EX"><a href="#EX" class="headerlink" title="EX"></a>EX</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">fpm <span class="_">-s</span> dir -t rpm -n nginx -v 1.10.1 \</div><div class="line">--post-install /root/ngpost.sh \</div><div class="line"><span class="_">-f</span> /usr/<span class="built_in">local</span>/nginx</div><div class="line"><span class="_">-d</span> <span class="string">'zlib-devel,pcre-devel,openssl-devel'</span> \</div><div class="line">no value <span class="keyword">for</span> epoch is <span class="built_in">set</span>, defaulting to nil &#123;:level=&gt;:warn&#125;</div><div class="line">no value <span class="keyword">for</span> epoch is <span class="built_in">set</span>, defaulting to nil &#123;:level=&gt;:warn&#125;</div><div class="line">Created package &#123;:path=&gt;<span class="string">"nginx-1.10.1-1.x86_64.rpm"</span>&#125;</div><div class="line">ll</div><div class="line">-rw-r--r--. 1 root root 2475253 11月 30 20:24 nginx-1.10.1-1.x86_64.rpm</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rpm </tag>
            
            <tag> fpm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell fifo</title>
      <link href="/2017/04/29/shell-fifo/"/>
      <url>/2017/04/29/shell-fifo/</url>
      
        <content type="html"><![CDATA[<h2 id="FIFO"><a href="#FIFO" class="headerlink" title="FIFO"></a>FIFO</h2><p>FIFO中可以很好地解决在无关进程间数据交换的要求，并且由于它们是存在于文件系统中的，这也提供了一种比匿名管道更持久稳定的通信办法。FIFO的通信方式类似于在进程中使用文件来传输数据，只不过FIFO类型文件同时具有管道的特性。在数据读出时，FIFO管道中同时清除数据。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line">SEND_THREAD_NUM=7</div><div class="line">tmp_fifofile=&quot;/tmp/$$.fifo&quot;</div><div class="line">mkfifo -m 600 &quot;$tmp_fifofile&quot;</div><div class="line">exec 6&lt;&gt;&quot;$tmp_fifofile&quot;</div><div class="line"></div><div class="line">for ((i=0;i&lt;$SEND_THREAD_NUM;i++));do</div><div class="line">  echo</div><div class="line">done &gt;&amp;6</div><div class="line"></div><div class="line">for i in `seq 1 100`;do</div><div class="line">  read -u6</div><div class="line"></div><div class="line">  &#123;</div><div class="line">  echo $i</div><div class="line">  sleep 3</div><div class="line">  echo &gt;&amp;6</div><div class="line">  &#125; &amp;</div><div class="line"></div><div class="line">  pid=$!</div><div class="line">  echo $pid</div><div class="line">done</div><div class="line"></div><div class="line">wait</div><div class="line"></div><div class="line">exec 6&gt;&amp;-</div><div class="line"></div><div class="line">exit 0</div></pre></td></tr></table></figure><p>以下为详细注解。<br><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">#设置线程数，在这里所谓的线程，其实就是几乎同时放入后台（使用&amp;）执行的进程。</div><div class="line">SEND_THREAD_NUM=13</div><div class="line"># 脚本运行的当前进程ID号作为文件名，其实这样命名只是为了防止创建管道文件时与现有文件名重复，从而引起创建失败，别无他用。</div><div class="line">tmp_fifofile="/tmp/<span class="formula">$$.fifo"</span></div><div class="line">#创建管道文件,并赋予权限</div><div class="line">mkfifo -m 600 "$tmp_fifofile"</div><div class="line">#把文件描述符6指向管道文件，文件描述符可以使用3-9任意一个即可（除了5），0、1、2、5已有定义，具体可参考关于文件描述符的文章。</div><div class="line">EXEC 6&lt;&gt;"$tmp_fifofile"</div><div class="line">#删除管道文件,其实删不删无所谓，看你自己了。</div><div class="line">rm -f $tmp_fifofile</div><div class="line"></div><div class="line">#使用一个for循环向管道中输入$SEND_THREAD_NUM个空行；&gt;符号为输出重导向；&amp;符号表示6为文件描述符，也就是说&amp;6表示文件描述符6.</div><div class="line">for ((i=0;i&lt;$SEND_THREAD_NUM;i++));do</div><div class="line">  echo</div><div class="line">done &gt;&amp;6</div><div class="line"></div><div class="line">for i in `seq 1 100`;do # 100 次 for 循环开始，也就是说表示100次你的实际应用</div><div class="line">  read -u6 # 从文件描述符6（即管道）中读取行，每次读一行，由于是管道，读一行，管道中便少一行，每次只能读取一行，注意：如果读完了，便会挂起，直到管道中再次有可读的行。</div><div class="line"></div><div class="line">  &#123;</div><div class="line">  echo $i # 打印i,这里代表整个脚本的应用部分，可以替换成你的实际应用。</div><div class="line">  sleep 3 # 暂停3秒，这里是关键点，其实引入管道模拟多线程的关键就是为了这个暂停的3秒（实际上是微大于3秒的），让系统有个缓冲的时间，起到限制所谓并发的进程数量。</div><div class="line">  echo &gt;&amp;6 # 再次往管道文件中写入一个空行，为了挂起的for循环能够继续执行。</div><div class="line">  &#125; &amp; ＃注意这里要放到后台，也就是说echo $i这个你的应用有13个是几乎同时在后台执行的，为什么是13个呢？当for循环完13次后会挂起，因为管道已经空了，read -u6会暂时挂起，直到管道中有了空行。由于本commands block（即&#123;&#125;中的内容）是放在后台执行的，可以理想的看成这13次循环是同时执行的，大家同时sleep了3秒，而又同时向管道中输入了空行，所以管道在读空之后差不多3秒的时候又瞬时多了13次空行，使得read -u6能够继续读行，for循环得以继续执行。</div><div class="line"></div><div class="line">  pid=$! # $!代表在后台执行的最后一个进程。</div><div class="line">  echo $pid #打印最后一个进入后台的子进程id；打印的pid结果印证了非并发，非多线程。</div><div class="line"></div><div class="line">done</div><div class="line"></div><div class="line">wait #等到后台的进程都执行完毕。</div><div class="line"></div><div class="line">exec 6&gt;&amp;- #删除文件描述符6</div></pre></td></tr></table></figure></p><p>出处：<a href="http://findingcc.blog.51cto.com/1045158/287417" target="_blank" rel="external">http://findingcc.blog.51cto.com/1045158/287417</a></p>]]></content>
      
      
      <categories>
          
          <category> shell </category>
          
      </categories>
      
      
        <tags>
            
            <tag> fifo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis</title>
      <link href="/2017/04/19/redis/"/>
      <url>/2017/04/19/redis/</url>
      
        <content type="html"><![CDATA[<p>Redis是一个使用ANSI C编写的开源、支持网络、基于内存、可选持久性的键值对存储数据库。redis 安装过程比较简单，直接编译即可,具体细节可参照以下脚本。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"># Author:  xy &lt;424187951 AT qq.com&gt;</div><div class="line">#update 170419</div><div class="line">export PATH=/bin:/sbin:/usr/bin:/usr/sbin</div><div class="line">log_file=&quot;/tmp/redis_install.log&quot;</div><div class="line">cd /opt/</div><div class="line">function make_install()&#123;</div><div class="line">        yum -y install wget tar gcc</div><div class="line">            wget http://download.redis.io/releases/redis-3.2.8.tar.gz</div><div class="line">                tar xzf redis-3.2.8.tar.gz &amp;&amp; cd redis-3.2.8</div><div class="line">                    make</div><div class="line">#    make -j4 MALLOC=libc</div><div class="line">#You need tcl 8.5 or newer in order to run the Redis test</div><div class="line">    rpm -ivh http://mirror.centos.org/centos/6/os/x86_64/Packages/tcl-8.5.7-6.el6.x86_64.rpm</div><div class="line">&#125;</div><div class="line"></div><div class="line">function redis_conf()&#123;</div><div class="line">        echo &apos;</div><div class="line">        net.core.somaxconn=511</div><div class="line">        vm.overcommit_memory=1&apos; &gt;&gt; /etc/sysctl.conf</div><div class="line">        sysctl -p</div><div class="line">        echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</div><div class="line">        ./src/redis-server &amp;</div><div class="line">        ./src/redis-cli ping &amp;&amp; echo &apos;installation complete&apos;</div><div class="line">&#125;</div><div class="line">make_install &amp;&gt; $log_file</div><div class="line">redis_conf</div></pre></td></tr></table></figure><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">./src/redis-cli</div><div class="line">CONFIG get requirepass</div><div class="line"><span class="comment">## 查看密码</span></div><div class="line"></div><div class="line">CONFIG <span class="built_in">set</span> requirepass <span class="string">"runoob"</span></div><div class="line"><span class="comment">## 设置密码</span></div><div class="line"></div><div class="line">AUTH password</div><div class="line"><span class="comment">## 密码验证</span></div><div class="line"></div><div class="line">CONFIG get *</div><div class="line"><span class="comment">## 显示所有设置</span></div><div class="line"></div><div class="line">CONFIG <span class="built_in">set</span> </div><div class="line"><span class="comment">## 修改配置建议使用此命令进行热修改，因修改配置文件后，redis重启存在内存陷阱</span></div></pre></td></tr></table></figure><h2 id="redis-benchmark"><a href="#redis-benchmark" class="headerlink" title="redis-benchmark"></a>redis-benchmark</h2><p>redis测试工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">redis-benchmark -h 127.0.0.1 -p 6379 -t set,lpush -n 10000 -q</div><div class="line">SET: 97087.38 requests per second</div><div class="line">LPUSH: 106382.98 requests per second</div><div class="line">##主机 127.0.0.1 端口号为 6379，执行的命令为 set,lpush，请求数为 10000，通过 -q 参数让结果只显示每秒执行的请求数。</div></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> db </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>webbench</title>
      <link href="/2017/04/16/webbench/"/>
      <url>/2017/04/16/webbench/</url>
      
        <content type="html"><![CDATA[<h2 id="webbench"><a href="#webbench" class="headerlink" title="webbench"></a>webbench</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apt install ctags</div><div class="line">wget -c http://home.tiscali.cz/~cz210552/distfiles/webbench-1.5.tar.gz</div><div class="line">make</div></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#5000并发测试60秒</span></div><div class="line">shell&gt; ./webbench -c 5000 -t 60 http://192.168.x.y/zabbix/index.php</div><div class="line">Webbench - Simple Web Benchmark 1.5</div><div class="line">Copyright (c) Radim Kolar 1997-2004, GPL Open Source Software.</div><div class="line"></div><div class="line">Benchmarking: GET http://192.168.x.y/zabbix/index.php</div><div class="line">5000 clients, running 60 sec.</div><div class="line"></div><div class="line">Speed=853748 pages/min, 5065571 bytes/sec.</div><div class="line">Requests: 853748 susceed, 0 failed.</div></pre></td></tr></table></figure><p><img src="/2017/04/16/webbench/./pic0.png" alt=""></p><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">webbench [option]... URL</div><div class="line">  -f|--force Don't wait for reply from server.</div><div class="line">  -r|--reload Send reload request - Pragma: no-cache.</div><div class="line">  -t|--time &lt;sec&gt; Run benchmark for &lt;sec&gt; seconds. Default 30.</div><div class="line">  -p|--proxy &lt;server:port&gt; Use proxy server for request.</div><div class="line">  -c|--clients &lt;n&gt; Run &lt;n&gt; HTTP clients at once. Default one.</div><div class="line">  -9|--http09 Use HTTP/0.9 style requests.</div><div class="line">  -1|--http10 Use HTTP/1.0 protocol.</div><div class="line">  -2|--http11 Use HTTP/1.1 protocol.</div><div class="line">  --get Use GET request method.</div><div class="line">  --head Use HEAD request method.</div><div class="line">  --options Use OPTIONS request method.</div><div class="line">  --trace Use TRACE request method.</div><div class="line">  -?|-h|--help This information.</div><div class="line">  -V|--version Display program version.</div></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> dev ops </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ubuntu desktop themes</title>
      <link href="/2017/03/28/ubuntu-desktop-themes/"/>
      <url>/2017/03/28/ubuntu-desktop-themes/</url>
      
        <content type="html"><![CDATA[<h2 id="Install-Themes-amp-Icons"><a href="#Install-Themes-amp-Icons" class="headerlink" title="Install Themes &amp; Icons"></a>Install Themes &amp; Icons</h2><p>sudo add-apt-repository ppa:noobslab/icons<br>sudo add-apt-repository ppa:noobslab/themes<br>sudo apt-get update<br>sudo apt-get install unity-tweak-tool ultra-flat-icons  flatabulous-theme</p><h2 id="Install-unity-tweak-tool"><a href="#Install-unity-tweak-tool" class="headerlink" title="Install unity-tweak-tool"></a>Install unity-tweak-tool</h2><p>theme –&gt; flatabulous<br>icons –&gt; ultra<br><img src="/2017/03/28/ubuntu-desktop-themes/./ud0.png" alt="pic"></p><h2 id="Install-Docky"><a href="#Install-Docky" class="headerlink" title="Install Docky"></a>Install Docky</h2><p>sudo add-apt-repository ppa:docky-core/ppa<br>sudo apt-get update<br>sudo apt-get install docky</p><p>my desktop<br><img src="/2017/03/28/ubuntu-desktop-themes/./ud2.png" alt="pic"></p><h2 id="More-Themes-amp-Icons"><a href="#More-Themes-amp-Icons" class="headerlink" title="More Themes &amp; Icons"></a>More Themes &amp; Icons</h2><p>Desktop Themes:<br><a href="https://www.opendesktop.org/browse/cat/381/ord/top/" target="_blank" rel="external">https://www.opendesktop.org/browse/cat/381/ord/top/</a></p><p>Icon Themes:<br><a href="https://www.opendesktop.org/browse/cat/132/ord/top/" target="_blank" rel="external">https://www.opendesktop.org/browse/cat/132/ord/top/</a></p><p>Cursors:<br><a href="https://www.opendesktop.org/browse/cat/107/ord/top/" target="_blank" rel="external">https://www.opendesktop.org/browse/cat/107/ord/top/</a></p><h4 id="Docky-skin"><a href="#Docky-skin" class="headerlink" title="Docky skin"></a>Docky skin</h4><p>extract:<br>~/.local/share/docky/themes/</p><h4 id="Themes-Icons-amp-Cursors"><a href="#Themes-Icons-amp-Cursors" class="headerlink" title="Themes Icons &amp; Cursors"></a>Themes Icons &amp; Cursors</h4><p>extract:<br>/usr/share/themes<br>/usr/share/icons</p>]]></content>
      
      
      <categories>
          
          <category> linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> themes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2017/03/16/hello-world/"/>
      <url>/2017/03/16/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>About Me</title>
      <link href="/2014/05/28/about-me/"/>
      <url>/2014/05/28/about-me/</url>
      
        <content type="html"><![CDATA[<p>奚佳龍<br>杭州电子科技大学（2014)<br>Blog：<a href="https://xjlxy.github.io">https://xjlxy.github.io</a></p><p>Linux<br><figure class="highlight tex"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">服务器环境部署：</div><div class="line">    nginx、mysql、php、apache、tomcat、ELK、svn、</div><div class="line">    iptalbes、binddns、dhcp、dnsmasq、ftp、samba、bacula…</div><div class="line"></div><div class="line">监控：</div><div class="line">    zabbix、nagios、mysql slow query、grafana、cacti、nethogs、ntop…</div><div class="line"></div><div class="line">自动化脚本：</div><div class="line">    部署：</div><div class="line">        lamp、tomcat、redis、vpn、nfs…</div><div class="line">    备份:</div><div class="line">        mysql、rsync、xtrabackup、unsion…</div><div class="line">    监控：</div><div class="line">        zabbix：自动发现TCP端口、TCP连接数、主机ip、监控数据量</div><div class="line">        磁盘空间超过预设值自动清理…</div><div class="line">    其他：</div><div class="line">       ssh伪多线程批量部署、 ssh防暴力破解…</div><div class="line"></div><div class="line">负载均衡：</div><div class="line">    keepalived、LVS、varnish、mysql master--slave…</div><div class="line"></div><div class="line">性能调优：</div><div class="line">    ionice、webbench…</div></pre></td></tr></table></figure></p>]]></content>
      
      
      
        <tags>
            
            <tag> xy </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
